/**
 * jquery.Jcrop.js v0.9.9
 * jQuery Image Cropping Plugin
 * @author Kelly Hallman <khallman@gmail.com>
 * Copyright (c) 2008-2011 Kelly Hallman - released under MIT License {{{
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 *
 * }}}
 */
/*global $, jQuery */
(function(){"use strict";$.Jcrop=function(t,K){function l(a){return parseInt(a,10)+"px"}function L(a){a=$(a).offset();return[a.left,a.top]}function B(a){return[a.pageX-Q[0],a.pageY-Q[1]]}function G(a){"object"!==typeof a&&(a={});b=$.extend(b,a);"function"!==typeof b.onChange&&(b.onChange=function(){});"function"!==typeof b.onSelect&&(b.onSelect=function(){});"function"!==typeof b.onRelease&&(b.onRelease=function(){})}function qa(a,e){Q=L(i);A.setCursor("move"===a?a:a+"-resize");if("move"===a)return A.activateHandlers(Na(e),
fa);var b=o.getFixed(),c=ra(a),d=o.getCorner(ra(c));o.setPressed(o.getCorner(c));o.setCurrent(d);A.activateHandlers(Oa(a,b),fa)}function Oa(a,e){return function(u){if(b.aspectRatio)switch(a){case "e":u[1]=e.y+1;break;case "w":u[1]=e.y+1;break;case "n":u[0]=e.x+1;break;case "s":u[0]=e.x+1}else switch(a){case "e":u[1]=e.y2;break;case "w":u[1]=e.y2;break;case "n":u[0]=e.x2;break;case "s":u[0]=e.x2}o.setCurrent(u);g.update()}}function Na(a){var e=a;Y.watchKeys();return function(a){o.moveOffset([a[0]-
e[0],a[1]-e[1]]);e=a;g.update()}}function ra(a){switch(a){case "n":return"sw";case "s":return"nw";case "e":return"nw";case "w":return"ne";case "ne":return"sw";case "nw":return"se";case "se":return"nw";case "sw":return"ne"}}function sa(a){return function(e){if(b.disabled||"move"===a&&!b.allowMove)return!1;M=!0;qa(a,B(e));e.stopPropagation();e.preventDefault();return!1}}function ta(a,e,b){var c=a.width(),d=a.height();c>e&&0<e&&(c=e,d=e/a.width()*a.height());d>b&&0<b&&(d=b,c=b/a.height()*a.width());
s=a.width()/c;v=a.height()/d;a.width(c).height(d)}function ga(a){return{x:parseInt(a.x*s,10),y:parseInt(a.y*v,10),x2:parseInt(a.x2*s,10),y2:parseInt(a.y2*v,10),w:parseInt(a.w*s,10),h:parseInt(a.h*v,10)}}function fa(){var a=o.getFixed();a.w>b.minSelect[0]&&a.h>b.minSelect[1]?(g.enableHandles(),g.done()):g.release();A.setCursor(b.allowSelect?"crosshair":"default")}function ua(a){if(b.disabled||!b.allowSelect)return!1;M=!0;Q=L(i);g.disableHandles();"crosshair"!==va&&(A.setCursor("crosshair"),va="crosshair");
var e=B(a);o.setPressed(e);g.update();A.activateHandlers(Pa,fa);Y.watchKeys();a.stopPropagation();a.preventDefault();return!1}function Pa(a){o.setCurrent(a);g.update()}function wa(){var a=$("<div></div>").addClass(b.baseClass+"-tracker");$.browser.msie&&a.css({opacity:0,backgroundColor:"white"});return a}function xa(a){ya([parseInt(a[0],10)/s,parseInt(a[1],10)/v,parseInt(a[2],10)/s,parseInt(a[3],10)/v])}function ya(a){o.setPressed([a[0],a[1]]);o.setCurrent([a[2],a[3]]);g.update()}function za(){b.disabled=
!0;g.disableHandles();g.setCursor("default");A.setCursor("default")}function Aa(){b.disabled=!1;ha()}function ha(a){b.allowResize?a?g.enableOnly():g.enableHandles():g.disableHandles();A.setCursor(b.allowSelect?"crosshair":"default");g.setCursor(b.allowMove?"move":"default");b.hasOwnProperty("setSelect")&&(xa(b.setSelect),g.done(),delete b.setSelect);b.hasOwnProperty("trueSize")&&(s=b.trueSize[0]/p,v=b.trueSize[1]/m);b.hasOwnProperty("bgColor")&&($.fx.step.hasOwnProperty("backgroundColor")&&b.fadeTime?
C.animate({backgroundColor:b.bgColor},{queue:!1,duration:b.fadeTime}):C.css("backgroundColor",b.bgColor),delete b.bgColor);b.hasOwnProperty("bgOpacity")&&(Z=b.bgOpacity,g.isAwake()&&(b.fadeTime?i.fadeTo(b.fadeTime,Z):C.css("opacity",b.opacity)),delete b.bgOpacity);R=b.maxSize[0]||0;S=b.maxSize[1]||0;T=b.minSize[0]||0;U=b.minSize[1]||0;b.hasOwnProperty("outerImage")&&(i.attr("src",b.outerImage),delete b.outerImage);g.refresh()}var b=$.extend({},$.Jcrop.defaults),Q,va,ia=!1;$.browser.msie&&"6"===$.browser.version.split(".")[0]&&
(ia=!0);"object"!==typeof t&&(t=$(t)[0]);"object"!==typeof K&&(K={});G(K);var q={border:"none",margin:0,padding:0,position:"absolute"},H=$(t),i=H.clone().removeAttr("id").css(q);i.width(H.width());i.height(H.height());H.after(i).hide();ta(i,b.boxWidth,b.boxHeight);var p=i.width(),m=i.height(),C=$("<div />").width(p).height(m).addClass(b.baseClass+"-holder").css({position:"relative",backgroundColor:b.bgColor}).insertAfter(H).append(i);delete b.bgColor;b.addClass&&C.addClass(b.addClass);var aa=$("<img />").attr("src",
i.attr("src")).css(q).width(p).height(m),ja=$("<div />").width("100%").height("100%").css({zIndex:310,position:"absolute",overflow:"hidden"}).append(aa),N=$("<div />").width("100%").height("100%").css("zIndex",320),O=$("<div />").css({position:"absolute",zIndex:300}).insertBefore(i).append(ja,N);ia&&O.css({overflowY:"hidden"});var P=b.boundary,I=wa().width(p+2*P).height(m+2*P).css({position:"absolute",top:l(-P),left:l(-P),zIndex:290}).mousedown(ua),Z=b.bgOpacity,R,S,T,U,s,v,M,Qa;Q=L(i);var D,q=function(){var a=
{},e=["touchstart","touchmove","touchend"],b=document.createElement("div"),c;try{for(c=0;c<e.length;c++){var d=e[c],d="on"+d,j=d in b;j||(b.setAttribute(d,"return;"),j="function"==typeof b[d]);a[e[c]]=j}return a.touchstart&&a.touchend&&a.touchmove}catch(f){return!1}},z;z=!0===b.touchSupport||!1===b.touchSupport?b.touchSupport:q();D={createDragger:function(a){return function(e){e.pageX=e.originalEvent.changedTouches[0].pageX;e.pageY=e.originalEvent.changedTouches[0].pageY;if(b.disabled||"move"===a&&
!b.allowMove)return!1;M=!0;qa(a,B(e));e.stopPropagation();e.preventDefault();return!1}},newSelection:function(a){a.pageX=a.originalEvent.changedTouches[0].pageX;a.pageY=a.originalEvent.changedTouches[0].pageY;return ua(a)},isSupported:q,support:z};var o,Ca=function(){if(!b.aspectRatio){var a=n-c,e=k-d;R&&Math.abs(a)>R&&(n=0<a?c+R:c-R);S&&Math.abs(e)>S&&(k=0<e?d+S:d-S);U/v&&Math.abs(e)<U/v&&(k=0<e?d+U/v:d-U/v);T/s&&Math.abs(a)<T/s&&(n=0<a?c+T/s:c-T/s);0>c&&(n-=c,c-=c);0>d&&(k-=d,d-=d);0>n&&(c-=n,n-=
n);0>k&&(d-=k,k-=k);n>p&&(a=n-p,c-=a,n-=a);k>m&&(a=k-m,d-=a,k-=a);c>p&&(a=c-m,k-=a,d-=a);d>m&&(a=d-m,k-=a,d-=a);return Ba(ka(c,d,n,k))}var a=b.aspectRatio,e=b.minSize[0]/s,u=b.maxSize[0]/s,g=n-c,i=k-d,j=Math.abs(g),f=Math.abs(i);0===u&&(u=10*p);j/f<a?(j=k,w=f*a,f=0>g?c-w:w+c,0>f?(f=0,h=Math.abs((f-c)/a),j=0>i?d-h:h+d):f>p&&(f=p,h=Math.abs((f-c)/a),j=0>i?d-h:h+d)):(f=n,h=j/a,j=0>i?d-h:d+h,0>j?(j=0,w=Math.abs((j-d)*a),f=0>g?c-w:w+c):j>m&&(j=m,w=Math.abs(j-d)*a,f=0>g?c-w:w+c));f>c?(f-c<e?f=c+e:f-c>u&&
(f=c+u),j=j>d?d+(f-c)/a:d-(f-c)/a):f<c&&(c-f<e?f=c-e:c-f>u&&(f=c-u),j=j>d?d+(c-f)/a:d-(c-f)/a);0>f?(c-=f,f=0):f>p&&(c-=f-p,f=p);0>j?(d-=j,j=0):j>m&&(d-=j-m,j=m);return Ba(ka(c,d,f,j))},Da=function(a){0>a[0]&&(a[0]=0);0>a[1]&&(a[1]=0);a[0]>p&&(a[0]=p);a[1]>m&&(a[1]=m);return[a[0],a[1]]},ka=function(a,e,b,c){var d=a,j=b,f=e,g=c;b<a&&(d=b,j=a);c<e&&(f=c,g=e);return[Math.round(d),Math.round(f),Math.round(j),Math.round(g)]},Ba=function(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-a[1]}},
c=0,d=0,n=0,k=0,Ea,Fa;o={flipCoords:ka,setPressed:function(a){a=Da(a);n=c=a[0];k=d=a[1]},setCurrent:function(a){a=Da(a);Ea=a[0]-n;Fa=a[1]-k;n=a[0];k=a[1]},getOffset:function(){return[Ea,Fa]},moveOffset:function(a){var b=a[0],a=a[1];0>c+b&&(b-=b+c);0>d+a&&(a-=a+d);m<k+a&&(a+=m-(k+a));p<n+b&&(b+=p-(n+b));c+=b;n+=b;d+=a;k+=a},getCorner:function(a){var b=Ca();switch(a){case "ne":return[b.x2,b.y];case "nw":return[b.x,b.y];case "se":return[b.x2,b.y2];case "sw":return[b.x,b.y2]}},getFixed:Ca};var g,q=function(a){a=
$("<div />").css({position:"absolute",opacity:b.borderOpacity}).addClass(b.baseClass+"-"+a);ja.append(a);return a},Ga=function(a,b){var c=$("<div />").mousedown(sa(a)).css({cursor:a+"-resize",position:"absolute",zIndex:b});D.support&&c.bind("touchstart",D.createDragger(a));N.append(c);return c};z=function(a){var e=b.handleSize,c=e,d=E,g=E;switch(a){case "n":case "s":e="100%";break;case "e":case "w":c="100%"}return Ga(a,Ha++).width(e).height(c).css({top:l(-d+1),left:l(-g+1)})};var ba=function(a){var e;
for(e=0;e<a.length;e++)r[a[e]]=Ga(a[e],Ha++).css({top:l(-E+1),left:l(-E+1),opacity:b.handleOpacity}).addClass(b.baseClass+"-handle")},la=function(a){var b=Math.round(a.h/2-E),c=Math.round(a.w/2-E),d=a.w-E,a=a.h-E;r.e&&(r.e.css({top:l(b),left:l(d)}),r.w.css({top:l(b)}),r.s.css({top:l(a),left:l(c)}),r.n.css({left:l(c)}));r.ne&&(r.ne.css({left:l(d)}),r.se.css({top:l(a),left:l(d)}),r.sw.css({top:l(a)}));r.b&&(r.b.css({top:l(a)}),r.r.css({left:l(d)}))},Ja=function(){var a=o.getFixed();o.setPressed([a.x,
a.y]);o.setCurrent([a.x2,a.y2]);Ia()},Ia=function(){if(V)return Ka()},Ka=function(){var a=o.getFixed(),e=a.h;O.width(a.w).height(e);var e=a.x,c=a.y;aa.css({top:l(-c),left:l(-e)});O.css({top:l(c),left:l(e)});W&&la(a);V||(O.show(),b.bgFade?i.fadeTo(b.fadeTime,Z):i.css("opacity",Z),V=!0);b.onChange.call(J,ga(a))},La=function(){W=!0;if(b.allowResize)return la(o.getFixed()),N.show(),!0},ca=function(){W=!1;N.hide()},Ma=function(a){void 0===a?ca():La()},V,Ha=370,r={},W=!1,E=b.handleOffset;b.drawBorders&&
(q("hline"),q("hline bottom"),q("vline"),q("vline right"));b.dragEdges&&(r.t=z("n"),r.b=z("s"),r.r=z("e"),r.l=z("w"));b.sideHandles&&ba(["n","s","e","w"]);b.cornerHandles&&ba(["sw","nw","ne","se"]);var ma=wa().mousedown(sa("move")).css({cursor:"move",position:"absolute",zIndex:360});D.support&&ma.bind("touchstart.jcrop",D.createDragger("move"));ja.append(ma);ca();g={updateVisible:Ia,update:Ka,release:function(){ca();O.hide();b.bgFade?i.fadeTo(b.fadeTime,1):i.css("opacity",1);V=false;b.onRelease.call(J)},
refresh:Ja,isAwake:function(){return V},setCursor:function(a){ma.css("cursor",a)},enableHandles:La,enableOnly:function(){W=true},showHandles:function(){if(W){la(o.getFixed());N.show()}},disableHandles:ca,animMode:Ma,done:function(){Ma(false);Ja()}};var A,da=function(a){na(B(a));return false},X=function(a){a.preventDefault();a.stopPropagation();if(M){M=false;oa(B(a));g.isAwake()&&b.onSelect.call(J,ga(o.getFixed()));I.css({zIndex:290});pa&&$(document).unbind("mousemove",da).unbind("mouseup",X);na=function(){};
oa=function(){}}return false},q=function(a){a.pageX=a.originalEvent.changedTouches[0].pageX;a.pageY=a.originalEvent.changedTouches[0].pageY;return da(a)};z=function(a){a.pageX=a.originalEvent.changedTouches[0].pageX;a.pageY=a.originalEvent.changedTouches[0].pageY;return X(a)};var na=function(){},oa=function(){},pa=b.trackDocument;D.support&&$(document).bind("touchmove",q).bind("touchend",z);pa||I.mousemove(da).mouseup(X).mouseout(X);i.before(I);A={activateHandlers:function(a,b){M=true;na=a;oa=b;I.css({zIndex:450});
pa&&$(document).bind("mousemove",da).bind("mouseup",X);return false},setCursor:function(a){I.css("cursor",a)}};var Y,q=function(){F.hide()},ea=function(a,c,d){if(b.allowMove){o.moveOffset([c,d]);g.updateVisible()}a.preventDefault();a.stopPropagation()};z=function(a){if(a.ctrlKey)return true;var b=(Qa=a.shiftKey?true:false)?10:1;switch(a.keyCode){case 37:ea(a,-b,0);break;case 39:ea(a,b,0);break;case 38:ea(a,0,-b);break;case 40:ea(a,0,b);break;case 27:g.release();break;case 9:return true}return false};
var F=$('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}),ba=$("<div />").css({position:"absolute",overflow:"hidden"}).append(F);b.keySupport&&(F.keydown(z).blur(q),ia||!b.fixedSupport?(F.css({position:"absolute",left:"-20px"}),ba.append(F).insertBefore(i)):F.insertBefore(i));Y={watchKeys:function(){if(b.keySupport){F.show();F.focus()}}};D.support&&I.bind("touchstart",D.newSelection);N.hide();ha(!0);var J={setImage:function(a,c){g.release();za();var d=new Image;d.onload=
function(){var g=d.height,k=b.boxWidth,j=b.boxHeight;i.width(d.width).height(g);i.attr("src",a);aa.attr("src",a);ta(i,k,j);p=i.width();m=i.height();aa.width(p).height(m);I.width(p+P*2).height(m+P*2);C.width(p).height(m);Aa();typeof c==="function"&&c.call(J)};d.src=a},animateTo:function(a,c){var d=parseInt(a[0],10)/s,i=parseInt(a[1],10)/v,k=parseInt(a[2],10)/s,j=parseInt(a[3],10)/v,d=o.flipCoords(d,i,k,j),i=o.getFixed(),f=[i.x,i.y,i.x2,i.y2],l=b.animationDelay,m=d[0]-f[0],n=d[1]-f[1],p=d[2]-f[2],r=
d[3]-f[3],q=0,z=b.swingSpeed;x=f[0];y=f[1];k=f[2];j=f[3];g.animMode(true);var t=function(){q=q+(100-q)/z;f[0]=x+q/100*m;f[1]=y+q/100*n;f[2]=k+q/100*p;f[3]=j+q/100*r;q>=99.8&&(q=100);if(q<100){ya(f);window.setTimeout(t,l)}else{g.done();typeof c==="function"&&c.call(J)}};window.setTimeout(t,l)},setSelect:xa,setOptions:function(a){G(a);ha()},tellSelect:function(){return ga(o.getFixed())},tellScaled:function(){return o.getFixed()},setClass:function(a){C.removeClass().addClass(b.baseClass+"-holder").addClass(a)},
disable:za,enable:Aa,cancel:function(){g.done();A.activateHandlers(null,null)},release:g.release,destroy:function(){C.remove();H.show();$(t).removeData("Jcrop")},focus:Y.watchKeys,getBounds:function(){return[p*s,m*v]},getWidgetSize:function(){return[p,m]},getScaleFactor:function(){return[s,v]},ui:{holder:C,selection:O}};$.browser.msie&&C.bind("selectstart",function(){return false});H.data("Jcrop",J);return J};$.fn.Jcrop=function(t,K){this.each(function(){if($(this).data("Jcrop")){if("api"===t)return $(this).data("Jcrop");
$(this).data("Jcrop").setOptions(t)}else{var l=this,L="object"===typeof t?t:{},B=L.useImg||l.src,G=new Image;G.onload=function(){function t(){if(!G.width||!G.height)window.setTimeout(t,50);else{var B=$.Jcrop(l,L);"function"===typeof K&&K.call(B)}}window.setTimeout(t,50)};G.src=B}});return this};$.Jcrop.defaults={allowSelect:!0,allowMove:!0,allowResize:!0,trackDocument:!0,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:0.6,bgFade:!1,borderOpacity:0.4,handleOpacity:0.5,handleSize:9,handleOffset:5,
aspectRatio:0,keySupport:!0,cornerHandles:!0,sideHandles:!0,drawBorders:!0,dragEdges:!0,fixedSupport:!0,touchSupport:null,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onRelease:function(){}}})(jQuery);