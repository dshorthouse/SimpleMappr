/*
 * jQuery SimpleMapprAdmin
 */
var SimpleMapprAdmin=function(a,e,h){'use strict';var g={citations_list:a("#admin-citations-list"),init:function(){this.loadUserList();this.bindTools();this.loadCitationList();this.bindCreateCitation();SimpleMappr.tabSelector(4)},loadUserList:function(b){var c=this;b=b||{};var d={locale:SimpleMappr.getParameterByName("locale")};SimpleMappr.showSpinner();b.sort&&(d.sort=b.sort.item,d.dir=b.sort.dir);d.locale||delete d.locale;a.ajax({type:"GET",url:SimpleMappr.settings.baseUrl+"/user/",data:d,dataType:"html",success:function(b){-1!==
b.indexOf("access denied")?e.location.reload():(a("#userdata").off().html(b).on("click","a.toolsRefresh",function(a){a.preventDefault();c.loadUserList()}).on("click","a.ui-icon-triangle-sort",function(b){b.preventDefault();d.sort={item:a(this).attr("data-sort"),dir:"asc"};a(this).hasClass("asc")&&(d.sort.dir="desc");c.loadUserList(d)}).on("click","a.user-delete",function(a){a.preventDefault();c.deleteUserConfirmation(this)}).on("click","a.user-load",function(b){b.preventDefault();SimpleMappr.loadMapList({uid:a(this).attr("data-uid")});
SimpleMappr.tabSelector(3)}),SimpleMappr.hideSpinner())}})},bindTools:function(){var b=this;a("#map-admin").on("click","a.admin-tool",function(c){c.preventDefault();SimpleMappr.showSpinner();a(this).has("#flush-caches")&&b.flushCaches()})},flushCaches:function(){a.ajax({type:"GET",url:SimpleMappr.settings.baseUrl+"/flush_cache/",dataType:"json",success:function(a){!0===a.files&&(SimpleMappr.hideSpinner(),alert("Caches flushed"),e.location.reload())},error:function(){SimpleMappr.hideSpinner();alert("Error flushing caches")}})},
loadCitationList:function(){var b=this,c="",d="",e="";SimpleMappr.showSpinner();a.ajax({type:"GET",url:SimpleMappr.settings.baseUrl+"/citation/",dataType:"json",timeout:3E4,success:function(f){"ok"===f.status&&(a.each(f.citations,function(){d=this.doi?' doi:<a href="http://doi.org/'+this.doi+'">'+this.doi+"</a>.":"";e=this.link?' (<a href="'+this.link+'">link</a>)':"";c+='<p class="citation">'+this.reference+e+d+'<a class="sprites-before citation-delete" data-id="'+this.id+'" href="#">Delete</a></p>'}),
b.citations_list.html(c),b.bindDeleteCitations(),SimpleMappr.hideSpinner())},error:function(){alert("Error loading citations");SimpleMappr.hideSpinner()}})},bindDeleteCitations:function(){var a=this;this.citations_list.on("click","a.citation-delete",function(c){c.preventDefault();a.deleteCitationConfirmation(this)})},bindCreateCitation:function(){var b=this;a("#map-admin").on("click","button.addmore",function(c){c.preventDefault();""!==a("#citation-reference").val()&&""!==a("#citation-surname").val()&&
""!==a("#citation-year").val()?(SimpleMappr.showSpinner(),a.ajax({type:"POST",url:SimpleMappr.settings.baseUrl+"/citation/",data:a("form").serialize(),dataType:"json",success:function(c){"ok"===c.status&&(a("#map-admin").find(".citation").val(""),a.each(["reference","surname","year"],function(){a("#citation-"+this).removeClass("ui-state-error")}),b.loadCitationList(),SimpleMappr.hideSpinner())}})):a.each(["reference","surname","year"],function(){a("#citation-"+this).addClass("ui-state-error")})})},
deleteUserConfirmation:function(b){var c=this,d=a(b).attr("data-id");b="<em>"+a(b).parent().parent().children("td:first").text()+"</em>";a("#mapper-message-delete").find("span").html(b).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles").find("span.delete").text(),"class":"negative",click:function(){SimpleMappr.showSpinner();a.ajax({type:"DELETE",url:SimpleMappr.settings.baseUrl+
"/user/"+d,success:function(){c.loadUserList();SimpleMappr.hideSpinner();SimpleMappr.trackEvent("user","delete")}});a(this).dialog("destroy")}},{text:a("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]}).show()},deleteCitationConfirmation:function(b){var c=this,d=a(b).attr("data-id");b=":<br><br>"+a(b).parent().text().replace("Delete","");a("#mapper-message-delete").find("span").html(b).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",
modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles").find("span.delete").text(),"class":"negative",click:function(){SimpleMappr.showSpinner();a.ajax({type:"DELETE",url:SimpleMappr.settings.baseUrl+"/citation/"+d,success:function(){SimpleMappr.hideSpinner();c.loadCitationList()}});a(this).dialog("destroy")}},{text:a("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]}).show()}};return{init:function(){g.init()}}}(jQuery,
window,document);
