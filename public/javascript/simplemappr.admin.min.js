/*
 * jQuery SimpleMapprAdmin
 */
/*global jQuery, window, document, self, XMLHttpRequest, alert, encodeURIComponent, _gaq */
var SimpleMapprAdmin=function(a,e,h){'use strict';var g={init:function(){this.loadUserList();this.bindTools();this.loadCitationList();this.bindCreateCitation();SimpleMappr.tabSelector(4)},loadUserList:function(b){var d=this;b=b||{};var c={locale:SimpleMappr.getParameterByName("locale")};SimpleMappr.showSpinner();b.sort&&(c.sort=b.sort.item,c.dir=b.sort.dir);c.locale||delete c.locale;a.ajax({type:"GET",url:SimpleMappr.settings.baseUrl+"/user/",data:c,dataType:"html",success:function(b){-1!==b.indexOf("access denied")?
e.location.reload():(a("#userdata").off().html(b).on("click","a.toolsRefresh",function(a){a.preventDefault();d.loadUserList()}).on("click","a.ui-icon-triangle-sort",function(b){b.preventDefault();c.sort={item:a(this).attr("data-sort"),dir:"asc"};a(this).hasClass("asc")&&(c.sort.dir="desc");d.loadUserList(c)}).on("click","a.user-delete",function(a){a.preventDefault();d.deleteUserConfirmation(this)}).on("click","a.user-load",function(b){b.preventDefault();SimpleMappr.loadMapList({uid:a(this).attr("data-uid")});
SimpleMappr.tabSelector(3)}),SimpleMappr.hideSpinner())}})},bindTools:function(){var b=this;a("#map-admin").on("click","a.admin-tool",function(d){d.preventDefault();SimpleMappr.showSpinner();a(this).has("#flush-caches")&&b.flushCaches()})},flushCaches:function(){a.ajax({type:"GET",url:SimpleMappr.settings.baseUrl+"/flush_cache/",dataType:"json",success:function(a){"ok"===a.status&&(alert("Caches flushed"),SimpleMappr.hideSpinner(),e.location.reload())},error:function(){alert("Error flushing caches");
SimpleMappr.hideSpinner()}})},loadCitationList:function(){var b=this,d="",c="",f="";SimpleMappr.showSpinner();a.ajax({type:"GET",url:SimpleMappr.settings.baseUrl+"/citation/",dataType:"json",timeout:3E4,success:function(e){"ok"===e.status&&(a.each(e.citations,function(){c=this.doi?' doi:<a href="http://doi.org/'+this.doi+'">'+this.doi+"</a>.":"";f=this.link?' (<a href="'+this.link+'">link</a>)':"";d+='<p class="citation">'+this.reference+f+c+'<a class="sprites-before citation-delete" data-id="'+this.id+
'" href="#">Delete</a></p>'}),a("#admin-citations-list").html(d),b.bindDeleteCitations(),SimpleMappr.hideSpinner())},error:function(){alert("Error loading citations");SimpleMappr.hideSpinner()}})},bindDeleteCitations:function(){var b=this;a("#admin-citations-list").on("click","a.citation-delete",function(a){a.preventDefault();b.deleteCitationConfirmation(this)})},bindCreateCitation:function(){var b=this,d=a("#admin-citations-list");a("#map-admin").on("click","button.addmore",function(c){c.preventDefault();
""!=a("#citation-reference").val()&&""!=a("#citation-surname").val()&&""!=a("#citation-year").val()?(SimpleMappr.showSpinner(),d.addClass("ui-widget-overlay"),a.ajax({type:"POST",url:SimpleMappr.settings.baseUrl+"/citation/",data:a("form").serialize(),dataType:"json",success:function(c){"ok"===c.status&&(a("#map-admin").find(".citation").val(""),a.each(["reference","surname","year"],function(){a("#citation-"+this).removeClass("ui-state-error")}),b.loadCitationList(),d.removeClass("ui-widget-overlay"),
SimpleMappr.hideSpinner())}})):a.each(["reference","surname","year"],function(){a("#citation-"+this).addClass("ui-state-error")})})},deleteUserConfirmation:function(b){var d=this,c=a(b).attr("data-id");b="<em>"+a(b).parent().parent().children("td:first").text()+"</em>";a("#mapper-message-delete").find("span").html(b).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles").find("span.delete").text(),
"class":"negative",click:function(){SimpleMappr.showSpinner();a.ajax({type:"DELETE",url:SimpleMappr.settings.baseUrl+"/user/"+c,success:function(){d.loadUserList();SimpleMappr.hideSpinner();SimpleMappr.trackEvent("user","delete")}});a(this).dialog("destroy")}},{text:a("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]}).show()},deleteCitationConfirmation:function(b){var d=this,c=a(b).attr("data-id");b=":<br><br>"+a(b).parent().text().replace("Delete",
"");a("#mapper-message-delete").find("span").html(b).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles").find("span.delete").text(),"class":"negative",click:function(){SimpleMappr.showSpinner();a.ajax({type:"DELETE",url:SimpleMappr.settings.baseUrl+"/citation/"+c,success:function(){SimpleMappr.hideSpinner();d.loadCitationList()}});a(this).dialog("destroy")}},{text:a("#button-titles").find("span.cancel").text(),
"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]}).show()}};return{init:function(){g.init()}}}(jQuery,window,document);
