/*
 * jQuery SimpleMappr
 */
var SimpleMappr=function(a,k,h){'use strict';var q={settings:{baseUrl:"",active:!1,maxTextareaCount:10,undoSize:10},vars:{newPointCount:0,newRegionCount:0,zoom:!0,fileDownloadTimer:{},fillColor:"",jCropType:"zoom",cropUpdated:!1,origins:{"esri:102009":-96,"esri:102015":-60,"esri:102014":10,"esri:102012":105,"esri:102024":25,"epsg:3112":134},spinner:a("#map-loader").find("span.mapper-loading-spinner")},trackEvent:function(b,a){void 0!==k._gaq&&_gaq.push(["_trackEvent",b,a])},getPageSize:function(){var b,a,d,e;
k.innerHeight&&k.scrollMaxY?(b=k.innerWidth+k.scrollMaxX,a=k.innerHeight+k.scrollMaxY):h.body.scrollHeight>h.body.offsetHeight?(b=h.body.scrollWidth,a=h.body.scrollHeight):(b=h.body.offsetWidth,a=h.body.offsetHeight);self.innerHeight?(d=h.documentElement.clientWidth?h.documentElement.clientWidth:self.innerWidth,e=self.innerHeight):h.documentElement&&h.documentElement.clientHeight?(d=h.documentElement.clientWidth,e=h.documentElement.clientHeight):h.body&&(d=h.body.clientWidth,e=h.body.clientHeight);
return[b<d?b:d,a<e?e:a,d,e]},getPageScroll:function(){var b,a;self.pageYOffset?(a=self.pageYOffset,b=self.pageXOffset):h.documentElement&&h.documentElement.scrollTop?(a=h.documentElement.scrollTop,b=h.documentElement.scrollLeft):h.body&&(a=h.body.scrollTop,b=h.body.scrollLeft);return[b,a]},showCoords:function(b){var c=this,d=parseFloat(b.x),e=parseFloat(b.y),f=parseFloat(b.x2),g=parseFloat(b.y2),l=parseFloat(b.w);b=parseFloat(b.h);var h={x:d,y:e},p={x:f,y:g},k={},m={},r=a("#mapExport").find('input[name="download-factor"]:checked').val(),
n=a("#mapOutput");switch(this.vars.jCropType){case "crop":n.find("div.jcrop-holder div:first").css({backgroundColor:"white"});a("#bbox_rubberband").val(d+","+e+","+f+","+g);"epsg:4326"===a("#projection option:selected").val()?n.find("input.jcrop-coord").css({width:"100px"}):n.find("input.jcrop-coord").css({width:"175px"});0===a("#jcrop-coord-ul").length&&0===a("#jcrop-coord-lr").length&&n.find("div.jcrop-tracker").eq(0).after('<input type="text" id="jcrop-coord-ul" class="jcrop-coord"></input>').after('<input type="text" id="jcrop-coord-lr" class="jcrop-coord"></input>').after('<div id="jcrop-dimension-wrapper"><input type="text" id="jcrop-dimension-w" class="jcrop-dimension"></input>X<input type="text" id="jcrop-dimension-h" class="jcrop-dimension"></input></div>');
k=c.pix2geo(h);m=c.pix2geo(p);a("#jcrop-coord-ul").val(k.x+", "+k.y);a("#jcrop-coord-lr").val(m.x+", "+m.y);a("#jcrop-dimension-w").val(l);a("#jcrop-dimension-h").val(b);a("#jcrop-dimension-wrapper").css({left:l/2-a("#jcrop-dimension-wrapper").width()/2,top:b/2-a("#jcrop-dimension-wrapper").height()/2});a.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+a("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+a("#jcrop-coord-lr").val()+'" }');n.on("blur","input.jcrop-coord",function(){c.vars.cropUpdated||
(c.vars.cropUpdated=c.updateCropCoordinates())}).on("keypress","input.jcrop-coord",function(b){var a=b.keyCode||b.which;if(13===a||9===a)b.preventDefault(),c.vars.cropUpdated=!1,this.blur()}).on("blur","input.jcrop-dimension",function(){c.vars.cropUpdated||(c.vars.cropUpdated=c.updateCropDimensions())}).on("keypress","input.jcrop-dimension",function(b){var a=b.keyCode||b.which;if(13===a||9===a)b.preventDefault(),c.vars.cropUpdated=!1,this.blur()});a("#scale-measure").find("span").text(r*l+" X "+r*
b).parent().show();break;case "zoom":n.find("div.jcrop-holder div:first").css({backgroundColor:"white"});a("#bbox_rubberband").val(d+","+e+","+f+","+g);break;case "query":a("#bbox_query").val(d+","+e+","+f+","+g)}},updateCropDimensions:function(){var b=a("#bbox_rubberband").val().split(","),c=parseFloat(b[2])-parseFloat(b[0]),d=parseFloat(b[3])-parseFloat(b[1]),e=a("#mapOutputImage").width(),f=a("#mapOutputImage").height(),g=a("#jcrop-dimension-w").val(),l=a("#jcrop-dimension-h").val(),h=b[0],p=b[2],
k=b[1],m=b[3],g=g>e?e:(c-g)/2,l=l>f?f:(d-l)/2,h=parseFloat(b[2])-g,p=parseFloat(b[0])+g,k=parseFloat(b[1])+l,m=parseFloat(b[3])-l;g>=e&&(h=0,p=e);l>=f&&(k=0,m=f);this.loadCropSettings({map:{bbox_rubberband:h.toString()+","+k.toString()+","+p.toString()+","+m.toString()}});return!0},updateCropCoordinates:function(){var b=a("#jcrop-coord-ul").val(),c=b.split(","),c=this.geo2pix({x:a.trim(c[0]),y:a.trim(c[1])}),d=a("#jcrop-coord-lr").val(),e=d.split(","),e=this.geo2pix({x:a.trim(e[0]),y:a.trim(e[1])});
a.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+b+'", "jcrop_coord_lr" : "'+d+'" }');this.loadCropSettings({map:{bbox_rubberband:e.x+","+e.y+","+c.x+","+c.y}});return!0},pix2geo:function(b){var c=0,d=0,e=a("#bbox_map").val(),f=parseFloat(a("#mapOutputImage").width()),g=parseFloat(a("#mapOutputImage").height()),l={};""===e&&(e="-180,-90,180,90");e=e.split(",");c=Math.abs(parseFloat(a.trim(e[2]))-parseFloat(a.trim(e[0])));d=Math.abs(parseFloat(a.trim(e[3]))-parseFloat(a.trim(e[1])));l.x=this.roundNumber(parseFloat(e[0])+
parseFloat(b.x)*c/f,2);l.y=this.roundNumber(parseFloat(e[1])+parseFloat(g-parseFloat(b.y))*d/g,2);return l},geo2pix:function(b){var c=0,d=0,e=a("#bbox_map").val(),f={};""===e&&(e="-180,-90,180,90");e=e.split(",");c=Math.abs(parseFloat(a.trim(e[2]))-parseFloat(a.trim(e[0])));d=Math.abs(parseFloat(a.trim(e[3]))-parseFloat(a.trim(e[1])));f.x=a("#mapOutputImage").width()*Math.abs(parseFloat(b.x)-parseFloat(a.trim(e[0])))/c;f.y=a("#mapOutputImage").height()*(d-Math.abs(parseFloat(b.y)-parseFloat(a.trim(e[1]))))/
d;return f},roundNumber:function(b,a){return Math.round(b*Math.pow(10,a))/Math.pow(10,a)},tabSelector:function(b){var c={};a("#tabs").tabs("select",b);c.tabs=b;a.bbq.pushState(c)},RGBtoHex:function(b,a,d){return this.toHex(b)+this.toHex(a)+this.toHex(d)},toHex:function(a){if(null===a)return"00";a=parseInt(a,10);if(0===a||isNaN(a))return"00";a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)},bindToolbar:function(){var b=this,
c="";a("#actionsBar").find("li").hover(function(){a(this).toggleClass("ui-state-hover")}).end().find("a.toolsQuery").ColorPicker({onBeforeShow:function(){a(this).ColorPickerSetColor(b.RGBtoHex(150,150,150))},onShow:function(c){a(c).show();b.destroyJcrop();return!1},onHide:function(b){a(b).hide();return!1},onSubmit:function(c,e,f,g){b.unusedVariables(c,e);a(g).ColorPickerHide();b.vars.fillColor=f;b.initJquery();b.vars.zoom=!1}}).end().on("click","a",function(d){d.preventDefault();c=a(this).attr("class").match(/tools([\w\W]+)/)[1].toLowerCase();
switch(c){case "zoomin":b.mapZoom("in");break;case "zoomout":b.mapZoom("out");break;case "crop":b.mapCrop();break;case "query":b.resetJbbox();break;case "refresh":b.mapRefresh();break;case "rebuild":b.mapRebuild();break;case "save":b.mapSave();break;case "download":b.mapDownload()}b.trackEvent("toolbar",c)})},mapCrop:function(){var b={},c=[],c={},b=[],b={};a.cookie("jcrop_coords")?(b=a.parseJSON(a.cookie("jcrop_coords")),c=b.jcrop_coord_ul.split(","),b=b.jcrop_coord_lr.split(","),c=this.geo2pix({x:a.trim(c[0]),
y:a.trim(c[1])}),b=this.geo2pix({x:a.trim(b[0]),y:a.trim(b[1])}),this.loadCropSettings({map:{bbox_rubberband:b.x+","+b.y+","+c.x+","+c.y}})):this.initJcrop();this.vars.zoom=!1},resetAndBuild:function(){this.resetJbbox();this.destroyRedo();this.showMap()},mapRefresh:function(){this.resetAndBuild();this.tabSelector(0)},mapRebuild:function(){a.each(["bbox_map","projection_map","bbox_rubberband","rotation","pan"],function(){a("#"+this).val("")});a("#projection")[0].selectedIndex=0;this.destroyRedo();
this.showMap()},bindArrows:function(){var b=this;a("#wheel-overlay").on("click","a.arrows",function(c){c.preventDefault();a("#pan").val(a(this).attr("data-pan"));b.resetJbbox();b.showMap();b.trackEvent("arrows",a(this).attr("data-pan"))})},mapPan:function(b){a("#pan").val(b);this.resetAndBuild()},mapList:function(){this.tabSelector(3)},mapZoom:function(b){"in"===b?(this.initJzoom(),this.vars.zoom=!0):(this.resetJbbox(),a("#zoom_out").val(1),this.destroyRedo(),this.showMap(),a("#zoom_out").val(""))},
storageType:function(b){var c=0,d=this;return c=a.grep(a.jStorage.index(),function(a,c){d.unusedVariables(c);return a.substring(0,b.length)===b})},toggleUndo:function(b){var c=this,d=this.storageType("do"),e=a("#actionsBar");e.find("a.toolsUndo").removeClass("toolsUndo").addClass("toolsUndoDisabled").off("click");b&&1<d.length&&(d.length>c.settings.undoSize&&a.jStorage.deleteKey(d.shift()),e.find("a.toolsUndoDisabled").addClass("toolsUndo").removeClass("toolsUndoDisabled").on("click",function(a){a.preventDefault();
c.mapUndo();c.trackEvent("edit","undo")}))},toggleRedo:function(b){var c=this,d=a("#actionsBar");d.find("a.toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").off("click");if(b)d.find("a.toolsRedoDisabled").addClass("toolsRedo").removeClass("toolsRedoDisabled").on("click",function(a){a.preventDefault();c.mapRedo();c.trackEvent("edit","redo")})},destroyRedo:function(){var b=this.storageType("undo"),c=a("#actionsBar");0<b.length&&(c.find("a.toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").off("click"),
a.jStorage.deleteKey(b.pop()))},mapUndo:function(){var b=this.storageType("do"),c="",d={},e="",e={},f={};1!==b.length&&(this.destroyRedo(),c=b[b.length-1],d=a.jStorage.get(c),e=b[b.length-2],e=a.jStorage.get(e),f=this.prepareInputs(e),this.loadInputs(f),a.jStorage.deleteKey(c),a.jStorage.set("un"+c,d),e.width!==d.width?this.mapToggleSettings():(this.showSpinner(),this.postData(decodeURIComponent(a.param(e)),null)),this.toggleRedo(!0),2===b.length&&this.toggleUndo())},mapRedo:function(){var b=this.storageType("undo"),
c="",d={},e={},e=this.storageType("do"),f="",f={},g=(new Date).getTime();0!==b.length&&(this.toggleRedo(),c=b.pop(),d=a.jStorage.get(c),f=e[e.length-1],f=a.jStorage.get(f),e=this.prepareInputs(d),this.loadInputs(e),a.jStorage.deleteKey(c),a.jStorage.set("do-"+g.toString(),d),d.width!==f.width?this.mapToggleSettings():(this.showSpinner(),this.postData(decodeURIComponent(a.param(d)),null)),this.toggleUndo(!0))},bindHotkeys:function(){var b=this,c={},d={},c={"ctrl+s":b.bindCallback(b,b.mapSave),"ctrl+d":b.bindCallback(b,
b.mapDownload),"ctrl+l":b.bindCallback(b,b.mapList),"ctrl+r":b.bindCallback(b,b.mapRefresh),"ctrl+n":b.bindCallback(b,b.mapRebuild),"ctrl+x":b.bindCallback(b,b.mapCrop),"ctrl+e":b.bindCallback(b,b.mapToggleSettings),"ctrl++":b.bindCallback(b,b.mapZoom,"in"),"ctrl+-":b.bindCallback(b,b.mapZoom,"out"),esc:b.bindCallback(b,b.destroyJcrop),"ctrl+z":b.bindCallback(b,b.mapUndo),"ctrl+y":b.bindCallback(b,b.mapRedo)},d={up:b.bindCallback(b,b.mapPan,"up"),down:b.bindCallback(b,b.mapPan,"down"),left:b.bindCallback(b,
b.mapPan,"left"),right:b.bindCallback(b,b.mapPan,"right")};"false"===b.settings.active&&(delete c["ctrl+s"],delete c["ctrl+l"]);a.each(c,function(b,c){a(h).on("keydown",null,b,c)});a("#mapOutput").hover(function(){a.each(d,function(b,c){a(h).on("keydown",null,b,c)});a("#mapOutputImage").on("dblclick",function(a){b.dblclickZoom(this,a)})},function(){a.each(d,function(c,d){b.unusedVariables(c);a(h).off("keydown",d)});a("#mapOutputImage").off("dblclick")})},hardResetShowMap:function(){this.resetJbbox();
this.destroyRedo();this.showMap()},bindSettings:function(){var b=this;a("#mapOptions").on("click",".layeropt",function(){b.hardResetShowMap()}).on("click",".gridopt",function(){a("#graticules").prop("checked")||a("#graticules").prop("checked",!0);b.hardResetShowMap()}).on("click","#gridlabel",function(){a("#graticules").prop("checked")||a("#graticules").prop("checked",!0);a(this).prop("checked")&&a(this).val("false");b.hardResetShowMap()});a("#projection").on("change",function(){var c=a("#origin-selector");
""!==a(this).val()&&(a("#origin").val(b.vars.origins[a(this).val()]),b.vars.origins.hasOwnProperty(a("#projection").val())?c.show():c.hide(),a.cookie("jcrop_coords",null),b.hardResetShowMap())});a("#origin").on("blur",function(){b.hardResetShowMap()}).on("keydown",function(a){a=a.keyCode||a.which;9!==a&&13!==a||this.blur()});b.toggleFileFactor();a("#mapExport").find("input.download-factor").on("change",function(){b.toggleFileFactor(a(this).val())}).end().find(".download-filetype").on("change",function(){b.toggleFileType(this)})},
bindSlider:function(){var b=this;a("#border-slider").slider({value:1.25,min:1,max:2,step:0.25,slide:function(c,d){b.unusedVariables(c);a("#border_thickness").val(d.value);b.destroyRedo();b.showMap();b.trackEvent("slider",d.value)}})},toggleFileFactor:function(b){var c="",c=a("#bbox_rubberband").val().split(",");b||(b=a("#mapExport").find('input[name="download-factor"]:checked').val());c="crop"===this.vars.jCropType?b*(c[2]-c[0])+" X "+b*(c[3]-c[1]):b*a("#mapOutputImage").width()+" X "+b*a("#mapOutputImage").height();
a("#scale-measure").find("span").text(c).parent().show()},toggleFileType:function(b){"download-svg"===a(b).attr("id")||"download-pptx"===a(b).attr("id")||"download-docx"===a(b).attr("id")?(a.each(["legend","scalebar"],function(){a("#"+this).prop("checked",!0).prop("disabled",!0)}),a.each(["border","scalelinethickness"],function(){a("#"+this).prop("disabled",!1)})):"download-kml"===a(b).attr("id")?a.each(["legend","scalebar","border","scalelinethickness"],function(){a("#"+this).prop("checked",!0).prop("disabled",
!0)}):a.each(["border","legend","scalebar","scalelinethickness"],function(){a("#"+this).prop("disabled",!1)})},bindColorPickers:function(){var b=this;a("#fieldSetsPoints,#fieldSetsRegions").find("input.colorPicker").ColorPicker({element:a(this),onBeforeShow:function(){var c=a(this).val().split(" ");a(this).ColorPickerSetColor(b.RGBtoHex(c[0],c[1],c[2]))},onHide:function(b){a(b).hide();return!1},onSubmit:function(c,d,e,f){b.unusedVariables(c,d);a(f).val(e.r+" "+e.g+" "+e.b);a(f).ColorPickerHide()}}).on("keyup",
function(){var c=a(this).val().split(" ");a(this).ColorPickerSetColor(b.RGBtoHex(c[0],c[1],c[2]))})},bindClearButtons:function(){var b=this;a("#clearLayers, #clearRegions").on("click",function(c){c.preventDefault();b.clearZone(a(this).parent().prev().prev().children())});a("#fieldSetsPoints,#fieldSetsRegions").on("click","button.clearself",function(c){c.preventDefault();b.clearZone(a(this).parent().parent())})},clearZone:function(b){var c=b.find("select.m-mapShape"),d=b.find("select.m-mapSize"),e=
b.find("input.colorPicker");a.each(["input.m-mapTitle","textarea"],function(){b.find(this).val("")});0<c.length&&(c[0].selectedIndex=4);0<d.length&&(d[0].selectedIndex=3);a.each(b,function(){a(this).hasClass("fieldset-points")?e.val("0 0 0"):e.val("150 150 150")})},bindAutocomplete:function(){var b=this,c="",d=[];a("#fieldSetsRegions").find("textarea").on("keydown",function(b){b.keyCode===a.ui.keyCode.TAB&&a(this).data("autocomplete").menu.active&&b.preventDefault()}).autocomplete({source:function(c,
d){a.getJSON("/places/"+b.extractLast(c.term),{},d)},search:function(){c=b.extractLast(this.value);if(2>c.length)return!1},focus:function(){return!1},select:function(a,c){b.unusedVariables(a);d=b.split(this.value);d.pop();d.push(c.item.value);d.push("");this.value=d.join(", ");return!1}})},split:function(a,c){switch(c){case "[":return a.split(/\]/);default:return a.split(/,\s*/)}},extractLast:function(a){return this.split(a).pop()},destroyJcrop:function(){var b=this.vars;void 0!==b.jzoomAPI&&b.jzoomAPI.destroy();
void 0!==b.jcropAPI&&b.jcropAPI.destroy();void 0!==b.jqueryAPI&&b.jqueryAPI.destroy();a("#mapOutputImage").show();a("#mapOutput").find("div.jcrop-holder").remove();a("#mapCropMessage").hide();this.toggleFileFactor()},resetJbbox:function(){this.vars.jCropType="zoom";a.each(["rubberband","query"],function(){a("#bbox_"+this).val("")});this.toggleFileFactor()},bindCallback:function(b,c){var d=Array.prototype.slice.call(arguments,2);return function(){c.apply(b,a.extend(arguments,d))}},initJcrop:function(b){var c=
this.vars;this.destroyJcrop();this.resetJbbox();c.jCropType="crop";c.jcropAPI=a.Jcrop("#mapOutputImage",{bgColor:"public/images/basemap.png"===a("#mapOutputImage").attr("src")?"grey":"black",bgOpacity:0.5,onChange:this.bindCallback(this,this.showCoords),onSelect:this.bindCallback(this,this.showCoords),setSelect:b});a("#mapCropMessage").show()},initJzoom:function(){var b=this,c=this.vars;b.destroyJcrop();b.resetJbbox();c.jCropType="zoom";c.jzoomAPI=a.Jcrop("#mapOutputImage",{addClass:"customJzoom",
bgOpacity:1,bgColor:"white",onChange:b.bindCallback(b,b.showCoords),onSelect:b.bindCallback(b,b.showCoords)});a(".jcrop-tracker").mousedown(function(){b.activateJcrop("zoom")})},initJquery:function(){var b=this,c=this.vars;b.destroyJcrop();b.resetJbbox();c.jCropType="query";c.jqueryAPI=a.Jcrop("#mapOutputImage",{addClass:"customJzoom",bgOpacity:1,bgColor:"white",onChange:b.bindCallback(b,b.showCoords),onSelect:b.bindCallback(b,b.showCoords)});a(".jcrop-tracker").mousedown(function(){b.activateJcrop("query")})},
activateJcrop:function(b){switch(b){case "zoom":a(h).bind("mouseup",this,this.aZoom);break;case "query":a(h).bind("mouseup",this,this.aQuery)}},aZoom:function(b){b=b.data;b.destroyRedo();b.showMap();a(h).unbind("mouseup",b.aZoom)},dblclickZoom:function(b,c){var d=0,e=0,e={},e=a(b).offset(),d=c.pageX-e.left,e=c.pageY-e.top;a("#bbox_rubberband").val(d+","+e+","+d+","+e);this.destroyRedo();this.showMap()},aQuery:function(b){var c=b.data,d=c.vars.fillColor.r+" "+c.vars.fillColor.g+" "+c.vars.fillColor.b;
b={bbox:a("#rendered_bbox").val(),bbox_query:a("#bbox_query").val(),projection:a("#projection").val(),projection_map:a("#projection_map").val(),origin:a("#origin").val(),qlayer:a("#stateprovince").prop("checked")?"stateprovinces_polygon":"base",width:a("#width").val(),height:a("#height").val()};a(h).unbind("mouseup",c.aQuery);c.destroyJcrop();c.destroyRedo();c.showSpinner();a.ajax({type:"POST",url:c.settings.baseUrl+"/query/",data:b,timeout:3E4,success:function(b){if(0<b.length){var f=b.map(function(a){return a}).join(", "),
g=a("#fieldSetsRegions");b=g.find("div.fieldset-regions");var l=b.length;a.each(b,function(b){b!==l-1||g.find('button[data-type="regions"]').prop("disabled")||(c.addAccordionPanel("regions"),l+=1);if(""===g.find('input[name="regions['+b+'][title]"]').val()||""===g.find('textarea[name="regions['+b+'][data]"]').val())return g.find('input[name="regions['+b+'][title]"]').val("Selected Region "+(b+1).toString()),g.find('input[name="regions['+b+'][color]"]').val(d),g.find('textarea[name="regions['+b+'][data]"]').val(f),
0<b&&a("#fieldSetsRegions").accordion("activate",b),!1});c.showMap()}else c.hideSpinner()},error:function(a,b,d){c.unusedVariables(a,d);"timeout"===b&&c.hideSpinner()}})},textareaCounter:function(a,c){var d=this.vars;switch(c){case "get":switch(a){case "coords":return d.newPointCount;case "regions":return d.newRegionCount}break;case "increase":switch(a){case "coords":return d.newPointCount+=1,d.newPointCount;case "regions":return d.newRegionCount+=1,d.newRegionCount}break;case "decrease":switch(a){case "coords":return d.newPointCount-=
1,d.newPointCount;case "regions":return d.newRegionCount-=1,d.newRegionCount}}},addAccordionPanel:function(b){var c=this,d=c.textareaCounter(b,"get"),e=a("button.addmore[data-type='"+b+"']"),f={},g="coords"===b?"0 0 0":"150 150 150",l=0,h=[];e.attr("data-type")===b&&(d<c.settings.maxTextareaCount&&(e.parent().prev().accordion("activate",!1),f=e.parent().prev().children("div:last").clone(),l=parseInt(f.find("h3 a").text().split(" ")[1],10),d=c.textareaCounter(b,"increase"),f.find("h3 a").text(f.find("h3 a").text().split(" ")[0]+
" "+(l+1).toString()),f.find("input.m-mapTitle").attr("name",b+"["+l.toString()+"][title]").val(""),f.find("textarea").attr("name",b+"["+l.toString()+"][data]").removeClass("textarea-processed").val("").each(function(){c.addGrippies(this)}),f.find("select.m-mapShape").attr("name",b+"["+l.toString()+"][shape]").val("circle"),f.find("select.m-mapSize").attr("name",b+"["+l.toString()+"][size]").val("10"),f.find("input.colorPicker").attr("name",b+"["+l.toString()+"][color]").val(g).ColorPicker({onBeforeShow:function(){var b=
a(this).val().split(" ");a(this).ColorPickerSetColor(c.RGBtoHex(b[0],b[1],b[2]))},onHide:function(b){a(b).hide();return!1},onSubmit:function(b,d,e,f){c.unusedVariables(b,d);a(f).val(e.r+" "+e.g+" "+e.b);a(f).ColorPickerHide()}}).on("keyup",function(){var b=a(this).val().split(" ");a(this).ColorPickerSetColor(c.RGBtoHex(b[0],b[1],b[2]))}),h=e.parent().prev().append(f).children("div"),h.each(function(e,g){c.unusedVariables(g);e===h.length-1&&a(this).find("button.removemore").show().on("click",function(a){a.preventDefault();
c.removeAccordionPanel(f,b);d=c.textareaCounter(b,"decrease")}).parent().find("button.clearself").on("click",function(b){b.preventDefault();c.clearSelf(a(this))}).parent().parent().find(".ui-icon:last").remove()}),e.parent().prev().accordion("destroy").accordion({header:"h3",collapsible:!0,autoHeight:!1,active:!1}),"regions"===b&&c.bindAutocomplete()),d>=c.settings.maxTextareaCount-3&&e.prop("disabled",!0))},removeAccordionPanel:function(b,c){var d=a("button.addmore[data-type='"+c+"']");b.nextAll().each(function(){var b=
parseInt(a(this).find("h3 a").text().split(" ")[1],10);a(this).find("h3 a").text(a(this).find("h3 a").text().split(" ")[0]+" "+(b-1).toString());a(this).find("input.m-mapTitle").attr("name",c+"["+(b-2).toString()+"][title]");a(this).find("textarea").attr("name",c+"["+(b-2).toString()+"][data]");a(this).find("select.m-mapShape").attr("name",c+"["+(b-2).toString()+"][shape]");a(this).find("select.m-mapSize").attr("name",c+"["+(b-2).toString()+"][size]");a(this).find("input.colorPicker").attr("name",
c+"["+(b-2).toString()+"][color]")});b.remove();d.prop("disabled",!1)},addGrippies:function(b){function c(a){e.height(Math.max(32,f+a.pageY)+"px");return!1}function d(){a(h).unbind("mousemove",c).unbind("mouseup",d);e.css({opacity:1})}var e=a(b).addClass("textarea-processed"),f=null;a(b).parent().find(".grippie").bind("mousedown",function(b){f=e.height()-b.pageY;e.css({opacity:0.25});a(h).bind("mousemove",c).bind("mouseup",d);return!1})},bindAddButtons:function(){var b=this;a("#map-points, #map-regions").on("click",
"button.addmore",function(c){var d=a(this).attr("data-type"),e=0;c.preventDefault();b.addAccordionPanel(d);e=a(this).parent().prev().children().length;a(this).parent().prev().accordion("activate",e-1);return!1})},loadMapList:function(b){var c=this,d=b||{},e={};a("#usermaps").html("");c.showSpinner();e={locale:c.getParameterByName("locale"),search:d.search?encodeURIComponent(d.search.toLowerCase()):null,uid:d.uid||null};d.sort&&(e.sort=d.sort.item,e.dir=d.sort.dir);e.locale||delete e.locale;e.search||
delete e.search;e.uid||delete e.uid;a.ajax({type:"GET",url:c.settings.baseUrl+"/usermap/",data:e,dataType:"html",success:function(b){-1!==b.indexOf("session timeout")?k.location.reload():(a("#usermaps").off().html(b).on("click","a.toolsRefresh",function(a){a.preventDefault();c.loadMapList()}).on("click","a.ui-icon-triangle-sort",function(b){b.preventDefault();e.sort={item:a(this).attr("data-sort"),dir:"asc"};a(this).hasClass("asc")&&(e.sort.dir="desc");c.loadMapList(e);c.trackEvent("maplist","sort")}).on("click",
"a.map-load",function(a){a.preventDefault();c.loadMap(this);c.trackEvent("map","load")}).on("click","a.map-delete",function(a){a.preventDefault();c.deleteMapConfirmation(this)}),a("#filter-mymaps").val(d.search).on("keypress",function(b){var d=b.keyCode||b.which;if(13===d||9===d)b.preventDefault(),e.search=a(this).val(),c.loadMapList(e),c.trackEvent("maplist","filter")}).focus(),c.hideSpinner())}})},removeExtraElements:function(){a.each(a("#fieldSetsPoints").find(".fieldset-points"),function(b){2<
b&&a(this).remove()});a.each(a("#fieldSetsRegions").find(".fieldset-regions"),function(b){2<b&&a(this).remove()});this.vars.newPointCount=0;this.vars.newRegionCount=0},prepareInputs:function(b){var c={},d=[],c={status:"ok",mid:a("#actionsBar").find("a.map-embed").attr("data-id"),map:b};c.map.coords=c.map.coords||[];c.map.regions=c.map.regions||[];c.map.layers=c.map.layers||{};c.map.options=c.map.options||{};String.prototype.clean=function(){return this.replace(/[\[\]]/g,"")};a.each(b,function(a,b){-1!==
a.indexOf("coords")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(void 0===c.map.coords[parseInt(d[0].clean(),10)]&&(c.map.coords[parseInt(d[0].clean(),10)]={}),c.map.coords[parseInt(d[0].clean(),10)][d[1].clean()]=b,delete c.map["coords"+d[0]+d[1]]);-1!==a.indexOf("regions")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(void 0===c.map.regions[parseInt(d[0].clean(),10)]&&(c.map.regions[parseInt(d[0].clean(),10)]={}),c.map.regions[parseInt(d[0].clean(),10)][d[1].clean()]=b,delete c.map["regions"+d[0]+d[1]]);-1!==a.indexOf("layers")&&
(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(c.map.layers[d[0].clean()]=b,delete c.map["layers"+d[0]]);-1!==a.indexOf("options")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(c.map.options[d[0].clean()]=b,delete c.map["options"+d[0]]);"save[title]"===a&&(c.map.save={title:b},delete c.map["save[title]"]);"gridspace"===a&&(c.map.grid_space=b);"download-filetype"===a&&(c.map.download_filetype=b);"download-factor"===a&&(c.map.download_factor=b)});return c},loadInputs:function(b){var c=a("#filter-mymaps").val();this.removeExtraElements();
a("#form-mapper").clearForm();a.each(["width","height"],function(){a("#"+this).val(a("#"+this).val())});a("#map-points, #map-regions").find("button.addmore").prop("disabled",!1);a("#filter-mymaps").val(c);a("#origin-selector").hide();this.loadCoordinates(b);this.loadRegions(b);this.loadLayers(b);this.loadSettings(b)},loadMap:function(b){var c=this,d=a(b).attr("data-id");this.tabSelector(0);this.showSpinner();a.ajax({type:"GET",url:c.settings.baseUrl+"/usermap/"+d,dataType:"json",timeout:3E4,success:function(b){c.hideSpinner();
"ok"===b.status?(c.loadInputs(b),c.showMap(b),c.bindStorage(),c.activateEmbed(d)):c.showErrorMessage(a("#mapper-loading-error-message").text());c.toggleUndo();c.toggleRedo()},error:function(b,d,g){c.unusedVariables(b,g);"timeout"===d&&c.showErrorMessage(a("#mapper-loading-error-message").text())}})},loadSettings:function(b){var c="",c="",c=b.map.save.title;a("#save\\[title\\]").val(c);a("#m-mapSaveTitle").val(c);a("#mapTitle").text(c);c=c.replace(/[?*:;{}\\ "']+/g,"_");a("#file-name").val(c);a("#projection").val(b.map.projection);
this.vars.origins.hasOwnProperty(a("#projection").val())&&a("#origin-selector").show();a.each(["bbox_map","projection_map","rotation","origin"],function(){a("#"+this).val(b.map[this])});b.map.origin||a("#origin").val(this.vars.origins[a("#projection").val()]);a("#border_thickness").val(1.25);a("#border-slider").slider({value:1.25});void 0!==b.map.border_thickness&&b.map.border_thickness&&(a("#border_thickness").val(b.map.border_thickness),a("#border-slider").slider({value:b.map.border_thickness}));
this.setRotation(b.map.rotation);this.resetJbbox();a.each(["border","legend","scalebar","scalelinethickness"],function(){a("#"+this).prop("checked",!1);a("#options\\["+this+"\\]").val("")});void 0!==b.map.options&&a.each(["border","legend","scalebar","scalelinethickness"],function(){b.map.options[this]&&void 0!==b.map.options[this]&&(a("#"+this).prop("checked",!0),a("#options\\["+this+"\\]").val(1))});void 0!==b.map.download_factor&&b.map.download_factor?(a("#download_factor").val(b.map.download_factor),
a("#download-factor-"+b.map.download_factor).prop("checked",!0)):a("#download-factor-3").prop("checked",!0);void 0!==b.map.download_filetype&&b.map.download_filetype?(a("#download_filetype").val(b.map.download_filetype),c=a("#download-"+b.map.download_filetype).prop("checked",!0),this.toggleFileType(c)):a("#download-svg").prop("checked",!0);void 0!==b.map.grid_space&&b.map.grid_space?a("#gridspace-"+b.map.grid_space).prop("checked",!0):a("#gridspace").prop("checked",!0);void 0!==b.map.gridlabel&&
b.map.gridlabel?a("#gridlabel").prop("checked",!0):a("#gridlabel").prop("checked",!1)},loadCropSettings:function(a){var c=[];a.map.bbox_rubberband?(c=a.map.bbox_rubberband.split(","),this.initJcrop([c[2],c[3],c[0],c[1]]),this.toggleFileFactor(a.map.download_factor)):this.destroyJcrop()},loadShapeSize:function(b,c){a.each(["shape","size"],function(){""===c[b][this].toString()?a("#fieldSetsPoints").find('select[name="coords['+b.toString()+"]["+this+']"]')[0].selectedIndex=3:a("#fieldSetsPoints").find('select[name="coords['+
b.toString()+"]["+this+']"]').val(c[b][this])})},loadCoordinates:function(b){var c=this,d=a("#fieldSetsPoints"),e=b.map.coords||[],f="",g="",h="",k=/[?*{}\\]+/g;a.each(e,function(a){2<a&&c.addAccordionPanel("coords");f=e[a].title||"";g=e[a].data.replace(k,"")||"";h=e[a].color||"0 0 0";d.find('input[name="coords['+a.toString()+'][title]"]').val(f);d.find('textarea[name="coords['+a.toString()+'][data]"]').val(g);c.loadShapeSize(a,e);d.find('input[name="coords['+a.toString()+'][color]"]').val(h)})},
loadRegions:function(b){var c=this,d=a("#fieldSetsRegions"),e=b.map.regions||[],f="",g="",h="";a.each(e,function(a){2<a&&c.addAccordionPanel("regions");f=e[a].title||"";g=e[a].data||"";h=e[a].color||"150 150 150";d.find('input[name="regions['+a.toString()+'][title]"]').val(f);d.find('textarea[name="regions['+a.toString()+'][data]"]').val(g);d.find('input[name="regions['+a.toString()+'][color]"]').val(h)})},loadLayers:function(b){var c=this;b.map.layers&&a.each(b.map.layers,function(b,e){c.unusedVariables(e);
a("#"+b).prop("checked",!0)})},activateEmbed:function(b){var c=this,d=["img","kml","svg","json"];a("#actionsBar").find("a.toolsEmbed").attr("data-id",b).css({display:"block"}).on("click",function(e){e.preventDefault();a.each(d,function(){"img"===this.toString()?a("#embed-"+this).val('<img src="'+c.settings.baseUrl+"/map/"+b+'" alt="" />'):a("#embed-"+this).val(c.settings.baseUrl+"/map/"+b+"."+this)});a("#mapEmbed").find("span.mid").text(b).end().dialog({width:"525",dialogClass:"ui-dialog-title-mapEmbed",
autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]})})},deleteMapConfirmation:function(b){var c=this,d=a(b).attr("data-id");b="<em>"+a(b).parent().parent().find("td.title").text()+"</em>";a("#mapper-message-delete").find("span").html(b).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles").find("span.delete").text(),
"class":"negative",click:function(){a.ajax({type:"DELETE",url:c.settings.baseUrl+"/usermap/"+d,success:function(){c.loadMapList();c.trackEvent("map","delete")}});a(this).dialog("destroy")}},{text:a("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]})},loadUserList:function(b){var c=this;b=b||{};var d={locale:this.getParameterByName("locale")};c.showSpinner();b.sort&&(d.sort=b.sort.item,d.dir=b.sort.dir);d.locale||delete d.locale;a.ajax({type:"GET",
url:c.settings.baseUrl+"/user/",data:d,dataType:"html",success:function(b){-1!==b.indexOf("access denied")?k.location.reload():(a("#userdata").off().html(b).on("click","a.toolsRefresh",function(a){a.preventDefault();c.loadUserList()}).on("click","a.ui-icon-triangle-sort",function(b){b.preventDefault();d.sort={item:a(this).attr("data-sort"),dir:"asc"};a(this).hasClass("asc")&&(d.sort.dir="desc");c.loadUserList(d)}).on("click","a.user-delete",function(a){a.preventDefault();c.deleteUserConfirmation(this)}).on("click",
"a.user-load",function(b){b.preventDefault();c.loadMapList({uid:a(this).attr("data-uid")});c.tabSelector(3)}),c.hideSpinner())}})},getLanguage:function(){var a="",c=this.getParameterByName("locale");if("fr_FR"===c||"es_ES"===c)a="?locale="+c;return a},deleteUserConfirmation:function(b){var c=this,d=a(b).attr("data-id");b="<em>"+a(b).parent().parent().children("td:first").text()+"</em>";a("#mapper-message-delete").find("span").html(b).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",
modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles").find("span.delete").text(),"class":"negative",click:function(){a.ajax({type:"DELETE",url:c.settings.baseUrl+"/user/"+d,success:function(){c.loadUserList();c.trackEvent("user","delete")}});a(this).dialog("destroy")}},{text:a("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]}).show()},mapSave:function(){var b=!1,c=/[?*:;{}\\ "'\/@#!%\^()<>.]+/g,d=
a("#m-mapSaveTitle"),e=this;a("#mapSave").dialog({autoOpen:!0,height:"175",width:"350",dialogClass:"ui-dialog-title-mapSave",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles").find("span.save").text(),"class":"positive",click:function(){""===a.trim(d.val())&&(b=!0);if(b)d.addClass("ui-state-error").on("keyup",function(){a(this).removeClass("ui-state-error")});else a("#save\\[title\\]").val(d.val()),a.each(["factor","filetype"],function(){a("#download_"+this).val(a("#mapExport").find('input[name="download-'+
this+'"]:checked').val())}),a("#grid_space").val(a("#graticules-selection").find('input[name="gridspace"]:checked').val()),e.setFormOptions(),e.showSpinner(),void 0===e.vars.jcropAPI&&a("#bbox_rubberband").val(""),a.ajax({type:"POST",url:e.settings.baseUrl+"/usermap/",data:a("form").serialize(),dataType:"json",success:function(b){a("#mapTitle").text(d.val());a("#file-name").val(d.val().replace(c,"_"));e.activateEmbed(b.mid);e.loadMapList();e.hideSpinner();e.trackEvent("map","save")}}),a(this).dialog("destroy")}},
{text:a("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]})},mapDownload:function(){var b=this;a("#mapExport").dialog({autoOpen:!0,width:"620",dialogClass:"ui-dialog-title-mapExport",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles").find("span.download").text(),"class":"positive",click:function(){b.generateDownload()}},{text:a("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel",
click:function(){a(this).dialog("destroy")}}]})},bindSubmit:function(){var b=this,c="",d=!1;a("#map-points, #map-regions").find("button.submitForm").on("click",function(e){e.preventDefault();d=!1;a.each(a(this).parent().parent().find("div.fieldSets").children(),function(){c=a(this).find("input.m-mapTitle").on("keyup",function(){d=!1;a(this).removeClass("ui-state-error")});if(a(this).find("textarea.m-mapCoord").val()&&""===c.val())return d=!0,c.addClass("ui-state-error"),!1});d?b.showMessage(a("#mapper-missing-legend").text()):
(b.destroyRedo(),b.showMap(),b.tabSelector(0))})},mapToggleSettings:function(){a("#mapToolsCollapse").find("a").trigger("click")},bindPanelToggle:function(){var b=this;a("#mapToolsCollapse").find("a").tipsy({gravity:"e"}).toggleClick(function(c){c.preventDefault();a("#mapOutputImage").attr("width",0).attr("height",0).css({width:"0px",height:"0px"});a("#mapOutputScale").hide();a(this).parent().addClass("mapTools-collapsed");a("#mapTools").hide("slide",{direction:"right"},250,function(){var c=0.98*
a(k).width();a("#actionsBar").animate({width:c},250);a("#map").animate({width:c},250,function(){a("#width").val(c);b.mapRefresh()})})},function(c){c.preventDefault();a("#mapOutputImage").attr("width",0).attr("height",0).css({width:"0px",height:"0px"});a("#mapOutputScale").hide();a(this).parent().removeClass("mapTools-collapsed");a("#mapTools").show("slide",{direction:"right"},250,function(){a("#actionsBar").animate({width:"910px"},250);a("#map").animate({width:"900px"},250,function(){a("#width").val(900);
b.mapRefresh()})})})},showMessage:function(b){a("#mapper-message").html(b).dialog({autoOpen:!0,height:"200",width:"400",dialogClass:"ui-dialog-title-mapper-message",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]}).show()},drawLegend:function(){var b=a("#legend_url").val(),c=a("#mapLegend");b?c.html('<img src="'+b+'" />'):c.html("<p><em>"+a("#mapper-legend-message").text()+"</em></p>")},drawScalebar:function(){a("#mapScale").find("img").attr("src",
a("#scalebar_url").val()).show()},showBadPoints:function(){var b=a("#bad_points").val();b&&(a("#badRecords").html(b),a("#badRecordsWarning").show())},showSpinner:function(){this.vars.spinner.show()},hideSpinner:function(){this.vars.spinner.hide()},showErrorMessage:function(b){b='<span class="mapper-message-error ui-corner-all ui-widget-content">'+b+"</span>";a("#mapOutput").append(b)},hideErrorMessage:function(){a("#mapOutput").find(".mapper-message-error").remove()},showMap:function(b){var c=(new Date).getTime(),
d="",e={};this.destroyJcrop();a("#output").val("pnga");a("#badRecordsWarning").hide();a("#download_token").val(c);this.showSpinner();d=a("form").serialize();e=a("form").serializeJSON();this.postData(d,b);a.jStorage.set("do-"+c.toString(),e);this.toggleUndo(!0)},postData:function(b,c){var d=this;d.hideErrorMessage();a.ajax({type:"POST",url:d.settings.baseUrl+"/application/",data:b,dataType:"json",timeout:3E4,success:function(a){d.resetFormValues(a);d.resetJbbox();d.drawMap(a,c);d.drawLegend();d.drawScalebar();
d.showBadPoints();d.addBadRecordsViewer()},error:function(b,c,g){d.unusedVariables(b,g);"timeout"===c&&(d.showErrorMessage(a("#mapper-loading-error-message").text()),d.hideSpinner())}})},resetFormValues:function(b){a.each(a("#mapOutput").find("input"),function(){a(this).val("")});a.each("rendered_bbox rendered_rotation rendered_projection legend_url scalebar_url bad_points".split(" "),function(){a("#"+this).val(b[this])});a("#bbox_map").val(a("#rendered_bbox").val());a("#projection_map").val(a("#rendered_projection").val());
a("#rotation").val(a("#rendered_rotation").val());a("#pan").val("")},drawMap:function(b,c){var d=this;a("#mapOutputImage").attr("width",b.size[0]).attr("height",b.size[1]).css({width:b.size[0]+"px",height:b.size[1]+"px"}).attr("src",b.mapOutputImage).one("load",function(){c||(c={map:{bbox_rubberband:""}});d.loadCropSettings(c);d.hideSpinner()})},addBadRecordsViewer:function(){var b=this;a("#badRecordsViewer").dialog({autoOpen:!1,height:"200",width:"500",dialogClass:"ui-dialog-title-badRecordsViewer",
position:[200,200],modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]});a("#badRecordsWarning").find("a.toolsBadRecords").on("click",function(c){c.preventDefault();b.addBadRecordsViewer();a("#badRecordsViewer").dialog("open")})},generateDownload:function(){var b=this,c=a("#file-name").val(),d=(new Date).getTime().toString(),e="",f="",g="png",c=c.replace(/[~$?*,:;{}\[\]\\ "'\/@#!%\^()<>.+=|`&]+/g,"_");a("#file-name").val(c);
a("#file_name").val(c);a("#download_factor").val(a("#mapExport").find('input[name="download-factor"]:checked').val());g=a("#mapExport").find('input[name="download-filetype"]:checked').val();b.setFormOptions();a("#download_token").val(d);a("#mapExport").find("div.download-dialog").hide().end().next().hide().end().find("div.download-message").show();switch(g){case "pptx":a("#output").val("pptx");b.vars.jcropAPI?a("#crop").val(1):b.resetJbbox();f=a("form").serialize();a("body").download("/pptx/"+b.getLanguage(),
f,"post");a("#output").val("pnga");break;case "docx":a("#output").val("docx");b.vars.jcropAPI?a("#crop").val(1):b.resetJbbox();f=a("form").serialize();a("body").download("/docx/"+b.getLanguage(),f,"post");a("#output").val("pnga");break;case "kml":f=a("form").serialize();a("body").download("/kml/",f,"post");break;default:a("#download").val(1),a("#output").val(g),b.vars.jcropAPI?a("#crop").val(1):b.resetJbbox(),f=a("form").serialize(),a("body").download("/application/",f,"post"),a("#download").val(""),
a("#output").val("pnga")}b.vars.fileDownloadTimer=k.setInterval(function(){e=a.cookie("fileDownloadToken");e===d&&b.finishDownload()},1E3);b.trackEvent("download",g)},setFormOptions:function(){a.each(["border","legend","scalebar","scalelinethickness"],function(){a("#options\\["+this+"\\]").val("");a("#"+this).prop("checked")&&a("#options\\["+this+"\\]").val(1)})},finishDownload:function(){a("#mapExport").find("div.download-message").hide().end().next().show().end().find("div.download-dialog").show();
k.clearInterval(this.vars.fileDownloadTimer);a.cookie("fileDownloadToken",null)},showExamples:function(){a("#mapper-message-help").html('<img src="public/images/help-data.png" alt="" />').dialog({height:"355",width:"525",dialogClass:"ui-dialog-title-mapper-message-help",autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]})},showCodes:function(){var b=this.getParameterByName("locale")?{locale:this.getParameterByName("locale")}:
{};a("#mapper-message-codes").dialog({height:"450",width:"850",dialogClass:"ui-dialog-title-mapper-message-codes",autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){a("#mapper-message-codes").find("table").remove();a(this).dialog("destroy")}}]});this.loadCodes(a("#mapper-message-codes"),b)},loadCodes:function(b,c){var d=this,e="";b.find("tbody tr td").text("\u00a0");b.find("tbody tr td:first").text("\u00a0\u00a0\u00a0").addClass("loading");
a.ajax({type:"GET",url:d.settings.baseUrl+"/places/",data:c,dataType:"html",success:function(a){b.html(a);e=b.find("input.filter-countries");e.val("");void 0!==c.filter&&e.val(c.filter);e.on("keypress",function(a){var f=a.keyCode||a.which;if(13===f||9===f)a.preventDefault(),c.filter=e.val(),d.loadCodes(b,c)}).on("blur",function(){c.filter=e.val();d.loadCodes(b,c)})}})},performRotation:function(b){a("#rotation").val(a(b).attr("data-rotate"));this.resetJbbox();this.destroyRedo();this.showMap();this.trackEvent("rotate",
a(b).attr("data-rotate"))},setRotation:function(b){var c=a("#mapControls"),d=c.find("div.thumb"),e=c.find("ul.overview"),f=e.find("li"),g=0,h=g=0;b||(b=0);b=0>parseFloat(b)?parseFloat(b)+360:parseFloat(b);g=b*(Math.PI/180);e.css({left:-(b/360*f.outerWidth(!0)*f.length)+"px"});h=Math.round(28*-Math.cos(g)+(c.outerHeight()/2-d.outerHeight()/2))+"px";g=Math.round(28*Math.sin(g)+(c.outerWidth()/2-d.outerWidth()/2))+"px";d.css({top:h,left:g})},getParameterByName:function(a){a="[\\?&]"+a.replace(/[\[]/,
"\\[").replace(/[\]]/,"\\]")+"=([^&#]*)";a=RegExp(a).exec(k.location.href);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},mapCircleSlider:function(){for(var a=0,c="",a=0;360>a;a+=1)0===a%5&&(c+='<li data-rotate="'+a+'"></li>');return c},clearStorage:function(){this.destroyRedo();a.jStorage.flush()},bindStorage:function(){var b={},c=(new Date).getTime();this.clearStorage();b=a("form").serializeJSON();a.jStorage.set("do-"+c.toString(),b)},bindRotateWheel:function(){var b=this;a("#wheel-overlay").css({backgroundImage:'url("public/images/bg-rotatescroll.png")'});
a("#mapControls").find("ul.overview").append(b.mapCircleSlider()).end().tinycircleslider({snaptodots:!0,radius:28,callback:function(c,d){b.unusedVariables(d);a("#map-loader").find("span.mapper-loading-spinner").is(":hidden")&&b.performRotation(c)}})},bindTabs:function(){var b=this,c=a("#tabs");a("#mapTools").tabs({selected:0});c.tabs({cache:!0,load:function(c,e){b.unusedVariables(c);a(e.tab).data("cache.tabs",""===a(e.panel).html()?!1:!0)},event:"change"}).find("div.ui-state-disabled").each(function(){a(this).removeClass("ui-state-disabled")}).end().show();
c.find("ul.navigation a").on("click",function(){var c={},e=a(this).parent().prevAll().length;c.tabs=e;a.bbq.pushState(c);b.adjustLanguageLinks("tabs",e)});a(k).bind("hashchange",function(){var d=a.bbq.getState("tabs",!0)||0;c.find("ul.navigation a").eq(d).triggerHandler("change");b.adjustLanguageLinks("tabs",d)});a(k).trigger("hashchange")},adjustLanguageLinks:function(b,c){var d="";a.each(a("#site-languages").find("a"),function(){d=a(this).attr("href").split("#")[0];a(this).attr("href",d+"#"+b+"="+
c)})},screenSizeListener:function(){var b=this;a(k).resize(function(){var c=b.getPageSize(),d=b.getPageScroll();a("#mapper-overlay").css({width:c[0],height:c[1]});a("#mapper-message").css({top:d[1]+c[3]/10,left:d[0],position:"fixed",zIndex:1001,margin:"0px auto",width:"100%"})})},unusedVariables:function(){},init:function(){var b=this;this.screenSizeListener();this.bindRotateWheel();this.hideSpinner();a("#header").find("div").show();this.bindTabs();a("#mapOutput").append('<img id="mapOutputImage" src="public/images/basemap.png" alt="" width="900" height="450" />');
a("#mapScale").append('<img id="mapOutputScale" src="public/images/basemap-scalebar.png" width="200" height="27" />');a("#site-session").find("a.login").on("click",function(a){a.preventDefault();b.tabSelector(3)});a("#general-points").find("a.show-examples").on("click",function(a){a.preventDefault();b.showExamples()});a("#regions-introduction").find("a.show-codes").on("click",function(a){a.preventDefault();b.showCodes()});a("#fieldSetsPoints, #fieldSetsRegions").accordion({header:"h3",collapsible:!0,
autoHeight:!1});a("#mapWrapper").find("a.tooltip").tipsy({gravity:"s"});this.bindStorage();this.bindHotkeys();this.bindToolbar();this.bindArrows();this.bindSettings();this.bindSlider();this.bindColorPickers();this.bindAddButtons();this.bindClearButtons();this.bindAutocomplete();this.bindSubmit();this.bindPanelToggle();a("#actionsBar").find("a.toolsUndoDisabled").off("click").end().find("a.toolsRedoDisabled").off("click");a("#fieldSetsPoints, #fieldSetsRegions").find("textarea.resizable:not(.textarea-processed)").TextAreaResizer();
0<a("#usermaps").length&&(this.loadMapList(),this.tabSelector(3));0<a("#userdata").length&&(this.loadUserList(),this.tabSelector(4));a("input").on("keypress",function(a){a=a.keyCode||a.which;if(13===a||9===a)return!1})}};return{init:function(b){a.extend(q.settings,b);q.init()},loadCodes:function(a,c){q.loadCodes(a,c)}}}(jQuery,window,document);
