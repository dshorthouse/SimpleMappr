/*
 * jQuery SimpleMappr
 */
var SimpleMappr=function(a,h,g){'use strict';var n={settings:{baseUrl:"",active:!1,maxTextareaCount:10,undoSize:10},vars:{newPointCount:0,newRegionCount:0,zoom:!0,fileDownloadTimer:{},fillColor:"",jCropType:"zoom",cropUpdated:!1,origins:{"esri:102009":-96,"esri:102015":-60,"esri:102014":10,"esri:102012":105,"esri:102024":25,"epsg:3112":134}},trackEvent:function(a,c){void 0!==h._gaq&&_gaq.push(["_trackEvent",a,c])},getPageSize:function(){var a,c,d,e;h.innerHeight&&h.scrollMaxY?(a=h.innerWidth+h.scrollMaxX,
c=h.innerHeight+h.scrollMaxY):g.body.scrollHeight>g.body.offsetHeight?(a=g.body.scrollWidth,c=g.body.scrollHeight):(a=g.body.offsetWidth,c=g.body.offsetHeight);self.innerHeight?(d=g.documentElement.clientWidth?g.documentElement.clientWidth:self.innerWidth,e=self.innerHeight):g.documentElement&&g.documentElement.clientHeight?(d=g.documentElement.clientWidth,e=g.documentElement.clientHeight):g.body&&(d=g.body.clientWidth,e=g.body.clientHeight);return[a<d?a:d,c<e?e:c,d,e]},getPageScroll:function(){var a,
c;self.pageYOffset?(c=self.pageYOffset,a=self.pageXOffset):g.documentElement&&g.documentElement.scrollTop?(c=g.documentElement.scrollTop,a=g.documentElement.scrollLeft):g.body&&(c=g.body.scrollTop,a=g.body.scrollLeft);return[a,c]},showCoords:function(b){var c=this,d=parseFloat(b.x),e=parseFloat(b.y),f=parseFloat(b.x2),k=parseFloat(b.y2),l=parseFloat(b.w);b=parseFloat(b.h);var g={x:d,y:e},r={x:f,y:k},h={},m={},q=a('input[name="download-factor"]:checked').val();switch(this.vars.jCropType){case "crop":a(".jcrop-holder div:first").css("backgroundColor",
"white");a("#bbox_rubberband").val(d+","+e+","+f+","+k);"epsg:4326"===a("#projection option:selected").val()?a(".jcrop-coord").css("width","100px"):a(".jcrop-coord").css("width","175px");0===a("#jcrop-coord-ul").length&&0===a("#jcrop-coord-lr").length&&a(".jcrop-tracker").eq(0).after('<input type="text" id="jcrop-coord-ul" class="jcrop-coord"></input>').after('<input type="text" id="jcrop-coord-lr" class="jcrop-coord"></input>').after('<div id="jcrop-dimension-wrapper"><input type="text" id="jcrop-dimension-w" class="jcrop-dimension"></input>X<input type="text" id="jcrop-dimension-h" class="jcrop-dimension"></input></div>');
h=c.pix2geo(g);m=c.pix2geo(r);a("#jcrop-coord-ul").val(h.x+", "+h.y);a("#jcrop-coord-lr").val(m.x+", "+m.y);a("#jcrop-dimension-w").val(l);a("#jcrop-dimension-h").val(b);a("#jcrop-dimension-wrapper").css({left:l/2-a("#jcrop-dimension-wrapper").width()/2,top:b/2-a("#jcrop-dimension-wrapper").height()/2});a.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+a("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+a("#jcrop-coord-lr").val()+'" }');a(".jcrop-coord").blur(function(){c.vars.cropUpdated||(c.vars.cropUpdated=
c.updateCropCoordinates())}).keypress(function(a){var b=a.keyCode||a.which;if(13===b||9===b)a.preventDefault(),c.vars.cropUpdated=!1,this.blur()});a(".jcrop-dimension").blur(function(){c.vars.cropUpdated||(c.vars.cropUpdated=c.updateCropDimensions())}).keypress(function(a){var b=a.keyCode||a.which;if(13===b||9===b)a.preventDefault(),c.vars.cropUpdated=!1,this.blur()});a("span","#scale-measure").text(q*l+" X "+q*b).parent().show();break;case "zoom":a(".jcrop-holder div:first").css("backgroundColor",
"white");a("#bbox_rubberband").val(d+","+e+","+f+","+k);break;case "query":a("#bbox_query").val(d+","+e+","+f+","+k)}},updateCropDimensions:function(){var b=a("#bbox_rubberband").val().split(","),c=parseFloat(b[2])-parseFloat(b[0]),d=parseFloat(b[3])-parseFloat(b[1]),e=a("#mapOutputImage").width(),f=a("#mapOutputImage").height(),k=a("#jcrop-dimension-w").val(),l=a("#jcrop-dimension-h").val(),g=b[0],h=b[2],p=b[1],m=b[3],k=k>e?e:(c-k)/2,l=l>f?f:(d-l)/2,g=parseFloat(b[2])-k,h=parseFloat(b[0])+k,p=parseFloat(b[1])+
l,m=parseFloat(b[3])-l;k>=e&&(g=0,h=e);l>=f&&(p=0,m=f);this.loadCropSettings({map:{bbox_rubberband:g.toString()+","+p.toString()+","+h.toString()+","+m.toString()}});return!0},updateCropCoordinates:function(){var b=[],b={},c=[],c={},b=a("#jcrop-coord-ul").val().split(","),b=this.geo2pix({x:a.trim(b[0]),y:a.trim(b[1])}),c=a("#jcrop-coord-lr").val().split(","),c=this.geo2pix({x:a.trim(c[0]),y:a.trim(c[1])});a.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+a("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+
a("#jcrop-coord-lr").val()+'" }');this.loadCropSettings({map:{bbox_rubberband:c.x+","+c.y+","+b.x+","+b.y}});return!0},pix2geo:function(b){var c=0,d=0,e=a("#bbox_map").val(),f=parseFloat(a("#mapOutputImage").width()),k=parseFloat(a("#mapOutputImage").height()),l={};""===e&&(e="-180,-90,180,90");e=e.split(",");c=Math.abs(parseFloat(a.trim(e[2]))-parseFloat(a.trim(e[0])));d=Math.abs(parseFloat(a.trim(e[3]))-parseFloat(a.trim(e[1])));l.x=this.roundNumber(parseFloat(e[0])+parseFloat(b.x)*c/f,2);l.y=this.roundNumber(parseFloat(e[1])+
parseFloat(k-parseFloat(b.y))*d/k,2);return l},geo2pix:function(b){var c=0,d=0,e=a("#bbox_map").val(),f={};""===e&&(e="-180,-90,180,90");e=e.split(",");c=Math.abs(parseFloat(a.trim(e[2]))-parseFloat(a.trim(e[0])));d=Math.abs(parseFloat(a.trim(e[3]))-parseFloat(a.trim(e[1])));f.x=a("#mapOutputImage").width()*Math.abs(parseFloat(b.x)-parseFloat(a.trim(e[0])))/c;f.y=a("#mapOutputImage").height()*(d-Math.abs(parseFloat(b.y)-parseFloat(a.trim(e[1]))))/d;return f},roundNumber:function(a,c){return Math.round(a*
Math.pow(10,c))/Math.pow(10,c)},tabSelector:function(b){var c={};a("#tabs").tabs("select",b);c.tabs=b;a.bbq.pushState(c)},RGBtoHex:function(a,c,d){return this.toHex(a)+this.toHex(c)+this.toHex(d)},toHex:function(a){if(null===a)return"00";a=parseInt(a,10);if(0===a||isNaN(a))return"00";a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)},bindToolbar:function(){var b=this;a("#actionsBar ul li").hover(function(){a(this).addClass("ui-state-hover")},
function(){a(this).removeClass("ui-state-hover")});a(".toolsZoomIn").click(function(a){a.preventDefault();b.mapZoom("in");b.trackEvent("toolbar","zoomin")});a(".toolsZoomOut").click(function(a){a.preventDefault();b.mapZoom("out");b.trackEvent("toolbar","zoomout")});a(".toolsCrop").click(function(a){a.preventDefault();b.mapCrop();b.trackEvent("toolbar","crop")});a(".toolsQuery").ColorPicker({onBeforeShow:function(){a(this).ColorPickerSetColor(b.RGBtoHex(150,150,150))},onShow:function(c){a(c).show();
b.destroyJcrop();return!1},onHide:function(b){a(b).hide();return!1},onSubmit:function(c,d,e,f){a(f).ColorPickerHide();b.vars.fillColor=e;b.initJquery();b.vars.zoom=!1;b.trackEvent("toolbar","query")}}).click(function(a){a.preventDefault();b.resetJbbox()});a(".toolsRefresh").click(function(a){a.preventDefault();b.mapRefresh();b.trackEvent("toolbar","refresh")});a(".toolsRebuild").click(function(a){a.preventDefault();b.mapRebuild();b.trackEvent("toolbar","rebuild")})},mapCrop:function(){var b={},c=
[],c={},b=[],b={};a.cookie("jcrop_coords")?(b=a.parseJSON(a.cookie("jcrop_coords")),c=b.jcrop_coord_ul.split(","),b=b.jcrop_coord_lr.split(","),c=this.geo2pix({x:a.trim(c[0]),y:a.trim(c[1])}),b=this.geo2pix({x:a.trim(b[0]),y:a.trim(b[1])}),this.loadCropSettings({map:{bbox_rubberband:b.x+","+b.y+","+c.x+","+c.y}})):this.initJcrop();self.vars.zoom=!1},resetAndBuild:function(){this.resetJbbox();this.destroyRedo();this.showMap()},mapRefresh:function(){this.resetAndBuild();this.tabSelector(0)},mapRebuild:function(){a.each("bbox_map projection_map bbox_rubberband rotation projection pan".split(" "),
function(){a("#"+this).val("")});this.destroyRedo();this.showMap()},bindArrows:function(){var b=this;a(".arrows").click(function(c){c.preventDefault();a("#pan").val(a(this).attr("data-pan"));b.resetJbbox();b.showMap();b.trackEvent("arrows",a(this).attr("data-pan"))})},mapPan:function(b){a("#pan").val(b);this.resetAndBuild()},mapList:function(){this.tabSelector(3)},mapZoom:function(b){"in"===b?(this.initJzoom(),this.vars.zoom=!0):(this.resetJbbox(),a("#zoom_out").val(1),this.destroyRedo(),this.showMap(),
a("#zoom_out").val(""))},storageType:function(b){var c=0;return c=a.grep(a.jStorage.index(),function(a,c){return a.substring(0,b.length)===b})},toggleUndo:function(b){var c=this,d=this.storageType("do");a(".toolsUndo").addClass("toolsUndoDisabled").removeClass("toolsUndo").unbind("click");b&&1<d.length&&(d.length>c.settings.undoSize&&a.jStorage.deleteKey(d.shift()),a(".toolsUndoDisabled").addClass("toolsUndo").removeClass("toolsUndoDisabled").bind("click",function(a){a.preventDefault();c.mapUndo();
c.trackEvent("edit","undo")}))},toggleRedo:function(b){var c=this;a(".toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").unbind("click");b&&a(".toolsRedoDisabled").addClass("toolsRedo").removeClass("toolsRedoDisabled").bind("click",function(a){a.preventDefault();c.mapRedo();c.trackEvent("edit","redo")})},destroyRedo:function(){var b=this.storageType("undo");0<b.length&&(a(".toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").unbind("click"),a.jStorage.deleteKey(b.pop()))},
mapUndo:function(){var b=this.storageType("do"),c="",d={},e="",e={},f={};1!==b.length&&(this.destroyRedo(),c=b[b.length-1],d=a.jStorage.get(c),e=b[b.length-2],e=a.jStorage.get(e),f=this.prepareInputs(e),this.loadInputs(f),a.jStorage.deleteKey(c),a.jStorage.set("un"+c,d),e.width!==d.width?this.mapToggleSettings():(this.showSpinner(),this.postData(decodeURIComponent(a.param(e)),null)),this.toggleRedo(!0),2===b.length&&this.toggleUndo())},mapRedo:function(){var b=this.storageType("undo"),c="",d={},e=
{},e=this.storageType("do"),f="",f={},k=(new Date).getTime();0!==b.length&&(this.toggleRedo(),c=b.pop(),d=a.jStorage.get(c),f=e[e.length-1],f=a.jStorage.get(f),e=this.prepareInputs(d),this.loadInputs(e),a.jStorage.deleteKey(c),a.jStorage.set("do-"+k.toString(),d),d.width!==f.width?this.mapToggleSettings():(this.showSpinner(),this.postData(decodeURIComponent(a.param(d)),null)),this.toggleUndo(!0))},bindHotkeys:function(){var b=this,c={},d={},c={"ctrl+s":b.bindCallback(b,b.mapSave),"ctrl+d":b.bindCallback(b,
b.mapDownload),"ctrl+l":b.bindCallback(b,b.mapList),"ctrl+r":b.bindCallback(b,b.mapRefresh),"ctrl+n":b.bindCallback(b,b.mapRebuild),"ctrl+x":b.bindCallback(b,b.mapCrop),"ctrl+e":b.bindCallback(b,b.mapToggleSettings),"ctrl++":b.bindCallback(b,b.mapZoom,"in"),"ctrl+-":b.bindCallback(b,b.mapZoom,"out"),esc:b.bindCallback(b,b.destroyJcrop),"ctrl+z":b.bindCallback(b,b.mapUndo),"ctrl+y":b.bindCallback(b,b.mapRedo)},d={up:b.bindCallback(b,b.mapPan,"up"),down:b.bindCallback(b,b.mapPan,"down"),left:b.bindCallback(b,
b.mapPan,"left"),right:b.bindCallback(b,b.mapPan,"right")};"false"===b.settings.active&&(delete c["ctrl+s"],delete c["ctrl+l"]);a.each(c,function(b,c){a(g).bind("keydown",b,c)});a("#mapOutput").hover(function(){a.each(d,function(b,c){a(g).bind("keydown",b,c)});a("#mapOutputImage").dblclick(function(a){b.dblclickZoom(this,a)})},function(){a.each(d,function(b,c){a(g).unbind("keydown",c)});a("#mapOutputImage").unbind("dblclick")})},hardResetShowMap:function(){this.resetJbbox();this.destroyRedo();this.showMap()},
bindSettings:function(){var b=this;a(".layeropt").click(function(){b.hardResetShowMap()});a(".gridopt").click(function(){a("#graticules").prop("checked")||a("#graticules").prop("checked",!0);b.hardResetShowMap()});a("#gridlabel").click(function(){a("#graticules").prop("checked")||a("#graticules").prop("checked",!0);a(this).prop("checked")&&a(this).val("false");b.hardResetShowMap()});a("#projection").change(function(){var c=a("#origin-selector");""!==a(this).val()&&(a("#origin").val(b.vars.origins[a(this).val()]),
b.vars.origins.hasOwnProperty(a("#projection").val())?c.show():c.hide(),a.cookie("jcrop_coords",null),b.hardResetShowMap())});a("#origin").blur(function(){b.hardResetShowMap()}).keydown(function(a){a=a.keyCode||a.which;9!==a&&13!==a||this.blur()});b.toggleFileFactor();a(".download-factor").change(function(){b.toggleFileFactor(a(this).val())});a(".download-filetype").change(function(){b.toggleFileType(this)})},bindSlider:function(){var b=this;a("#border-slider").slider({value:1.25,min:1,max:2,step:0.25,
slide:function(c,d){a('input[name="border_thickness"]').val(d.value);b.destroyRedo();b.showMap();b.trackEvent("slider",d.value)}})},toggleFileFactor:function(b){var c="",c=a("#bbox_rubberband").val().split(",");b||(b=a('input[name="download-factor"]:checked').val());c="crop"===this.vars.jCropType?b*(c[2]-c[0])+" X "+b*(c[3]-c[1]):b*a("#mapOutputImage").width()+" X "+b*a("#mapOutputImage").height();a("span","#scale-measure").text(c).parent().show()},toggleFileType:function(b){"download-svg"===a(b).attr("id")||
"download-pptx"===a(b).attr("id")||"download-docx"===a(b).attr("id")?(a.each(["legend","scalebar"],function(){a("#"+this).prop("checked",!0).prop("disabled",!0)}),a.each(["border","scalelinethickness"],function(){a("#"+this).prop("disabled",!1)})):"download-kml"===a(b).attr("id")?a.each(["legend","scalebar","border","scalelinethickness"],function(){a("#"+this).prop("checked",!0).prop("disabled",!0)}):a.each(["border","legend","scalebar","scalelinethickness"],function(){a("#"+this).prop("disabled",
!1)})},bindColorPickers:function(){var b=this;a(".colorPicker").ColorPicker({element:a(this),onBeforeShow:function(){var c=a(this).val().split(" ");a(this).ColorPickerSetColor(b.RGBtoHex(c[0],c[1],c[2]))},onHide:function(b){a(b).hide();return!1},onSubmit:function(b,d,e,f){a(f).val(e.r+" "+e.g+" "+e.b);a(f).ColorPickerHide()}}).bind("keyup",function(){var c=a(this).val().split(" ");a(this).ColorPickerSetColor(b.RGBtoHex(c[0],c[1],c[2]))})},bindClearButtons:function(){var b=this;a(".clearLayers, .clearRegions").click(function(b){var d=
a(this).parent().prev().prev().children();b.preventDefault();a.each([".m-mapTitle","textarea"],function(){a(d).find(this).val("")});0<a(d).find(".m-mapShape").length&&(a(d).find(".m-mapShape")[0].selectedIndex=4);0<a(d).find(".m-mapSize").length&&(a(d).find(".m-mapSize")[0].selectedIndex=3);a(this).hasClass("clearLayers")?a(d).find(".colorPicker").val("0 0 0"):a(d).find(".colorPicker").val("150 150 150");return!1});a(".clearself").click(function(c){c.preventDefault();b.clearSelf(a(this))})},bindAutocomplete:function(){var b=
this,c="",d=[];a("textarea",".fieldset-regions").bind("keydown",function(b){b.keyCode===a.ui.keyCode.TAB&&a(this).data("autocomplete").menu.active&&b.preventDefault()}).autocomplete({source:function(c,d){a.getJSON("/places/"+b.extractLast(c.term),{},d)},search:function(){c=b.extractLast(this.value);if(2>c.length)return!1},focus:function(){return!1},select:function(a,c){d=b.split(this.value);d.pop();d.push(c.item.value);d.push("");this.value=d.join(", ");return!1}})},split:function(a,c){switch(c){case "[":return a.split(/\]/);
default:return a.split(/,\s*/)}},extractLast:function(a){return this.split(a).pop()},clearSelf:function(b){var c=a(b).parent();b=a(c).find(".colorPicker");a.each([".m-mapTitle","textarea"],function(){a(c).find(this).val("")});0<a(c).find(".m-mapShape").length&&(a(c).find(".m-mapShape")[0].selectedIndex=4);0<a(c).find(".m-mapSize").length&&(a(c).find(".m-mapSize")[0].selectedIndex=3);a(c).parent().hasClass("fieldset-points")?b.val("0 0 0"):b.val("150 150 150")},destroyJcrop:function(){var b=this.vars;
void 0!==b.jzoomAPI&&b.jzoomAPI.destroy();void 0!==b.jcropAPI&&b.jcropAPI.destroy();void 0!==b.jqueryAPI&&b.jqueryAPI.destroy();a("#mapOutputImage").show();a(".jcrop-holder").remove();a("#mapCropMessage").hide();this.toggleFileFactor()},resetJbbox:function(){this.vars.jCropType="zoom";a.each(["rubberband","query"],function(){a("#bbox_"+this).val("")});this.toggleFileFactor()},bindCallback:function(b,c){var d=Array.prototype.slice.call(arguments,2);return function(){c.apply(b,a.extend(arguments,d))}},
initJcrop:function(b){var c=this.vars;this.destroyJcrop();this.resetJbbox();c.jCropType="crop";c.jcropAPI=a.Jcrop("#mapOutputImage",{bgColor:"public/images/basemap.png"===a("#mapOutputImage").attr("src")?"grey":"black",bgOpacity:0.5,onChange:this.bindCallback(this,this.showCoords),onSelect:this.bindCallback(this,this.showCoords),setSelect:b});a("#mapCropMessage").show()},initJzoom:function(){var b=this,c=this.vars;b.destroyJcrop();b.resetJbbox();c.jCropType="zoom";c.jzoomAPI=a.Jcrop("#mapOutputImage",
{addClass:"customJzoom",bgOpacity:1,bgColor:"white",onChange:b.bindCallback(b,b.showCoords),onSelect:b.bindCallback(b,b.showCoords)});a(".jcrop-tracker").mousedown(function(){b.activateJcrop("zoom")})},initJquery:function(){var b=this,c=this.vars;b.destroyJcrop();b.resetJbbox();c.jCropType="query";c.jqueryAPI=a.Jcrop("#mapOutputImage",{addClass:"customJzoom",bgOpacity:1,bgColor:"white",onChange:b.bindCallback(b,b.showCoords),onSelect:b.bindCallback(b,b.showCoords)});a(".jcrop-tracker").mousedown(function(){b.activateJcrop("query")})},
activateJcrop:function(b){switch(b){case "zoom":a(g).bind("mouseup",this,this.aZoom);break;case "query":a(g).bind("mouseup",this,this.aQuery)}},aZoom:function(b){b=b.data;b.destroyRedo();b.showMap();a(g).unbind("mouseup",b.aZoom)},dblclickZoom:function(b,c){var d=0,e=0,e={},e=a(b).offset(),d=c.pageX-e.left,e=c.pageY-e.top;a("#bbox_rubberband").val(d+","+e+","+d+","+e);this.destroyRedo();this.showMap()},aQuery:function(b){var c=b.data,d=c.vars.fillColor.r+" "+c.vars.fillColor.g+" "+c.vars.fillColor.b;
b={bbox:a("#rendered_bbox").val(),bbox_query:a("#bbox_query").val(),projection:a("#projection").val(),projection_map:a("#projection_map").val(),origin:a("#origin").val(),qlayer:a("#stateprovince").prop("checked")?"stateprovinces_polygon":"base",width:a('input[name="width"]').val(),height:a('input[name="height"]').val()};a(g).unbind("mouseup",c.aQuery);c.destroyJcrop();c.destroyRedo();c.showSpinner();a.ajax({type:"POST",url:c.settings.baseUrl+"/query/",data:b,timeout:3E4,success:function(b){if(0<b.length){var f=
b.map(function(a){return a}).join(", "),k=a(".fieldset-regions").length;a.each(a(".fieldset-regions"),function(b){b!==k-1||a('button[data-type="regions"]').prop("disabled")||(c.addAccordionPanel("regions"),k+=1);if(""===a('input[name="regions['+b+'][title]"]').val()||""===a('textarea[name="regions['+b+'][data]"]').val())return a('input[name="regions['+b+'][title]"]').val("Selected Region "+(b+1).toString()),a('input[name="regions['+b+'][color]"]').val(d),a('textarea[name="regions['+b+'][data]"]').val(f),
0<b&&a("#fieldSetsRegions").accordion("activate",b),!1});c.showMap()}else c.hideSpinner()},error:function(a,b,d){"timeout"===b&&c.hideSpinner()}})},textareaCounter:function(a,c){var d=this.vars;switch(c){case "get":switch(a){case "coords":return d.newPointCount;case "regions":return d.newRegionCount}break;case "increase":switch(a){case "coords":return d.newPointCount+=1,d.newPointCount;case "regions":return d.newRegionCount+=1,d.newRegionCount}break;case "decrease":switch(a){case "coords":return d.newPointCount-=
1,d.newPointCount;case "regions":return d.newRegionCount-=1,d.newRegionCount}}},addAccordionPanel:function(b){var c=this,d=c.textareaCounter(b,"get"),e=a(".addmore[data-type='"+b+"']"),f={},k="coords"===b?"0 0 0":"150 150 150",g=0,h=[];e.attr("data-type")===b&&(d<c.settings.maxTextareaCount&&(e.parent().prev().accordion("activate",!1),f=e.parent().prev().children("div:last").clone(),g=parseInt(f.find("h3 a").text().split(" ")[1],10),d=c.textareaCounter(b,"increase"),f.find("h3 a").text(f.find("h3 a").text().split(" ")[0]+
" "+(g+1).toString()),f.find("input.m-mapTitle").attr("name",b+"["+g.toString()+"][title]").val(""),f.find("textarea").attr("name",b+"["+g.toString()+"][data]").removeClass("textarea-processed").val("").each(function(){c.addGrippies(this)}),f.find("select.m-mapShape").attr("name",b+"["+g.toString()+"][shape]").val("circle"),f.find("select.m-mapSize").attr("name",b+"["+g.toString()+"][size]").val("10"),f.find("input.colorPicker").attr("name",b+"["+g.toString()+"][color]").val(k).ColorPicker({onBeforeShow:function(){var b=
a(this).val().split(" ");a(this).ColorPickerSetColor(c.RGBtoHex(b[0],b[1],b[2]))},onHide:function(b){a(b).hide();return!1},onSubmit:function(b,c,d,e){a(e).val(d.r+" "+d.g+" "+d.b);a(e).ColorPickerHide()}}).bind("keyup",function(){var b=a(this).val().split(" ");a(this).ColorPickerSetColor(c.RGBtoHex(b[0],b[1],b[2]))}),h=e.parent().prev().append(f).children("div"),h.each(function(e,k){e===h.length-1&&a(this).find("button.removemore").show().click(function(a){a.preventDefault();c.removeAccordionPanel(f,
b);d=c.textareaCounter(b,"decrease")}).parent().find("button.clearself").click(function(b){b.preventDefault();c.clearSelf(a(this))}).parent().parent().find(".ui-icon:last").remove()}),e.parent().prev().accordion("destroy").accordion({header:"h3",collapsible:!0,autoHeight:!1,active:!1}),"regions"===b&&c.bindAutocomplete()),d>=c.settings.maxTextareaCount-3&&e.prop("disabled",!0))},removeAccordionPanel:function(b,c){var d=a(".addmore[data-type='"+c+"']");b.nextAll().each(function(){var b=parseInt(a(this).find("h3 a").text().split(" ")[1],
10);a(this).find("h3 a").text(a(this).find("h3 a").text().split(" ")[0]+" "+(b-1).toString());a(this).find("input.m-mapTitle").attr("name",c+"["+(b-2).toString()+"][title]");a(this).find("textarea").attr("name",c+"["+(b-2).toString()+"][data]");a(this).find("select.m-mapShape").attr("name",c+"["+(b-2).toString()+"][shape]");a(this).find("select.m-mapSize").attr("name",c+"["+(b-2).toString()+"][size]");a(this).find("input.colorPicker").attr("name",c+"["+(b-2).toString()+"][color]")});b.remove();d.prop("disabled",
!1)},addGrippies:function(b){function c(a){e.height(Math.max(32,f+a.pageY)+"px");return!1}function d(){a(g).unbind("mousemove",c).unbind("mouseup",d);e.css("opacity",1)}var e=a(b).addClass("textarea-processed"),f=null;a(b).parent().find(".grippie").bind("mousedown",function(b){f=e.height()-b.pageY;e.css("opacity",0.25);a(g).bind("mousemove",c).bind("mouseup",d);return!1})},bindAddButtons:function(){var b=this;a(".addmore").click(function(c){var d=a(this).attr("data-type"),e=0;c.preventDefault();b.addAccordionPanel(d);
e=a(this).parent().prev().children().length;a(this).parent().prev().accordion("activate",e-1);return!1})},loadMapList:function(b){var c=this,d=b||{},e={};a("#usermaps").html("");c.showSpinner();e={locale:c.getParameterByName("locale"),search:d.search?encodeURIComponent(d.search.toLowerCase()):null,uid:d.uid||null};d.sort&&(e.sort=d.sort.item,e.dir=d.sort.dir);e.locale||delete e.locale;e.search||delete e.search;e.uid||delete e.uid;a.ajax({type:"GET",url:c.settings.baseUrl+"/usermap/",data:e,dataType:"html",
success:function(b){-1!==b.indexOf("session timeout")?h.location.reload():(a("#usermaps").html(b),c.hideSpinner(),a(".toolsRefresh",".grid-usermaps").click(function(a){a.preventDefault();c.loadMapList()}),a("#filter-mymaps").val(d.search).keypress(function(b){13===b.which&&(b.preventDefault(),e.search=a(this).val(),c.loadMapList(e),c.trackEvent("maplist","filter"))}).focus(),a(".ui-icon-triangle-sort",".grid-usermaps").click(function(b){b.preventDefault();e.sort={item:a(this).attr("data-sort"),dir:"asc"};
a(this).hasClass("asc")&&(e.sort.dir="desc");c.loadMapList(e);c.trackEvent("maplist","sort")}),a(".map-load").click(function(a){a.preventDefault();c.loadMap(this);c.trackEvent("map","load")}),a(".map-delete").click(function(a){a.preventDefault();c.deleteMapConfirmation(this)}))}})},removeExtraElements:function(){var b=this;a.each(a(".fieldset-points"),function(c){2<c&&(a("#fieldSetsPoints div.fieldset-points:eq("+c.toString()+")").remove(),b.vars.newPointCount=0)});a.each(a(".fieldset-regions"),function(c){2<
c&&(a("#fieldSetsRegions div.fieldset-regions:eq("+c.toString()+")").remove(),b.vars.newRegionCount=0)})},prepareInputs:function(b){var c={},d=[],c={status:"ok",mid:a(".map-embed").attr("data-id"),map:b};c.map.coords=c.map.coords||[];c.map.regions=c.map.regions||[];c.map.layers=c.map.layers||{};c.map.options=c.map.options||{};String.prototype.clean=function(){return this.replace(/[\[\]]/g,"")};a.each(b,function(a,b){-1!==a.indexOf("coords")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(void 0===c.map.coords[parseInt(d[0].clean(),
10)]&&(c.map.coords[parseInt(d[0].clean(),10)]={}),c.map.coords[parseInt(d[0].clean(),10)][d[1].clean()]=b,delete c.map["coords"+d[0]+d[1]]);-1!==a.indexOf("regions")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(void 0===c.map.regions[parseInt(d[0].clean(),10)]&&(c.map.regions[parseInt(d[0].clean(),10)]={}),c.map.regions[parseInt(d[0].clean(),10)][d[1].clean()]=b,delete c.map["regions"+d[0]+d[1]]);-1!==a.indexOf("layers")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(c.map.layers[d[0].clean()]=b,delete c.map["layers"+
d[0]]);-1!==a.indexOf("options")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(c.map.options[d[0].clean()]=b,delete c.map["options"+d[0]]);"save[title]"===a&&(c.map.save={title:b},delete c.map["save[title]"]);"gridspace"===a&&(c.map.grid_space=b);"download-filetype"===a&&(c.map.download_filetype=b);"download-factor"===a&&(c.map.download_factor=b)});return c},loadInputs:function(b){var c=a("#filter-mymaps").val();this.removeExtraElements();a("#form-mapper").clearForm();a.each(["width","height"],function(){a('input[name="'+
this+'"]').val(a('input[name="'+this+'"]').val())});a(".addmore").prop("disabled",!1);a("#filter-mymaps").val(c);a("#origin-selector").hide();this.loadCoordinates(b);this.loadRegions(b);this.loadLayers(b);this.loadSettings(b)},loadMap:function(b){var c=this,d=a(b).attr("data-id");this.tabSelector(0);this.showSpinner();a.ajax({type:"GET",url:c.settings.baseUrl+"/usermap/"+d,dataType:"json",timeout:3E4,success:function(b){c.hideSpinner();"ok"===b.status?(c.loadInputs(b),c.showMap(b),c.bindStorage(),
c.activateEmbed(d)):c.showErrorMessage(a("#mapper-loading-error-message").text());c.toggleUndo();c.toggleRedo()},error:function(b,d,g){"timeout"===d&&c.showErrorMessage(a("#mapper-loading-error-message").text())}})},loadSettings:function(b){var c="",c="",c=b.map.save.title;a('input[name="save[title]"]').val(c);a(".m-mapSaveTitle").val(c);a("#mapTitle").text(c);c=c.replace(/[?*:;{}\\ "']+/g,"_");a("#file-name").val(c);a("#projection").val(b.map.projection);this.vars.origins.hasOwnProperty(a("#projection").val())&&
a("#origin-selector").show();a.each(["bbox_map","projection_map","rotation","origin"],function(){a('input[name="'+this+'"]').val(b.map[this])});b.map.origin||a("#origin").val(this.vars.origins[a("#projection").val()]);a('input[name="border_thickness"]').val(1.25);a("#border-slider").slider({value:1.25});void 0!==b.map.border_thickness&&b.map.border_thickness&&(a('input[name="border_thickness"]').val(b.map.border_thickness),a("#border-slider").slider({value:b.map.border_thickness}));this.setRotation(b.map.rotation);
this.resetJbbox();a.each(["border","legend","scalebar","scalelinethickness"],function(){a("#"+this).prop("checked",!1);a('input[name="options['+this+']"]').val("")});void 0!==b.map.options&&a.each(["border","legend","scalebar","scalelinethickness"],function(){b.map.options[this]&&void 0!==b.map.options[this]&&(a("#"+this).prop("checked",!0),a('input[name="options['+this+']"]').val(1))});void 0!==b.map.download_factor&&b.map.download_factor?(a('input[name="download_factor"]').val(b.map.download_factor),
a("#download-factor-"+b.map.download_factor).prop("checked",!0)):a("#download-factor-3").prop("checked",!0);void 0!==b.map.download_filetype&&b.map.download_filetype?(a('input[name="download_filetype"]').val(b.map.download_filetype),c=a("#download-"+b.map.download_filetype).prop("checked",!0),this.toggleFileType(c)):a("#download-svg").prop("checked",!0);void 0!==b.map.grid_space&&b.map.grid_space?(a('input[name="gridspace"]').prop("checked",!0),a("#gridspace-"+b.map.grid_space).prop("checked",!0)):
a("#gridspace").prop("checked",!0);void 0!==b.map.gridlabel&&b.map.gridlabel?a('input[name="gridlabel"]').prop("checked",!0).val("false"):a("#gridlabel").prop("checked",!0)},loadCropSettings:function(a){var c=[];a.map.bbox_rubberband?(c=a.map.bbox_rubberband.split(","),this.initJcrop([c[2],c[3],c[0],c[1]]),this.toggleFileFactor(a.map.download_factor)):this.destroyJcrop()},loadShapeSize:function(b,c){a.each(["shape","size"],function(){""===c[b][this].toString()?a('select[name="coords['+b.toString()+
"]["+this+']"]')[0].selectedIndex=3:a('select[name="coords['+b.toString()+"]["+this+']"]').val(c[b][this])})},loadCoordinates:function(b){var c=this,d=b.map.coords||[],e="",f="",g="",h=/[?*{}\\]+/g;a.each(d,function(b){2<b&&c.addAccordionPanel("coords");e=d[b].title||"";f=d[b].data.replace(h,"")||"";g=d[b].color||"0 0 0";a('input[name="coords['+b.toString()+'][title]"]').val(e);a('textarea[name="coords['+b.toString()+'][data]"]').val(f);c.loadShapeSize(b,d);a('input[name="coords['+b.toString()+'][color]"]').val(g)})},
loadRegions:function(b){var c=this,d=b.map.regions||[],e="",f="",g="";a.each(d,function(b){2<b&&c.addAccordionPanel("regions");e=d[b].title||"";f=d[b].data||"";g=d[b].color||"150 150 150";a('input[name="regions['+b.toString()+'][title]"]').val(e);a('textarea[name="regions['+b.toString()+'][data]"]').val(f);a('input[name="regions['+b.toString()+'][color]"]').val(g)})},loadLayers:function(b){b.map.layers&&a.each(b.map.layers,function(b,d){a('input[name="layers['+b+']"]').prop("checked",!0)})},activateEmbed:function(b){var c=
this,d=["img","kml","svg","json"];a(".map-embed").attr("data-id",b).css("display","block").click(function(e){e.preventDefault();a.each(d,function(){"img"===this.toString()?a("#embed-"+this,"#mapEmbed").val('<img src="'+c.settings.baseUrl+"/map/"+b+'" alt="" />'):a("#embed-"+this,"#mapEmbed").val(c.settings.baseUrl+"/map/"+b+"."+this)});a("#mapEmbed").find("span.mid").text(b).end().dialog({width:"525",dialogClass:"ui-dialog-title-mapEmbed",autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,
buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]}).show()})},deleteMapConfirmation:function(b){var c=this,d=a(b).attr("data-id");b="<em>"+a(b).parent().parent().find(".title").text()+"</em>";a("#mapper-message-delete").find("span").html(b).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles span.delete").text(),"class":"negative",click:function(){a.ajax({type:"DELETE",
url:c.settings.baseUrl+"/usermap/"+d,success:function(){c.loadMapList();c.trackEvent("map","delete")}});a(this).dialog("destroy")}},{text:a("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]}).show()},loadUserList:function(b){var c=this;b=b||{};var d={locale:this.getParameterByName("locale")};c.showSpinner();b.sort&&(d.sort=b.sort.item,d.dir=b.sort.dir);d.locale||delete d.locale;a.ajax({type:"GET",url:c.settings.baseUrl+"/user/",data:d,dataType:"html",
success:function(b){-1!==b.indexOf("access denied")?h.location.reload():(a("#userdata").html(b),c.hideSpinner(),a(".toolsRefresh",".grid-users").click(function(a){a.preventDefault();c.loadUserList()}),a(".ui-icon-triangle-sort",".grid-users").click(function(b){b.preventDefault();d.sort={item:a(this).attr("data-sort"),dir:"asc"};a(this).hasClass("asc")&&(d.sort.dir="desc");c.loadUserList(d)}),a(".user-delete").click(function(a){a.preventDefault();c.deleteUserConfirmation(this)}),a(".user-load").click(function(b){b.preventDefault();
c.loadMapList({uid:a(this).attr("data-uid")});c.tabSelector(3)}))}})},getLanguage:function(){var a="",c=this.getParameterByName("locale");if("fr_FR"===c||"es_ES"===c)a="?locale="+c;return a},deleteUserConfirmation:function(b){var c=this,d=a(b).attr("data-id");b="<em>"+a(b).parent().parent().children("td:first").text()+"</em>";a("#mapper-message-delete").find("span").html(b).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",modal:!0,closeOnEscape:!1,draggable:!0,
resizable:!1,buttons:[{text:a("#button-titles span.delete").text(),"class":"negative",click:function(){a.ajax({type:"DELETE",url:c.settings.baseUrl+"/user/"+d,success:function(){c.loadUserList();c.trackEvent("user","delete")}});a(this).dialog("destroy")}},{text:a("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]}).show()},bindSave:function(){var b=this;a(".map-save").click(function(a){a.preventDefault();b.mapSave()})},mapSave:function(){var b=
!1,c=/[?*:;{}\\ "'\/@#!%\^()<>.]+/g,d="",e=this;a("#mapSave").dialog({autoOpen:!0,height:"175",width:"350",dialogClass:"ui-dialog-title-mapSave",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles span.save").text(),"class":"positive",click:function(){""===a.trim(a(".m-mapSaveTitle").val())&&(b=!0);b?a(".m-mapSaveTitle").addClass("ui-state-error").keyup(function(){a(this).removeClass("ui-state-error")}):(a('input[name="save[title]"]').val(a(".m-mapSaveTitle").val()),
a.each(["factor","filetype"],function(){a('input[name="download_'+this+'"]').val(a('input[name="download-'+this+'"]:checked').val())}),a('input[name="grid_space"]').val(a('input[name="gridspace"]:checked').val()),e.setFormOptions(),e.showSpinner(),void 0===e.vars.jcropAPI&&a("#bbox_rubberband").val(""),a.ajax({type:"POST",url:e.settings.baseUrl+"/usermap/",data:a("form").serialize(),dataType:"json",success:function(b){a("#mapTitle").text(a(".m-mapSaveTitle").val());d=a(".m-mapSaveTitle").val().replace(c,
"_");a("#file-name").val(d);e.activateEmbed(b.mid);e.loadMapList();e.hideSpinner();e.trackEvent("map","save")}}),a(this).dialog("destroy"))}},{text:a("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]})},bindDownload:function(){var b=this;a(".map-download").click(function(a){a.preventDefault();b.mapDownload()})},mapDownload:function(){var b=this;a("#mapExport").dialog({autoOpen:!0,width:"620",dialogClass:"ui-dialog-title-mapExport",modal:!0,
closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:a("#button-titles span.download").text(),"class":"positive",click:function(){b.generateDownload()}},{text:a("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){a(this).dialog("destroy")}}]})},bindSubmit:function(){var b=this,c="",d=!1;a(".submitForm").click(function(e){e.preventDefault();d=!1;a(".m-mapCoord").each(function(){c=a(this).parents(".ui-accordion-content").find(".m-mapTitle").keyup(function(){d=!1;a(this).removeClass("ui-state-error")});
a(this).val()&&""===a(c).val()&&(d=!0,a(c).addClass("ui-state-error"))});d?b.showMessage(a("#mapper-missing-legend").text()):(b.destroyRedo(),b.showMap(),b.tabSelector(0))})},mapToggleSettings:function(){a("#mapToolsCollapse a").trigger("click")},bindPanelToggle:function(){var b=this;a("#mapToolsCollapse a").tipsy({gravity:"e"}).toggleClick(function(c){c.preventDefault();a("#mapOutputImage").attr("width",0).attr("height",0);a("#mapOutputScale").hide();a(this).parent().addClass("mapTools-collapsed");
a("#mapTools").hide("slide",{direction:"right"},250,function(){var c=0.98*a(h).width();a("#actionsBar").animate({width:c},250);a("#map").animate({width:c},250,function(){a('input[name="width"]').val(c);b.mapRefresh()})})},function(c){c.preventDefault();a("#mapOutputImage").attr("width",0).attr("height",0);a("#mapOutputScale").hide();a(this).parent().removeClass("mapTools-collapsed");a("#mapTools").show("slide",{direction:"right"},250,function(){a("#actionsBar").animate({width:"810px"},250);a("#map").animate({width:"800px"},
function(){a('input[name="width"]').val(800);b.mapRefresh()})})})},showMessage:function(b){a("#mapper-message").html(b).dialog({autoOpen:!0,height:"200",width:"400",dialogClass:"ui-dialog-title-mapper-message",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]}).show()},drawLegend:function(){var b=a("#legend_url").val(),c=a("#mapLegend");b?c.html('<img src="'+b+'" />'):c.html("<p><em>"+a("#mapper-legend-message").text()+
"</em></p>")},drawScalebar:function(){a("#mapScale img").attr("src",a("#scalebar_url").val()).show()},showBadPoints:function(){var b=a("#bad_points").val();b&&(a("#badRecords").html(b),a("#badRecordsWarning").show())},showSpinner:function(){a(".mapper-loading-spinner").show()},hideSpinner:function(){a(".mapper-loading-spinner").hide()},showErrorMessage:function(b){b='<span class="mapper-message-error ui-corner-all ui-widget-content">'+b+"</span>";a("#mapOutput").append(b)},hideErrorMessage:function(){a("#mapOutput .mapper-message-error").remove()},
showMap:function(b){var c=(new Date).getTime(),d="",e={};this.destroyJcrop();a("#output").val("pnga");a("#badRecordsWarning").hide();a("#download_token").val(c);this.showSpinner();d=a("form").serialize();e=a("form").serializeJSON();this.postData(d,b);a.jStorage.set("do-"+c.toString(),e);this.toggleUndo(!0)},postData:function(b,c){var d=this;d.hideErrorMessage();a.ajax({type:"POST",url:d.settings.baseUrl+"/application/",data:b,dataType:"json",timeout:3E4,success:function(a){d.resetFormValues(a);d.resetJbbox();
d.drawMap(a,c);d.drawLegend();d.drawScalebar();d.showBadPoints();d.addBadRecordsViewer()},error:function(b,c,g){"timeout"===c&&(d.showErrorMessage(a("#mapper-loading-error-message").text()),d.hideSpinner())}})},resetFormValues:function(b){a("#mapOutput input").each(function(){a(this).val("")});a.each("rendered_bbox rendered_rotation rendered_projection legend_url scalebar_url bad_points".split(" "),function(){a("#"+this).val(b[this])});a("#bbox_map").val(a("#rendered_bbox").val());a("#projection_map").val(a("#rendered_projection").val());
a("#rotation").val(a("#rendered_rotation").val());a("#pan").val("")},drawMap:function(b,c){var d=this;a("#mapOutputImage").attr("width",b.size[0]).attr("height",b.size[1]).attr("src",b.mapOutputImage).one("load",function(){c||(c={map:{bbox_rubberband:""}});d.loadCropSettings(c);d.hideSpinner()})},addBadRecordsViewer:function(){var b=this;a("#badRecordsViewer").dialog({autoOpen:!1,height:"200",width:"500",dialogClass:"ui-dialog-title-badRecordsViewer",position:[200,200],modal:!0,closeOnEscape:!1,draggable:!0,
resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]});a(".toolsBadRecords").click(function(c){c.preventDefault();b.addBadRecordsViewer();a("#badRecordsViewer").dialog("open")})},generateDownload:function(){var b=this,c=a("#file-name").val(),d=(new Date).getTime().toString(),e="",f="",g="png",c=c.replace(/[~$?*,:;{}\[\]\\ "'\/@#!%\^()<>.+=|`&]+/g,"_");a("#file-name").val(c);a('input[name="file_name"]').val(c);a('input[name="download_factor"]').val(a('input[name="download-factor"]:checked').val());
g=a("input[name='download-filetype']:checked").val();b.setFormOptions();a("#download_token").val(d);a.each(["ui-dialog-buttonpane","download-dialog"],function(){a("."+this).hide()});a(".download-message").show();switch(g){case "pptx":a("#output").val("pptx");b.vars.jcropAPI?a("#crop").val(1):b.resetJbbox();f=a("form").serialize();a("body").download("/pptx/"+b.getLanguage(),f,"post");a("#output").val("pnga");break;case "docx":a("#output").val("docx");b.vars.jcropAPI?a("#crop").val(1):b.resetJbbox();
f=a("form").serialize();a("body").download("/docx/"+b.getLanguage(),f,"post");a("#output").val("pnga");break;case "kml":f=a("form").serialize();a("body").download("/kml/",f,"post");break;default:a("#download").val(1),a("#output").val(g),b.vars.jcropAPI?a("#crop").val(1):b.resetJbbox(),f=a("form").serialize(),a("body").download("/application/",f,"post"),a("#download").val(""),a("#output").val("pnga")}b.vars.fileDownloadTimer=h.setInterval(function(){e=a.cookie("fileDownloadToken");e===d&&b.finishDownload()},
1E3);b.trackEvent("download",g)},setFormOptions:function(){a.each(["border","legend","scalebar","scalelinethickness"],function(){a("#"+this).prop("checked")?a('input[name="options['+this+']"]').val(1):a('input[name="options['+this+']"]').val("")})},finishDownload:function(){a(".download-message").hide();a.each(["download-dialog","ui-dialog-buttonpane"],function(){a("."+this).show()});h.clearInterval(this.vars.fileDownloadTimer);a.cookie("fileDownloadToken",null)},showExamples:function(){a("#mapper-message-help").html('<img src="public/images/help-data.png" alt="" />').dialog({height:"355",
width:"525",dialogClass:"ui-dialog-title-mapper-message-help",autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]}).show()},showCodes:function(){var b=this.getParameterByName("locale")?{locale:this.getParameterByName("locale")}:{};a("#mapper-message-codes").dialog({height:"450",width:"850",dialogClass:"ui-dialog-title-mapper-message-codes",autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,
buttons:[{text:"OK","class":"positive",click:function(){a(this).dialog("destroy")}}]}).show();this.loadCodes(a("#mapper-message-codes"),b)},loadCodes:function(b,c){var d=this,e="";b.find("tbody tr td").text("\u00a0");b.find("tbody tr td:first").text("\u00a0\u00a0\u00a0").addClass("loading");a.ajax({type:"GET",url:d.settings.baseUrl+"/places/",data:c,dataType:"html",success:function(a){b.html(a);e=b.find(".filter-countries");e.val("");void 0!==c.filter&&e.val(c.filter);e.keypress(function(a){var f=
a.keyCode||a.which;if(13===f||9===f)a.preventDefault(),c.filter=e.val(),d.loadCodes(b,c)});e.blur(function(){c.filter=e.val();d.loadCodes(b,c)})}})},performRotation:function(b){a("#rotation").val(a(b).attr("data-rotate"));this.resetJbbox();this.destroyRedo();this.showMap();this.trackEvent("rotate",a(b).attr("data-rotate"))},setRotation:function(b){var c=a("#mapControls"),d=a(".thumb",c),e=a(".overview",c).children(),f=0,g=f=0;b||(b=0);b=0>parseFloat(b)?parseFloat(b)+360:parseFloat(b);f=b*(Math.PI/
180);a(".overview",c).css("left",-(b/360*e.outerWidth(!0)*e.length)+"px");g=Math.round(28*-Math.cos(f)+(c.outerHeight()/2-d.outerHeight()/2))+"px";f=Math.round(28*Math.sin(f)+(c.outerWidth()/2-d.outerWidth()/2))+"px";a(".thumb",c).css("top",g).css("left",f)},getParameterByName:function(a){a="[\\?&]"+a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")+"=([^&#]*)";a=RegExp(a).exec(h.location.href);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},mapCircleSlider:function(){for(var a=0,c="",
a=0;360>a;a+=1)0===a%5&&(c+='<li data-rotate="'+a+'"></li>');return c},clearStorage:function(){this.destroyRedo();a.jStorage.flush()},bindStorage:function(){var b={},c=(new Date).getTime();this.clearStorage();b=a("form").serializeJSON();a.jStorage.set("do-"+c.toString(),b)},bindRotateWheel:function(){var b=this;a(".overlay","#mapControls").css("background-image",'url("public/images/bg-rotatescroll.png")');a(".overview","#mapControls").append(b.mapCircleSlider());a("#mapControls").tinycircleslider({snaptodots:!0,
radius:28,callback:function(c,d){a(".mapper-loading-spinner").is(":hidden")&&b.performRotation(c)}})},bindTabs:function(){var b=a("#tabs"),c="";a("#mapTools").tabs({selected:0});b.tabs({cache:!0,load:function(b,c){a(c.tab).data("cache.tabs",""===a(c.panel).html()?!1:!0)},event:"change"}).find(".ui-state-disabled").each(function(){a(this).removeClass("ui-state-disabled")}).end().show();b.find("ul.navigation a").click(function(){var b={},e=a(this).parent().prevAll().length;b.tabs=e;a.bbq.pushState(b);
a.each(a("#site-languages a"),function(){c=a(this).attr("href").split("#")[0];a(this).attr("href",c+"#tabs="+e)})});a(h).bind("hashchange",function(d){var e=a.bbq.getState("tabs",!0)||0;b.find("ul.navigation a").eq(e).triggerHandler("change");a.each(a("#site-languages a"),function(){c=a(this).attr("href").split("#")[0];a(this).attr("href",c+"#tabs="+e)})});a(h).trigger("hashchange")},screenSizeListener:function(){var b=this;a(h).resize(function(){var c=b.getPageSize(),d=b.getPageScroll();a("#mapper-overlay").css({width:c[0],
height:c[1]});a("#mapper-message").css({top:d[1]+c[3]/10,left:d[0],position:"fixed",zIndex:1001,margin:"0px auto",width:"100%"})})},init:function(){var b=this;this.screenSizeListener();this.bindRotateWheel();this.hideSpinner();a("#header>div").show();this.bindTabs();a("#mapOutput").append('<img id="mapOutputImage" src="public/images/basemap.png" alt="" width="800" height="400" />').find("span.mapper-loading-message").remove();a("#mapScale").append('<img id="mapOutputScale" src="public/images/basemap-scalebar.png" width="200" height="27" />');
a("a.login","#site-session").click(function(a){a.preventDefault();b.tabSelector(3)});a("a.show-examples").click(function(a){a.preventDefault();b.showExamples()});a("a.show-codes").click(function(a){a.preventDefault();b.showCodes()});a(".fieldSets").accordion({header:"h3",collapsible:!0,autoHeight:!1});a(".tooltip").tipsy({gravity:"s"});this.bindStorage();this.bindHotkeys();this.bindToolbar();this.bindArrows();this.bindSettings();this.bindSlider();this.bindColorPickers();this.bindAddButtons();this.bindClearButtons();
this.bindAutocomplete();this.bindSave();this.bindDownload();this.bindSubmit();this.bindPanelToggle();a(".toolsUndoDisabled").click(!1);a(".toolsRedoDisabled").click(!1);a("textarea.resizable:not(.textarea-processed)").TextAreaResizer();0<a("#usermaps").length&&(this.loadMapList(),this.tabSelector(3));0<a("#userdata").length&&(this.loadUserList(),this.tabSelector(4));a("input").keypress(function(a){if(13===a.which)return!1})}};return{init:function(b){a.extend(n.settings,b);n.init()},getParameterByName:function(a){n.getParameterByName(a)},
loadCodes:function(a,c){n.loadCodes(a,c)}}}(jQuery,window,document);
