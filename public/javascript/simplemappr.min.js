/*
 2010-2017 David P. Shorthouse
 @link      http://github.com/dshorthouse/SimpleMappr
 @license   MIT, https://github.com/dshorthouse/SimpleMappr/blob/master/LICENSE

 MIT LICENSE

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/
var SimpleMappr=function(b,l,h){var m={settings:{baseUrl:"",active:!1,maxTextareaCount:10,undoSize:10},vars:{newPointCount:0,newRegionCount:0,newWKTCount:0,zoom:!0,fileDownloadTimer:{},fillColor:"",jCropType:"zoom",cropUpdated:!1,origins:{"esri:102009":-96,"esri:102015":-60,"esri:102014":10,"esri:102012":105,"esri:102024":25,"epsg:3112":134},spinner:b("#map-loader").find("span.mapper-loading-spinner"),fieldSetsPoints:b("#fieldSetsPoints"),fieldSetsRegions:b("#fieldSetsRegions"),fieldSetsWKT:b("#fieldSetsWKT"),
mapOutput:b("#mapOutput"),mapOutputImage:b("#mapOutputImage")},trackEvent:function(a,b){"function"===typeof ga&&ga("send","event",a,b)},getPageSize:function(){var a,b,d,e;l.innerHeight&&l.scrollMaxY?(a=l.innerWidth+l.scrollMaxX,b=l.innerHeight+l.scrollMaxY):h.body.scrollHeight>h.body.offsetHeight?(a=h.body.scrollWidth,b=h.body.scrollHeight):(a=h.body.offsetWidth,b=h.body.offsetHeight);self.innerHeight?(d=h.documentElement.clientWidth?h.documentElement.clientWidth:self.innerWidth,e=self.innerHeight):
h.documentElement&&h.documentElement.clientHeight?(d=h.documentElement.clientWidth,e=h.documentElement.clientHeight):h.body&&(d=h.body.clientWidth,e=h.body.clientHeight);return[a<d?a:d,b<e?e:b,d,e]},getPageScroll:function(){var a,b;self.pageYOffset?(b=self.pageYOffset,a=self.pageXOffset):h.documentElement&&h.documentElement.scrollTop?(b=h.documentElement.scrollTop,a=h.documentElement.scrollLeft):h.body&&(b=h.body.scrollTop,a=h.body.scrollLeft);return[a,b]},showCoords:function(a){var c=this,d=parseFloat(a.x),
e=parseFloat(a.y),f=parseFloat(a.x2),g=parseFloat(a.y2),k=parseFloat(a.w);a=parseFloat(a.h);var n={x:d,y:e},q={x:f,y:g},h={},p={},l=b("#mapExport").find('input[name="download-factor"]:checked').val();switch(this.vars.jCropType){case "crop":c.vars.mapOutput.find("div.jcrop-holder div:first").css({backgroundColor:"white"});b("#bbox_rubberband").val(d+","+e+","+f+","+g);"epsg:4326"===b("#projection option:selected").val()?c.vars.mapOutput.find("input.jcrop-coord").css({width:"100px"}):c.vars.mapOutput.find("input.jcrop-coord").css({width:"175px"});
0===b("#jcrop-coord-ul").length&&0===b("#jcrop-coord-lr").length&&c.vars.mapOutput.find("div.jcrop-tracker").eq(0).after('<input type="text" id="jcrop-coord-ul" class="jcrop-coord"></input>').after('<input type="text" id="jcrop-coord-lr" class="jcrop-coord"></input>').after('<div id="jcrop-dimension-wrapper"><input type="text" id="jcrop-dimension-w" class="jcrop-dimension"></input>X<input type="text" id="jcrop-dimension-h" class="jcrop-dimension"></input></div>');h=c.pix2geo(n);p=c.pix2geo(q);b("#jcrop-coord-ul").val(h.x+
", "+h.y);b("#jcrop-coord-lr").val(p.x+", "+p.y);b("#jcrop-dimension-w").val(k);b("#jcrop-dimension-h").val(a);b("#jcrop-dimension-wrapper").css({left:k/2-b("#jcrop-dimension-wrapper").width()/2,top:a/2-b("#jcrop-dimension-wrapper").height()/2});b.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+b("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+b("#jcrop-coord-lr").val()+'" }');c.vars.mapOutput.on("blur","input.jcrop-coord",function(){c.vars.cropUpdated||(c.vars.cropUpdated=c.updateCropCoordinates())}).on("keypress",
"input.jcrop-coord",function(a){var b=a.keyCode||a.which;if(13===b||9===b)a.preventDefault(),c.vars.cropUpdated=!1,this.blur()}).on("blur","input.jcrop-dimension",function(){c.vars.cropUpdated||(c.vars.cropUpdated=c.updateCropDimensions())}).on("keypress","input.jcrop-dimension",function(a){var b=a.keyCode||a.which;if(13===b||9===b)a.preventDefault(),c.vars.cropUpdated=!1,this.blur()});b("#scale-measure").find("span").text(l*k+" X "+l*a).parent().show();break;case "zoom":c.vars.mapOutput.find("div.jcrop-holder div:first").css({backgroundColor:"white"});
b("#bbox_rubberband").val(d+","+e+","+f+","+g);break;case "query":b("#bbox_query").val(d+","+e+","+f+","+g)}},updateCropDimensions:function(){var a=b("#bbox_rubberband").val().split(","),c=parseFloat(a[2])-parseFloat(a[0]),d=parseFloat(a[3])-parseFloat(a[1]),e=this.vars.mapOutputImage.width(),f=this.vars.mapOutputImage.height(),g=b("#jcrop-dimension-w").val(),k=b("#jcrop-dimension-h").val(),n,g=g>e?e:(c-g)/2,k=k>f?f:(d-k)/2,c=parseFloat(a[2])-g,d=parseFloat(a[0])+g;n=parseFloat(a[1])+k;a=parseFloat(a[3])-
k;g>=e&&(c=0,d=e);k>=f&&(n=0,a=f);this.loadCropSettings({map:{bbox_rubberband:c.toString()+","+n.toString()+","+d.toString()+","+a.toString()}});return!0},updateCropCoordinates:function(){var a=b("#jcrop-coord-ul").val(),c=a.split(","),c=this.geo2pix({x:b.trim(c[0]),y:b.trim(c[1])}),d=b("#jcrop-coord-lr").val(),e=d.split(","),e=this.geo2pix({x:b.trim(e[0]),y:b.trim(e[1])});b.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+a+'", "jcrop_coord_lr" : "'+d+'" }');this.loadCropSettings({map:{bbox_rubberband:e.x+
","+e.y+","+c.x+","+c.y}});return!0},pix2geo:function(a){var c,d,e=b("#bbox_map").val(),f=parseFloat(this.vars.mapOutputImage.width()),g=parseFloat(this.vars.mapOutputImage.height()),k={};""===e&&(e="-180,-90,180,90");e=e.split(",");c=Math.abs(parseFloat(b.trim(e[2]))-parseFloat(b.trim(e[0])));d=Math.abs(parseFloat(b.trim(e[3]))-parseFloat(b.trim(e[1])));k.x=this.roundNumber(parseFloat(e[0])+parseFloat(a.x)*c/f,2);k.y=this.roundNumber(parseFloat(e[1])+parseFloat(g-parseFloat(a.y))*d/g,2);return k},
geo2pix:function(a){var c,d,e=b("#bbox_map").val(),f={};""===e&&(e="-180,-90,180,90");e=e.split(",");c=Math.abs(parseFloat(b.trim(e[2]))-parseFloat(b.trim(e[0])));d=Math.abs(parseFloat(b.trim(e[3]))-parseFloat(b.trim(e[1])));f.x=this.vars.mapOutputImage.width()*Math.abs(parseFloat(a.x)-parseFloat(b.trim(e[0])))/c;f.y=this.vars.mapOutputImage.height()*(d-Math.abs(parseFloat(a.y)-parseFloat(b.trim(e[1]))))/d;return f},roundNumber:function(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)},tabSelector:function(a){var c=
{};b("#tabs").tabs("enable",a);c.tabs=a;b.bbq.pushState(c)},RGBtoHex:function(a,b,d){return this.toHex(a)+this.toHex(b)+this.toHex(d)},toHex:function(a){if(null===a)return"00";a=parseInt(a,10);if(0===a||isNaN(a))return"00";a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)},bindToolbar:function(){var a=this,c="";b("#actionsBar").find("li").hover(function(){b(this).toggleClass("ui-state-hover")}).end().find("a.toolsQuery").ColorPicker({onBeforeShow:function(){b(this).ColorPickerSetColor(a.RGBtoHex(150,
150,150))},onShow:function(c){b(c).show();a.destroyJcrop();return!1},onHide:function(a){b(a).hide();return!1},onSubmit:function(c,e,f,g){a.unusedVariables(c,e);b(g).ColorPickerHide();a.vars.fillColor=f;a.initJquery();a.vars.zoom=!1}}).end().on("click","a",function(d){d.preventDefault();if(!a.missingFieldSetTitle()){c=b(this).attr("class").match(/tools([\w\W]+)/)[1].toLowerCase();switch(c){case "zoomin":a.mapZoom("in");break;case "zoomout":a.mapZoom("out");break;case "crop":a.mapCrop();break;case "query":a.resetJbbox();
break;case "new":a.mapNew();break;case "refresh":a.mapRefresh();break;case "rebuild":a.mapRebuild();break;case "save":a.mapSave();break;case "download":a.mapDownload()}a.trackEvent("toolbar",c)}})},mapCrop:function(){var a,c;b.cookie("jcrop_coords")?(a=b.parseJSON(b.cookie("jcrop_coords")),c=a.jcrop_coord_ul.split(","),a=a.jcrop_coord_lr.split(","),c=this.geo2pix({x:b.trim(c[0]),y:b.trim(c[1])}),a=this.geo2pix({x:b.trim(a[0]),y:b.trim(a[1])}),this.loadCropSettings({map:{bbox_rubberband:a.x+","+a.y+
","+c.x+","+c.y}})):this.initJcrop();this.vars.zoom=!1},resetAndBuild:function(){this.resetJbbox();this.destroyRedo();this.showMap()},mapNew:function(){var a=this;b("#mapOptions").find("input").prop("checked",!1);b("#countries").prop("checked",!0);b("#gridspace").prop("checked",!0);b("#mapTitle").html("");b("#m-mapSaveTitle").val("");b("#file-name").val("");b("#actionsBar").find("a.toolsEmbed").css({display:"none"});b("#border_thickness").val(1.25);b("#border-slider").slider({value:1.25});b("#clearLayers, #clearRegions, #clearWKT").each(function(){a.clearZone(b(this).parent().prev().prev().children())});
this.resetJbbox();this.mapRebuild()},mapRefresh:function(){this.resetAndBuild();this.tabSelector(0)},mapRebuild:function(){var a=this;b.each(["bbox_map","projection_map","bbox_rubberband","rotation","pan"],function(c,d){a.unusedVariables(c);b("#"+d).val("")});this.setRotation();b("#projection")[0].selectedIndex=0;this.destroyRedo();this.showMap()},bindArrows:function(){var a=this;b("#wheel-overlay").on("click","a.arrows",function(c){c.preventDefault();b("#pan").val(b(this).attr("data-pan"));a.resetJbbox();
a.showMap();a.trackEvent("arrows",b(this).attr("data-pan"))})},mapPan:function(a){b("#pan").val(a);this.resetAndBuild()},mapList:function(){this.tabSelector(4)},mapZoom:function(a){switch(a){case "in":this.initJzoom();this.vars.zoom=!0;break;case "in-auto":a=b("#zoom_in");this.resetJbbox();a.val(1);this.destroyRedo();this.showMap();a.val("");break;case "out":a=b("#zoom_out"),this.resetJbbox(),a.val(1),this.destroyRedo(),this.showMap(),a.val("")}},storageType:function(a){var c=0,d=this;return c=b.grep(b.jStorage.index(),
function(b,c){d.unusedVariables(c);return b.substring(0,a.length)===a})},toggleUndo:function(a){var c=this,d=this.storageType("do"),e=b("#actionsBar");e.find("a.toolsUndo").removeClass("toolsUndo").addClass("toolsUndoDisabled").off("click");a&&1<d.length&&(d.length>c.settings.undoSize&&b.jStorage.deleteKey(d.shift()),e.find("a.toolsUndoDisabled").addClass("toolsUndo").removeClass("toolsUndoDisabled").on("click",function(a){a.preventDefault();c.mapUndo();c.trackEvent("edit","undo")}))},toggleRedo:function(a){var c=
this,d=b("#actionsBar");d.find("a.toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").off("click");if(a)d.find("a.toolsRedoDisabled").addClass("toolsRedo").removeClass("toolsRedoDisabled").on("click",function(a){a.preventDefault();c.mapRedo();c.trackEvent("edit","redo")})},destroyRedo:function(){var a=this.storageType("undo"),c=b("#actionsBar");0<a.length&&(c.find("a.toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").off("click"),b.jStorage.deleteKey(a.pop()))},mapUndo:function(){var a=
this.storageType("do"),c,d,e,f;1!==a.length&&(this.destroyRedo(),c=a[a.length-1],d=b.jStorage.get(c),e=a[a.length-2],e=b.jStorage.get(e),f=this.prepareInputs(e),this.loadInputs(f),b.jStorage.deleteKey(c),b.jStorage.set("un"+c,d),e.width!==d.width?this.mapToggleSettings():(this.showSpinner(),this.postData(decodeURIComponent(b.param(e)),null)),this.toggleRedo(!0),2===a.length&&this.toggleUndo())},mapRedo:function(){var a=this.storageType("undo"),c,d;d=this.storageType("do");var e,f=(new Date).getTime();
0!==a.length&&(this.toggleRedo(),a=a.pop(),c=b.jStorage.get(a),d=d[d.length-1],e=b.jStorage.get(d),d=this.prepareInputs(c),this.loadInputs(d),b.jStorage.deleteKey(a),b.jStorage.set("do-"+f.toString(),c),c.width!==e.width?this.mapToggleSettings():(this.showSpinner(),this.postData(decodeURIComponent(b.param(c)),null)),this.toggleUndo(!0))},bindHotkeys:function(){var a=this,c,d,e={"ctrl+s":a.bindCallback(a,a.mapSave),"ctrl+d":a.bindCallback(a,a.mapDownload),"ctrl+l":a.bindCallback(a,a.mapList),"ctrl+n":a.bindCallback(a,
a.mapNew),"ctrl+r":a.bindCallback(a,a.mapRefresh),"ctrl+b":a.bindCallback(a,a.mapRebuild),"ctrl+x":a.bindCallback(a,a.mapCrop),"ctrl+e":a.bindCallback(a,a.mapToggleSettings),esc:a.bindCallback(a,a.destroyJcrop),"ctrl+z":a.bindCallback(a,a.mapUndo),"ctrl+y":a.bindCallback(a,a.mapRedo),"-":a.bindCallback(a,a.mapZoom,"out")},f=["=","+","shift+="],g={up:a.bindCallback(a,a.mapPan,"up"),down:a.bindCallback(a,a.mapPan,"down"),left:a.bindCallback(a,a.mapPan,"left"),right:a.bindCallback(a,a.mapPan,"right")};
"false"===a.settings.active&&(delete e["ctrl+s"],delete e["ctrl+l"]);b.each(e,function(a,c){b(h).off("keydown",c).on("keydown",null,a,c)});c=function(){a.dblclickZoom(a.vars.mapOutputImage,d)};this.vars.mapOutput.hover(function(){b.each(g,function(a,c){b(h).on("keydown",null,a,c)});a.vars.mapOutputImage.on("mousemove",function(a){d=a}).on("dblclick",function(b){a.missingFieldSetTitle()||a.dblclickZoom(this,b)});b.each(f,function(a,d){b(h).on("keydown",null,d,c)})},function(){b.each(g,function(c,d){a.unusedVariables(c);
b(h).off("keydown",d)});a.vars.mapOutputImage.off("dblclick");b.each(f,function(a,d){b(h).off("keydown",c)})})},hardResetShowMap:function(a){this.missingFieldSetTitle()?(a.preventDefault(),a.stopPropagation()):(this.resetJbbox(),this.destroyRedo(),this.showMap(),this.trackEvent("options",a.target.name))},bindSettings:function(){var a=this,c=b("#grid");b("#mapOptions").on("click",".layeropt",function(b){a.hardResetShowMap(b)}).on("click",".gridopt",function(b){c.prop("checked")||c.prop("checked",!0);
a.hardResetShowMap(b)}).on("click","#gridlabel",function(b){c.prop("checked")||c.prop("checked",!0);a.hardResetShowMap(b)});b("#projection").on("change",function(c){var e=b("#origin-selector");""!==b(this).val()&&(b("#origin").val(a.vars.origins[b(this).val()]),a.vars.origins.hasOwnProperty(b("#projection").val())?e.show():e.hide(),b.cookie("jcrop_coords",null),a.hardResetShowMap(c))});b("#origin").on("blur",function(b){a.hardResetShowMap(b)}).on("keydown",function(a){a=a.keyCode||a.which;9!==a&&
13!==a||this.blur()});a.toggleFileFactor();b("#mapExport").find("input.download-factor").on("change",function(){a.toggleFileFactor(b(this).val())}).end().find(".download-filetype").on("change",function(){a.toggleFileType(this)})},bindSlider:function(){var a=this;b("#border-slider").slider({value:1.25,min:1,max:2,step:.25,slide:function(c,d){a.unusedVariables(c);if(a.missingFieldSetTitle())return!1;b("#border_thickness").val(d.value);a.destroyRedo();a.showMap();a.trackEvent("slider",d.value)}})},toggleFileFactor:function(a){var c=
b("#bbox_rubberband").val().split(",");a||(a=b("#mapExport").find('input[name="download-factor"]:checked').val());a="crop"===this.vars.jCropType?a*(c[2]-c[0])+" X "+a*(c[3]-c[1]):a*this.vars.mapOutputImage.width()+" X "+a*this.vars.mapOutputImage.height();b("#scale-measure").find("span").text(a).parent().show()},toggleFileType:function(a){var c=this;"download-svg"===b(a).attr("id")||"download-pptx"===b(a).attr("id")||"download-docx"===b(a).attr("id")?(b.each(["legend","scalebar"],function(a,e){c.unusedVariables(a);
b("#"+e).prop("checked",!0).prop("disabled",!0)}),b.each(["border","scalelinethickness"],function(a,e){c.unusedVariables(a);b("#"+e).prop("disabled",!1)})):"download-kml"===b(a).attr("id")?b.each(["legend","scalebar","border","scalelinethickness"],function(a,e){c.unusedVariables(a);b("#"+e).prop("checked",!0).prop("disabled",!0)}):b.each(["border","legend","scalebar","scalelinethickness"],function(a,e){c.unusedVariables(a);b("#"+e).prop("disabled",!1)})},bindColorPickers:function(){var a=this;b.each([this.vars.fieldSetsPoints,
this.vars.fieldSetsRegions,this.vars.fieldSetsWKT],function(){b(this).find("input.colorPicker").ColorPicker({element:b(this),onBeforeShow:function(){var c=b(this).val().split(" ");b(this).ColorPickerSetColor(a.RGBtoHex(c[0],c[1],c[2]))},onHide:function(a){b(a).hide();return!1},onSubmit:function(c,d,e,f){a.unusedVariables(c,d);b(f).val(e.r+" "+e.g+" "+e.b).ColorPickerHide()}}).on("keyup",function(){var c=b(this).val().split(" ");b(this).ColorPickerSetColor(a.RGBtoHex(c[0],c[1],c[2]))})})},bindClearButtons:function(){var a=
this;b("#clearLayers, #clearWKT, #clearRegions").on("click",function(c){c.preventDefault();a.clearZone(b(this).parent().prev().prev().children())});b.each([this.vars.fieldSetsPoints,this.vars.fieldSetsRegions,this.vars.fieldSetsWKT],function(){b(this).on("click","button.clearself",function(c){c.preventDefault();a.clearZone(b(this).parent().parent())})})},clearZone:function(a){var c=this,d=a.find("select.m-mapShape"),e=a.find("select.m-mapSize"),f=a.find("input.colorPicker"),g=a.find("input.m-mapShadow"),
k=a.find("input.m-mapBorder"),h=a.find("input.m-mapHatch");b.each(["input.m-mapTitle","textarea"],function(b,d){c.unusedVariables(b);a.find(d).val("")});0<d.length&&(d[0].selectedIndex=4);0<e.length&&(e[0].selectedIndex=3);0<g.length&&g.prop("checked",!1);0<k.length&&k.prop("checked",!1);0<h.length&&h.prop("checked",!1);b.each(a,function(){b(this).hasClass("fieldset-points")?f.val("0 0 0"):f.val("150 150 150")})},bindAutocomplete:function(){var a=this,c="",d=[];this.vars.fieldSetsRegions.find("textarea").on("keydown",
function(a){a.keyCode===b.ui.keyCode.TAB&&b(this).data("autocomplete").menu.active&&a.preventDefault()}).autocomplete({source:function(c,d){b.getJSON("/places.json?term="+a.extractLast(c.term),{},d)},search:function(){c=a.extractLast(this.value);if(2>c.length)return!1},focus:function(){return!1},select:function(b,c){a.unusedVariables(b);d=a.split(this.value);d.pop();d.push(c.item.value);d.push("");this.value=d.join(", ");return!1}})},split:function(a,b){switch(b){case "[":return a.split(/\]/);default:return a.split(/,\s*/)}},
extractLast:function(a){return this.split(a).pop()},destroyJcrop:function(){var a=this.vars;void 0!==a.jzoomAPI&&a.jzoomAPI.destroy();void 0!==a.jcropAPI&&a.jcropAPI.destroy();void 0!==a.jqueryAPI&&a.jqueryAPI.destroy();this.vars.mapOutputImage.show();this.vars.mapOutput.find("div.jcrop-holder").remove();b("#mapCropMessage").hide();this.toggleFileFactor()},resetJbbox:function(){var a=this;this.vars.jCropType="zoom";b.each(["rubberband","query"],function(c,d){a.unusedVariables(c);b("#bbox_"+d).val("")});
this.toggleFileFactor()},bindCallback:function(a,c){var d=Array.prototype.slice.call(arguments,2);return function(){c.apply(a,b.extend(arguments,d))}},initJcrop:function(a){this.destroyJcrop();this.resetJbbox();this.vars.jCropType="crop";this.vars.jcropAPI=b.Jcrop("#"+this.vars.mapOutputImage.attr("id"),{bgColor:"public/images/basemap.png"===this.vars.mapOutputImage.attr("src")?"grey":"black",bgOpacity:.5,onChange:this.bindCallback(this,this.showCoords),onSelect:this.bindCallback(this,this.showCoords),
setSelect:a});b("#mapCropMessage").show()},initJzoom:function(){var a=this;this.destroyJcrop();this.resetJbbox();this.vars.jCropType="zoom";this.vars.jzoomAPI=b.Jcrop("#"+a.vars.mapOutputImage.attr("id"),{addClass:"customJzoom",bgOpacity:1,bgColor:"white",onChange:a.bindCallback(a,a.showCoords),onSelect:a.bindCallback(a,a.showCoords)});b(".jcrop-tracker").mousedown(function(){a.activateJcrop("zoom")})},initJquery:function(){var a=this;this.destroyJcrop();this.resetJbbox();this.vars.jCropType="query";
this.vars.jqueryAPI=b.Jcrop("#"+a.vars.mapOutputImage.attr("id"),{addClass:"customJzoom",bgOpacity:1,bgColor:"white",onChange:a.bindCallback(a,a.showCoords),onSelect:a.bindCallback(a,a.showCoords)});b(".jcrop-tracker").mousedown(function(){a.activateJcrop("query")})},activateJcrop:function(a){switch(a){case "zoom":b(h).bind("mouseup",this,this.aZoom);break;case "query":b(h).bind("mouseup",this,this.aQuery)}},aZoom:function(a){a=a.data;a.destroyRedo();a.showMap();b(h).unbind("mouseup",a.aZoom)},dblclickZoom:function(a,
c){var d,e;e=b(a).offset();d=c.pageX-e.left;e=c.pageY-e.top;b("#bbox_rubberband").val(d+","+e+","+d+","+e);this.destroyRedo();this.showMap()},aQuery:function(a){var c=a.data,d=c.vars.fillColor.r+" "+c.vars.fillColor.g+" "+c.vars.fillColor.b;a={bbox:b("#rendered_bbox").val(),bbox_query:b("#bbox_query").val(),projection:b("#projection").val(),projection_map:b("#projection_map").val(),origin:b("#origin").val(),qlayer:b("#stateprovinces").prop("checked")?"stateprovinces_polygon":"countries",width:b("#width").val(),
height:b("#height").val()};b(h).unbind("mouseup",c.aQuery);c.destroyJcrop();c.destroyRedo();c.showSpinner();b.ajax({type:"POST",url:c.settings.baseUrl+"/query/",data:a,timeout:3E4,success:function(a){if(0<a.length){var f=a.map(function(a){return a}).join(", ");a=c.vars.fieldSetsRegions.find("div.fieldset-regions");var g=a.length;b.each(a,function(a){a!==g-1||c.vars.fieldSetsRegions.find('button[data-type="regions"]').prop("disabled")||(c.addAccordionPanel("regions"),g+=1);if(""===c.vars.fieldSetsRegions.find('input[name="regions['+
a+'][title]"]').val()||""===c.vars.fieldSetsRegions.find('textarea[name="regions['+a+'][data]"]').val())return c.vars.fieldSetsRegions.find('input[name="regions['+a+'][title]"]').val("Selected Region "+(a+1).toString()),c.vars.fieldSetsRegions.find('input[name="regions['+a+'][color]"]').val(d),c.vars.fieldSetsRegions.find('input[name="regions['+a+'][hatch]"]').prop("checked",!1),c.vars.fieldSetsRegions.find('textarea[name="regions['+a+'][data]"]').val(f),0<a&&c.vars.fieldSetsRegions.accordion({active:a}),
!1});c.showMap()}else c.hideSpinner()},error:function(a,b,d){c.unusedVariables(a,d);"timeout"===b&&c.hideSpinner()}})},textareaCounter:function(a,b){var d=this.vars;switch(b){case "get":switch(a){case "coords":return d.newPointCount;case "regions":return d.newRegionCount;case "wkt":return d.newWKTCount}break;case "increase":switch(a){case "coords":return d.newPointCount+=1,d.newPointCount;case "regions":return d.newRegionCount+=1,d.newRegionCount;case "wkt":return d.newWKTCount+=1,d.newWKTCount}break;
case "decrease":switch(a){case "coords":return--d.newPointCount,d.newPointCount;case "regions":return--d.newRegionCount,d.newRegionCount;case "wkt":return--d.newWKTCount,d.newWKTCount}}},addAccordionPanel:function(a){var c=this,d=c.textareaCounter(a,"get"),e=b("button.addmore[data-type='"+a+"']"),f={},g="coords"===a?"0 0 0":"150 150 150",k=0,h=[];e.attr("data-type")===a&&(d<c.settings.maxTextareaCount&&(e.parent().prev().accordion({active:!1,heightStyle:"content"}),f=e.parent().prev().children("div:last").clone(),
k=parseInt(f.find("h3 a").text().split(" ")[1],10),d=c.textareaCounter(a,"increase"),f.find("h3").attr("id",f.find("h3").attr("id").replace(/(\d+)+/g,k)),f.find("h3 a").text(f.find("h3 a").text().split(" ")[0]+" "+(k+1).toString()),f.find("div").eq(0).attr("id",f.find("div").eq(0).attr("id").replace(/(\d+)+/g,k)),f.find("input.m-mapTitle").attr("name",a+"["+k.toString()+"][title]").val(""),f.find("textarea").attr("name",a+"["+k.toString()+"][data]").removeClass("textarea-processed").val("").each(function(){c.addGrippies(this)}),
f.find("select.m-mapShape").attr("name",a+"["+k.toString()+"][shape]").val("circle"),f.find("select.m-mapSize").attr("name",a+"["+k.toString()+"][size]").val("10"),f.find("input.colorPicker").attr("name",a+"["+k.toString()+"][color]").val(g).ColorPicker({onBeforeShow:function(){g=b(this).val().split(" ");b(this).ColorPickerSetColor(c.RGBtoHex(g[0],g[1],g[2]))},onHide:function(a){b(a).hide();return!1},onSubmit:function(a,d,e,f){c.unusedVariables(a,d);b(f).val(e.r+" "+e.g+" "+e.b);b(f).ColorPickerHide()}}).on("keyup",
function(){g=b(this).val().split(" ");b(this).ColorPickerSetColor(c.RGBtoHex(g[0],g[1],g[2]))}),f.find("input.m-mapShadow").attr("name",a+"["+k.toString()+"][shadow]").prop("checked",!1),f.find("input.m-mapBorder").attr("name",a+"["+k.toString()+"][border]").prop("checked",!1),f.find("input.m-mapHatch").attr("name",a+"["+k.toString()+"][hatch]").prop("checked",!1),h=e.parent().prev().append(f).children("div"),h.each(function(e,g){c.unusedVariables(g);e===h.length-1&&b(this).find("button.removemore").show().on("click",
function(b){b.preventDefault();c.removeAccordionPanel(f,a);d=c.textareaCounter(a,"decrease")}).parent().find("button.clearself").on("click",function(a){a.preventDefault();c.clearZone(b(this))}).parent().parent().find(".ui-icon:last").remove()}),e.parent().prev().accordion("destroy").accordion({header:"h3",collapsible:!0,autoHeight:!1,active:!1,heightStyle:"content"}),"regions"===a&&c.bindAutocomplete()),d>=c.settings.maxTextareaCount-3&&e.prop("disabled",!0))},removeAccordionPanel:function(a,c){var d=
b("button.addmore[data-type='"+c+"']");a.nextAll().each(function(){var a=parseInt(b(this).find("h3 a").text().split(" ")[1],10),d=c+"["+(a-2).toString()+"]";b(this).find("h3 a").text(b(this).find("h3 a").text().split(" ")[0]+" "+(a-1).toString());b(this).find("input.m-mapTitle").attr("name",d+"[title]");b(this).find("textarea").attr("name",d+"[data]");b(this).find("select.m-mapShape").attr("name",d+"[shape]");b(this).find("select.m-mapSize").attr("name",d+"[size]");b(this).find("input.colorPicker").attr("name",
d+"[color]");b(this).find("input.m-mapShadow").attr("name",d+"[shadow]");b(this).find("input.m-mapBorder").attr("name",d+"[border]");b(this).find("input.m-mapHatch").attr("name",d+"[hatch]")});a.remove();d.prop("disabled",!1)},addGrippies:function(a){function c(a){e.height(Math.max(32,f+a.pageY)+"px");return!1}function d(){b(h).unbind("mousemove",c).unbind("mouseup",d);e.css({opacity:1})}var e=b(a).addClass("textarea-processed"),f=null;b(a).parent().find(".grippie").bind("mousedown",function(a){f=
e.height()-a.pageY;e.css({opacity:.25});b(h).bind("mousemove",c).bind("mouseup",d);return!1})},bindAddButtons:function(){var a=this;b("#map-points, #map-regions, #map-wkt").on("click","button.addmore",function(c){var d=b(this).attr("data-type");c.preventDefault();a.addAccordionPanel(d);c=b(this).parent().prev().children().length;b(this).parent().prev().accordion({active:c-1});return!1})},loadMapList:function(a){var c=this,d=a||{},e={};b("#usermaps").html("");c.showSpinner();e={locale:c.getParameterByName("locale"),
search:d.search?encodeURIComponent(d.search.toLowerCase()):null,uid:d.uid||null};d.sort&&(e.sort=d.sort.item,e.dir=d.sort.dir);e.locale||delete e.locale;e.search||delete e.search;e.uid||delete e.uid;b.ajax({type:"GET",url:c.settings.baseUrl+"/usermap/",data:e,dataType:"html",success:function(a){-1!==a.indexOf("session timeout")?l.location.reload():(b("#usermaps").off().html(a).on("click","a.toolsRefresh",function(a){a.preventDefault();c.loadMapList()}).on("click","a.ui-icon-triangle-sort",function(a){a.preventDefault();
e.sort={item:b(this).attr("data-sort"),dir:"asc"};b(this).hasClass("asc")&&(e.sort.dir="desc");c.loadMapList(e);c.trackEvent("maplist","sort")}).on("click","a.map-load",function(a){a.preventDefault();c.loadMap(this);c.trackEvent("map","load")}).on("click","a.map-share",function(a){a.preventDefault();c.shareMap(this,"create",e);c.trackEvent("map","share")}).on("click","a.map-unshare",function(a){a.preventDefault();c.shareMap(this,"destroy",e);c.trackEvent("map","unshare")}).on("click","a.map-delete",
function(a){a.preventDefault();c.deleteMapConfirmation(this)}),b("#filter-mymaps").val(d.search).on("keypress",function(a){var d=a.keyCode||a.which;if(13===d||9===d)a.preventDefault(),e.search=b(this).val(),c.loadMapList(e),c.trackEvent("maplist","filter")}).focus(),c.hideSpinner())}})},loadShareList:function(a){var c=this;a=a||{};var d={};c.showSpinner();d={locale:c.getParameterByName("locale")};a.sort&&(d.sort=a.sort.item,d.dir=a.sort.dir);d.locale||delete d.locale;b.ajax({type:"GET",url:c.settings.baseUrl+
"/share/",data:d,dataType:"html",success:function(a){-1!==a.indexOf("session timeout")?l.location.reload():(b("#sharedmaps").off().html(a).on("click","a.ui-icon-triangle-sort",function(a){a.preventDefault();d.sort={item:b(this).attr("data-sort"),dir:"asc"};b(this).hasClass("asc")&&(d.sort.dir="desc");c.loadShareList(d);c.trackEvent("maplist","sort")}).on("click","a.map-load",function(a){a.preventDefault();c.loadMap(this);c.trackEvent("map","load")}),c.hideSpinner())}})},shareMap:function(a,c,d){var e=
this;a=b(a).attr("data-id");"create"===c?(e.showSpinner(),b.ajax({type:"POST",url:e.settings.baseUrl+"/share/",data:{mid:a},dataType:"json",success:function(){e.loadMapList(d);e.loadShareList();e.hideSpinner()}})):"destroy"===c&&(e.showSpinner(),b.ajax({type:"DELETE",url:e.settings.baseUrl+"/share/"+a,dataType:"json",success:function(){e.loadMapList(d);e.loadShareList();e.hideSpinner()}}))},removeExtraElements:function(){b.each(this.vars.fieldSetsPoints.find(".fieldset-points"),function(a){2<a&&b(this).remove()});
b.each(this.vars.fieldSetsRegions.find(".fieldset-regions"),function(a){2<a&&b(this).remove()});b.each(this.vars.fieldSetsWKT.find(".fieldset-wkt"),function(a){2<a&&b(this).remove()});this.vars.newPointCount=0;this.vars.newRegionCount=0;this.vars.newWKTCount=0},prepareInputs:function(a){var c={},d=[],c={status:"ok",mid:b("#actionsBar").find("a.map-embed").attr("data-id"),map:a};c.map.coords=c.map.coords||[];c.map.regions=c.map.regions||[];c.map.wkt=c.map.wkt||[];c.map.layers=c.map.layers||{};c.map.options=
c.map.options||{};String.prototype.clean=function(){return this.replace(/[\[\]]/g,"")};b.each(a,function(a,b){-1!==a.indexOf("coords[")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(void 0===c.map.coords[parseInt(d[0].clean(),10)]&&(c.map.coords[parseInt(d[0].clean(),10)]={}),c.map.coords[parseInt(d[0].clean(),10)][d[1].clean()]=b,delete c.map["coords"+d[0]+d[1]]);-1!==a.indexOf("regions[")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(void 0===c.map.regions[parseInt(d[0].clean(),10)]&&(c.map.regions[parseInt(d[0].clean(),
10)]={}),c.map.regions[parseInt(d[0].clean(),10)][d[1].clean()]=b,delete c.map["regions"+d[0]+d[1]]);-1!==a.indexOf("wkt[")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(void 0===c.map.wkt[parseInt(d[0].clean(),10)]&&(c.map.wkt[parseInt(d[0].clean(),10)]={}),c.map.wkt[parseInt(d[0].clean(),10)][d[1].clean()]=b,delete c.map["wkt"+d[0]+d[1]]);-1!==a.indexOf("layers[")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&(c.map.layers[d[0].clean()]=b,delete c.map["layers"+d[0]]);-1!==a.indexOf("options[")&&(d=a.match(/\[[A-Za-z0-9]*?\]/g))&&
(c.map.options[d[0].clean()]=b,delete c.map["options"+d[0]]);"save[title]"===a&&(c.map.save={title:b},delete c.map["save[title]"]);"gridspace"===a&&(c.map.grid_space=b);"download-filetype"===a&&(c.map.download_filetype=b);"download-factor"===a&&(c.map.download_factor=b)});return c},loadInputs:function(a){var c=this,d=b("#filter-mymaps").val();this.removeExtraElements();b("#form-mapper").clearForm();b.each(["width","height"],function(a,d){c.unusedVariables(a);b("#"+d).val(b("#"+d).val())});b("#map-points, #map-regions, #map-wkt").find("button.addmore").prop("disabled",
!1);b("#filter-mymaps").val(d);b("#origin-selector").hide();this.loadCoordinates(a);this.loadRegions(a);this.loadWKT(a);this.loadLayers(a);this.loadSettings(a)},loadMap:function(a){var c=this,d=b(a).attr("data-id");this.tabSelector(0);this.showSpinner();b.ajax({type:"GET",url:c.settings.baseUrl+"/usermap/"+d+".json",dataType:"json",timeout:3E4,success:function(a){c.hideSpinner();"ok"===a.status?(c.loadInputs(a),c.showMap(a),c.bindStorage(),c.activateEmbed(d)):c.showErrorMessage(b("#mapper-loading-error-message").text());
c.toggleUndo();c.toggleRedo()},error:function(a,d,g){c.unusedVariables(a,g);"timeout"===d&&c.showErrorMessage(b("#mapper-loading-error-message").text())}})},loadSettings:function(a){var c="",c="",d=this,c=a.map.save.title;b("#save\\[title\\]").val(c);b("#m-mapSaveTitle").val(c);b("#mapTitle").text(c);c=c.replace(/[?*:;{}\\ "']+/g,"_");b("#file-name").val(c);b("#projection").val(a.map.projection);d.vars.origins.hasOwnProperty(b("#projection").val())&&b("#origin-selector").show();b.each(["bbox_map",
"projection_map","rotation","origin"],function(c,f){d.unusedVariables(c);b("#"+f).val(a.map[f])});a.map.origin||b("#origin").val(d.vars.origins[b("#projection").val()]);b("#border_thickness").val(1.25);b("#border-slider").slider({value:1.25});void 0!==a.map.border_thickness&&a.map.border_thickness&&(b("#border_thickness").val(a.map.border_thickness),b("#border-slider").slider({value:a.map.border_thickness}));d.setRotation(a.map.rotation);d.resetJbbox();b.each(["border","legend","scalebar","scalelinethickness"],
function(a,c){d.unusedVariables(a);b("#"+c).prop("checked",!1);b("#options\\["+c+"\\]").val("")});void 0!==a.map.options&&b.each(["border","legend","scalebar","scalelinethickness"],function(c,f){d.unusedVariables(c);a.map.options[f]&&void 0!==a.map.options[f]&&(b("#"+f).prop("checked",!0),b("#options\\["+f+"\\]").val(1))});void 0!==a.map.download_factor&&a.map.download_factor?(b("#download_factor").val(a.map.download_factor),b("#download-factor-"+a.map.download_factor).prop("checked",!0)):b("#download-factor-3").prop("checked",
!0);void 0!==a.map.download_filetype&&a.map.download_filetype?(b("#download_filetype").val(a.map.download_filetype),c=b("#download-"+a.map.download_filetype).prop("checked",!0),d.toggleFileType(c)):b("#download-svg").prop("checked",!0);void 0!==a.map.grid_space&&a.map.grid_space?b("#gridspace-"+a.map.grid_space).prop("checked",!0):b("#gridspace").prop("checked",!0);void 0!==a.map.hide_gridlabel&&a.map.hide_gridlabel?b("#gridlabel").prop("checked",!0):b("#gridlabel").prop("checked",!1)},loadCropSettings:function(a){var b;
a.map.bbox_rubberband?(b=a.map.bbox_rubberband.split(","),this.initJcrop([b[2],b[3],b[0],b[1]]),this.toggleFileFactor(a.map.download_factor)):this.destroyJcrop()},loadShapeSize:function(a,c){var d=this;b.each(["shape","size"],function(b,f){d.unusedVariables(b);c[a].hasOwnProperty(f)&&(""===c[a][f].toString?d.vars.fieldSetsPoints.find('select[name="coords['+a.toString()+"]["+f+']"]')[0].selectedIndex=3:d.vars.fieldSetsPoints.find('select[name="coords['+a.toString()+"]["+f+']"]').val(c[a][f]))})},loadCoordinates:function(a){var c=
this,d=a.map.coords||[],e="",f="",g="",k=!1,h=/[?*{}\\]+/g;if(d.length>c.settings.maxTextareaCount)return c.showTooMuchData(),!1;b.each(d,function(a){2<a&&c.addAccordionPanel("coords");e=d[a].title||"";f=d[a].data.replace(h,"")||"";g=d[a].color||"0 0 0";k=d[a].hasOwnProperty("shadow")?!0:!1;c.vars.fieldSetsPoints.find('input[name="coords['+a.toString()+'][title]"]').val(e);c.vars.fieldSetsPoints.find('textarea[name="coords['+a.toString()+'][data]"]').val(f);c.loadShapeSize(a,d);c.vars.fieldSetsPoints.find('input[name="coords['+
a.toString()+'][color]"]').val(g);c.vars.fieldSetsPoints.find('input[name="coords['+a.toString()+'][shadow]"]').prop("checked",k)});return!0},loadWKT:function(a){var c=this,d=a.map.wkt||[],e="",f="",g="",h=!1,n=!1;b.each(d,function(a){2<a&&c.addAccordionPanel("wkt");e=d[a].title||"";f=d[a].data||"";g=d[a].color||"";d[a].hasOwnProperty("border")&&(h=!0);d[a].hasOwnProperty("hatch")&&(n=!0);c.vars.fieldSetsWKT.find('input[name="wkt['+a.toString()+'][title]"]').val(e);c.vars.fieldSetsWKT.find('textarea[name="wkt['+
a.toString()+'][data]"]').val(f);c.vars.fieldSetsWKT.find('input[name="wkt['+a.toString()+'][color]"]').val(g);c.vars.fieldSetsWKT.find('input[name="wkt['+a.toString()+'][border]"]').prop("checked",h);c.vars.fieldSetsWKT.find('input[name="wkt['+a.toString()+'][hatch]"]').prop("checked",n)})},loadRegions:function(a){var c=this,d=a.map.regions||[],e="",f="",g="",h=!1;b.each(d,function(a){2<a&&c.addAccordionPanel("regions");e=d[a].title||"";f=d[a].data||"";g=d[a].color||"";d[a].hasOwnProperty("hatch")&&
(h=!0);c.vars.fieldSetsRegions.find('input[name="regions['+a.toString()+'][title]"]').val(e);c.vars.fieldSetsRegions.find('textarea[name="regions['+a.toString()+'][data]"]').val(f);c.vars.fieldSetsRegions.find('input[name="regions['+a.toString()+'][color]"]').val(g);c.vars.fieldSetsRegions.find('input[name="regions['+a.toString()+'][hatch]"]').prop("checked",h)})},loadLayers:function(a){var c=this;a.map.layers&&b.each(a.map.layers,function(a,e){c.unusedVariables(e);b("#"+a).prop("checked",!0)})},
activateEmbed:function(a){var c=this,d=["img","kml","svg","json"];b("#actionsBar").find("a.toolsEmbed").attr("data-id",a).css({display:"block"}).on("click",function(e){e.preventDefault();b.each(d,function(d,e){c.unusedVariables(d);"img"===e?b("#embed-"+e).val('<img src="'+c.settings.baseUrl+"/map/"+a+'" alt="" />'):b("#embed-"+e).val(c.settings.baseUrl+"/map/"+a+"."+e)});b("#mapEmbed").find("span.mid").text(a).end().dialog({width:"525",dialogClass:"ui-dialog-title-mapEmbed",autoOpen:!0,modal:!0,closeOnEscape:!0,
draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive ui-button-text-only",click:function(){b(this).dialog("destroy")}}]})})},deleteMapConfirmation:function(a){var c=this,d=b(a).attr("data-id");a="<em>"+b(a).parent().parent().find("td.title").text()+"</em>";b("#mapper-message-delete").find("span").html(a).end().dialog({height:"250",width:"500",dialogClass:"ui-dialog-title-mapper-message-delete",modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:b("#button-titles").find("span.delete").text(),
"class":"negative ui-button-text-only",click:function(){b.ajax({type:"DELETE",url:c.settings.baseUrl+"/usermap/"+d,success:function(){c.loadMapList();c.trackEvent("map","delete")}});b(this).dialog("destroy")}},{text:b("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel ui-button-text-only",click:function(){b(this).dialog("destroy")}}]})},getLanguage:function(){var a="",b=this.getParameterByName("locale");if("fr_FR"===b||"es_ES"===b)a="?locale="+b;return a},mapSave:function(){var a=
!1,c=/[?*:;{}\\ "'\/@#!%\^()<>.]+/g,d=b("#m-mapSaveTitle"),e=this;b("#mapSave").dialog({autoOpen:!0,height:"175",width:"365",dialogClass:"ui-dialog-title-mapSave",modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:b("#button-titles").find("span.save").text(),"class":"positive ui-button-text-only",click:function(){""===b.trim(d.val())&&(a=!0);if(a)d.addClass("ui-state-error").on("keyup",function(){b(this).removeClass("ui-state-error")});else b("#save\\[title\\]").val(d.val()),b.each(["factor",
"filetype"],function(a,c){e.unusedVariables(a);b("#download_"+c).val(b("#mapExport").find('input[name="download-'+c+'"]:checked').val())}),b("#grid_space").val(b("#graticules-selection").find('input[name="gridspace"]:checked').val()),e.setFormOptions(),e.showSpinner(),void 0===e.vars.jcropAPI&&b("#bbox_rubberband").val(""),b.ajax({type:"POST",url:e.settings.baseUrl+"/usermap/",data:b("form").serialize(),dataType:"json",success:function(a){b("#mapTitle").text(d.val());b("#file-name").val(d.val().replace(c,
"_"));e.activateEmbed(a.mid);e.loadMapList();e.hideSpinner();e.trackEvent("map","save")}}),b(this).dialog("destroy")}},{text:b("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel ui-button-text-only",click:function(){b(this).dialog("destroy")}}]})},mapDownload:function(){var a=this;b("#mapExport").dialog({autoOpen:!0,width:"620",dialogClass:"ui-dialog-title-mapExport",modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:b("#button-titles").find("span.download").text(),
"class":"positive ui-button-text-only",click:function(){a.generateDownload()}},{text:b("#button-titles").find("span.cancel").text(),"class":"ui-button-cancel ui-button-text-only",click:function(){b(this).dialog("destroy")}}]})},bindSubmit:function(){var a=this;b("#map-points, #map-regions, #map-wkt").find("button.submitForm").on("click",function(b){b.preventDefault();a.missingFieldSetTitle()||(a.destroyRedo(),a.showMap(),a.tabSelector(0))})},missingFieldSetTitle:function(){var a=this,c=b.makeArray(this.vars.fieldSetsPoints.children()).concat(b.makeArray(this.vars.fieldSetsRegions.children())).concat(b.makeArray(this.vars.fieldSetsWKT.children())),
d="",e=!1,f="",g=1;b.each(c,function(){f=b(this);d=f.find("input.m-mapTitle").on("keyup",function(){b(this).removeClass("ui-state-error")});if(f.find("textarea.m-mapCoord").val()&&""===d.val())return e=!0,d.addClass("ui-state-error"),f.parent().attr("id")===a.vars.fieldSetsWKT.attr("id")&&(g=2),f.parent().attr("id")===a.vars.fieldSetsRegions.attr("id")&&(g=3),a.tabSelector(g),a.showMessage(b("#mapper-missing-legend").text()),!1});return e},mapToggleSettings:function(){b("#mapToolsCollapse").find("a").trigger("click")},
bindPanelToggle:function(){var a=this;b("#mapToolsCollapse").find("a").tipsy({gravity:"e"}).toggleClick(function(c){c.preventDefault();a.missingFieldSetTitle()||(a.vars.mapOutputImage.attr("width",0).attr("height",0).css({width:"0px",height:"0px"}),b("#mapOutputScale").hide(),b(this).parent().addClass("mapTools-collapsed"),b("#mapTools").hide("slide",{direction:"right"},250,function(){var c=.98*b(l).width();b("#actionsBar").animate({width:c},250);b("#map").animate({width:c},250,function(){b("#width").val(c);
a.mapRefresh()})}))},function(c){c.preventDefault();a.missingFieldSetTitle()||(a.vars.mapOutputImage.attr("width",0).attr("height",0).css({width:"0px",height:"0px"}),b("#mapOutputScale").hide(),b(this).parent().removeClass("mapTools-collapsed"),b("#mapTools").show("slide",{direction:"right"},250,function(){b("#actionsBar").animate({width:"910px"},250);b("#map").animate({width:"900px"},250,function(){b("#width").val(900);a.mapRefresh()})}))})},showMessage:function(a){b("#mapper-message").html(a).dialog({autoOpen:!0,
height:"200",width:"400",dialogClass:"ui-dialog-title-mapper-message",modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive ui-button-text-only",click:function(){b(this).dialog("destroy")}}]}).show()},drawLegend:function(){var a=b("#legend_url").val(),c=b("#mapLegend");a?c.html('<img src="'+a+'" />'):c.html("<p><em>"+b("#mapper-legend-message").text()+"</em></p>")},drawScalebar:function(){b("#mapScale").find("img").attr("src",b("#scalebar_url").val()).show()},showBadPoints:function(){var a=
b("#bad_points").val();a&&(b("#badRecords").html(a),b("#badRecordsWarning").show())},showBadDrawings:function(){var a=b("#bad_drawings").val(),c=b("#bad_points").val();a&&(b("#badRecords").html([c,a].filter(String).join("<br />")),b("#badRecordsWarning").show())},showSpinner:function(){this.vars.spinner.show()},hideSpinner:function(){this.vars.spinner.hide()},showErrorMessage:function(a){this.vars.mapOutput.append('<span class="mapper-message-error ui-widget-content">'+a+"</span>")},hideErrorMessage:function(){this.vars.mapOutput.find(".mapper-message-error").remove()},
showMap:function(a){var c=(new Date).getTime(),d,e;this.destroyJcrop();b("#output").val("png");b("#badRecordsWarning").hide();b("#download_token").val(c);this.showSpinner();d=b("form").serialize();e=b("form").serializeJSON();this.postData(d,a);b.jStorage.set("do-"+c.toString(),e);this.toggleUndo(!0)},postData:function(a,c){var d=this;d.hideErrorMessage();b.ajax({type:"POST",url:d.settings.baseUrl+"/application.json",data:a,dataType:"json",timeout:3E4,success:function(a){d.resetFormValues(a);d.resetJbbox();
d.drawMap(a,c);d.drawLegend();d.drawScalebar();d.showBadPoints();d.showBadDrawings();d.addBadRecordsViewer()},error:function(a,c,g){d.unusedVariables(a,g);"timeout"===c&&(d.showErrorMessage(b("#mapper-loading-error-message").text()),d.hideSpinner())}})},resetFormValues:function(a){b.each(this.vars.mapOutput.find("input"),function(){b(this).val("")});b.each("rendered_bbox rendered_rotation rendered_projection legend_url scalebar_url bad_points bad_drawings".split(" "),function(){b("#"+this).val(a[this])});
b("#bbox_map").val(b("#rendered_bbox").val());b("#projection_map").val(b("#rendered_projection").val());b("#rotation").val(b("#rendered_rotation").val());b("#pan").val("")},drawMap:function(a,b){var d=this;this.vars.mapOutputImage.attr("width",a.size[0]).attr("height",a.size[1]).css({width:a.size[0]+"px",height:a.size[1]+"px"}).one("load",function(){b||(b={map:{bbox_rubberband:""}});d.loadCropSettings(b);d.hideSpinner()}).attr("src",a.mapOutputImage)},addBadRecordsViewer:function(){var a=this;b("#badRecordsViewer").dialog({autoOpen:!1,
height:"200",width:"500",dialogClass:"ui-dialog-title-badRecordsViewer",modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive ui-button-text-only",click:function(){b(this).dialog("destroy");b("#badRecords").hide()}}]});b("#badRecordsWarning").find("a.toolsBadRecords").on("click",function(c){c.preventDefault();a.addBadRecordsViewer();b("#badRecordsViewer").dialog("open");b("#badRecords").show()})},generateDownload:function(){var a=this,c=b("#file-name").val(),d=
(new Date).getTime().toString(),e="",f="",g="png",c=c.replace(/[~$?*,:;{}\[\]\\ "'\/@#!%\^()<>.+=|`&]+/g,"_");b("#file-name").val(c);b("#file_name").val(c);b("#download_factor").val(b("#mapExport").find('input[name="download-factor"]:checked').val());g=b("#mapExport").find('input[name="download-filetype"]:checked').val();a.setFormOptions();b("#download_token").val(d);b("#mapExport").find("div.download-dialog").hide().end().next().hide().end().find("div.download-message").show();switch(g){case "pptx":b("#output").val("pptx");
a.vars.jcropAPI?b("#crop").val(1):a.resetJbbox();f=b("form").serialize();b("body").download("/pptx/"+a.getLanguage(),f,"post");b("#output").val("png");break;case "docx":b("#output").val("docx");a.vars.jcropAPI?b("#crop").val(1):a.resetJbbox();f=b("form").serialize();b("body").download("/docx/"+a.getLanguage(),f,"post");b("#output").val("png");break;case "kml":f=b("form").serialize();b("body").download("/kml/",f,"post");break;default:b("#download").val(1),b("#output").val(g),a.vars.jcropAPI?b("#crop").val(1):
a.resetJbbox(),f=b("form").serialize(),b("body").download("/application/",f,"post"),b("#download").val(""),b("#output").val("png")}a.vars.fileDownloadTimer=l.setInterval(function(){e=b.cookie("fileDownloadToken");e===d&&a.finishDownload()},1E3);a.trackEvent("download",g)},setFormOptions:function(){var a=this;b.each(["border","legend","scalebar","scalelinethickness"],function(c,d){a.unusedVariables(c);b("#options\\["+d+"\\]").val("");b("#"+d).prop("checked")&&b("#options\\["+d+"\\]").val(1)})},finishDownload:function(){b("#mapExport").find("div.download-message").hide().end().next().show().end().find("div.download-dialog").show();
l.clearInterval(this.vars.fileDownloadTimer);b.cookie("fileDownloadToken",null)},showExamples:function(){b("#mapper-message-help").html('<img src="public/images/help-data.png" alt="" />').dialog({height:"355",width:"525",dialogClass:"ui-dialog-title-mapper-message-help",autoOpen:!0,modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive ui-button-text-only",click:function(){b(this).dialog("destroy")}}]})},showCodes:function(){var a=this.getParameterByName("locale")?
{locale:this.getParameterByName("locale")}:{},c=b("#mapper-message-codes");c.dialog({height:"450",width:"850",dialogClass:"ui-dialog-title-mapper-message-codes",autoOpen:!0,modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive ui-button-text-only",click:function(){c.find("table").remove();b(this).dialog("destroy")}}]});this.loadCodes(c,a)},loadCodes:function(a,c){var d=this,e="";a.find("tbody tr td").text("\u00a0");a.find("tbody tr td:first").text("\u00a0\u00a0\u00a0").addClass("loading");
b.ajax({type:"GET",url:d.settings.baseUrl+"/places/",data:c,dataType:"html",success:function(b){a.html(b);e=a.find("input.filter-countries");e.val("");void 0!==c.filter&&e.val(c.filter);e.on("keypress",function(b){var f=b.keyCode||b.which;if(13===f||9===f)b.preventDefault(),c.filter=e.val(),d.loadCodes(a,c)}).on("blur",function(){c.filter=e.val();d.loadCodes(a,c)})}})},performRotation:function(a){b("#rotation").val(b(a).attr("data-rotate"));this.resetJbbox();this.destroyRedo();this.showMap();this.trackEvent("rotate",
b(a).attr("data-rotate"))},setRotation:function(a){var c=b("#mapControls"),d=c.find("div.thumb"),e=c.find("ul.overview"),f=e.find("li"),g;a||(a=0);a=0>parseFloat(a)?parseFloat(a)+360:parseFloat(a);g=Math.PI/180*a;e.css({left:-(a/360*f.outerWidth(!0)*f.length)+"px"});a=Math.round(28*-Math.cos(g)+(c.outerHeight()/2-d.outerHeight()/2))+"px";c=Math.round(28*Math.sin(g)+(c.outerWidth()/2-d.outerWidth()/2))+"px";d.css({top:a,left:c})},getParameterByName:function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,
"\\]");a=(new RegExp("[\\?&]"+a+"=([^&#]*)")).exec(l.location.href);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},mapCircleSlider:function(){var a,b="";for(a=0;360>a;a+=5)b+='<li data-rotate="'+a+'"></li>';return b},clearStorage:function(){this.destroyRedo();b.jStorage.flush()},bindStorage:function(){var a,c=(new Date).getTime();this.clearStorage();a=b("form").serializeJSON();b.jStorage.set("do-"+c.toString(),a)},bindRotateWheel:function(){var a=this;b("#mapControls").find("ul.overview").append(a.mapCircleSlider()).end().tinycircleslider({snaptodots:!0,
radius:28,callback:function(c,d){a.unusedVariables(d);b("#map-loader").find("span.mapper-loading-spinner").is(":hidden")&&a.performRotation(c)}})},bindTabs:function(){var a=this,c=b("#tabs");b("#mapTools").tabs({selected:0});c.tabs({cache:!0,beforeLoad:function(c,e){a.unusedVariables(c);b(e.tab).data("cache.tabs")||a.showSpinner()},load:function(c,e){a.unusedVariables(c);b(e.tab).data("cache.tabs",""===b(e.panel).html()?!1:!0);a.hideSpinner()},event:"change"}).find("div.ui-state-disabled").each(function(){b(this).removeClass("ui-state-disabled")}).end().show();
c.on("click","ul.navigation a",function(){var c={},e=b(this).parent().prevAll().length;c.tabs=e;b.bbq.pushState(c);a.adjustLanguageLinks("tabs",e)});b(l).bind("hashchange",function(){var d=b.bbq.getState("tabs",!0)||0;c.find("ul.navigation a").eq(d).triggerHandler("change");a.adjustLanguageLinks("tabs",d)});b(l).trigger("hashchange")},bindUpload:function(){var a=this,c=b("#fileInput"),d,e,f,g;"undefined"===l.FileReader&&b("#upload-panel").remove();c.on("change",function(){d=c[0].files[0];e=/text[\w\W]*?/;
d.type.match(e)?(f=new FileReader,f.onload=function(){a.removeExtraElements();b("#map-points").find("button.addmore").prop("disabled",!1);a.clearZone(b("#clearLayers").parent().prev().prev().children());g=a.loadCoordinates(a.parseFile(f.result));a.vars.fieldSetsPoints.accordion({active:0});g&&(a.destroyRedo(),a.showMap(),a.tabSelector(0))},f.readAsText(d)):a.showUnsupportedFile()})},showUnsupportedFile:function(){b("#badFile").dialog({autoOpen:!0,height:"200",width:"500",dialogClass:"ui-dialog-title-badFile",
modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive ui-button-text-only",click:function(){b(this).dialog("destroy")}}]})},showTooMuchData:function(){b("#tooMuchData").dialog({autoOpen:!0,height:"200",width:"500",dialogClass:"ui-dialog-title-tooMuchData",modal:!0,closeOnEscape:!0,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive ui-button-text-only",click:function(){b(this).dialog("destroy")}}]})},parseFile:function(a){var c,d=this,e={},f=[],g={},
h,l,m=0;-1!==a.indexOf("\t")&&b.extend(g,{delimiter:"\t"});c=Papa.parse(a,g).data;1<c.length&&(h=b("option","select.m-mapShape:first").map(function(){if(!["","plus","cross","asterisk"].includes(b(this).val()))return b(this).val()}),a=c[0],isNaN(a[a.length-1])?(c.shift(),f=b.map(a,function(a,e){l=e>=d.settings.maxTextareaCount?0:h[e];return{title:a,data:b.map(c,function(a){return a[e]}).join("\n"),shape:l}})):(b.each(c,function(a,b){var c=b.shift();d.unusedVariables(a);e.hasOwnProperty(c)||(e[c]=[]);
e[c].push(b.join("\t"))}),b.each(e,function(a,b){l=m>=d.settings.maxTextareaCount?0:h[m];f.push({title:a,data:b.join("\n"),shape:l});m+=1})));return{map:{coords:f}}},adjustLanguageLinks:function(a,c){var d="";b.each(b("#site-languages").find("a"),function(){d=b(this).attr("href").split("#")[0];b(this).attr("href",d+"#"+a+"="+c)})},screenSizeListener:function(){var a=this;b(l).resize(function(){var c=a.getPageSize(),d=a.getPageScroll();b("#mapper-overlay").css({width:c[0],height:c[1]});b("#mapper-message").css({top:d[1]+
c[3]/10,left:d[0],position:"fixed",zIndex:1001,margin:"0px auto",width:"100%"})})},unusedVariables:function(){},bindAccordions:function(){b.each([this.vars.fieldSetsPoints,this.vars.fieldSetsRegions,this.vars.fieldSetsWKT],function(){b(this).accordion({header:"h3",collapsible:!0,heightStyle:"content"})})},bindTextAreaResizers:function(){b.each([this.vars.fieldSetsPoints,this.vars.fieldSetsRegions,this.vars.fieldSetsWKT],function(){b(this).find("textarea.resizable:not(.textarea-processed)").TextAreaResizer()})},
appendDialogs:function(){b("body").append(b("#dialog-template").html())},disableDefaultButtons:function(){b("input").on("keypress",function(a){a=a.keyCode||a.which;if(13===a||9===a)return!1})},bindSpecialClicks:function(){var a=this;b("#site-session").find("a.login").on("click",function(b){b.preventDefault();a.tabSelector(4)});b("#general-points").find("a.show-examples").on("click",function(b){b.preventDefault();a.showExamples()});b("#regions-introduction").find("a.show-codes").on("click",function(b){b.preventDefault();
a.showCodes()});b("#actionsBar").find("a.toolsUndoDisabled").off("click").end().find("a.toolsRedoDisabled").off("click")},bindTooltips:function(){b("#mapWrapper").find("a.tooltip").tipsy({gravity:"s"})},getUserData:function(){0<b("#usermaps").length&&(this.loadMapList(),this.loadShareList(),this.tabSelector(4))},init:function(){this.appendDialogs();this.disableDefaultButtons();this.screenSizeListener();this.bindRotateWheel();this.bindTooltips();this.bindTabs();this.bindUpload();this.bindSpecialClicks();
this.bindAccordions();this.bindStorage();this.bindHotkeys();this.bindToolbar();this.bindArrows();this.bindSettings();this.bindSlider();this.bindColorPickers();this.bindAddButtons();this.bindClearButtons();this.bindAutocomplete();this.bindSubmit();this.bindPanelToggle();this.bindTextAreaResizers();this.getUserData();this.hideSpinner()}};return{init:function(a){b.extend(m.settings,a);m.init()},showSpinner:function(){m.showSpinner()},hideSpinner:function(){m.hideSpinner()},trackEvent:function(a,b){m.trackEvent(a,
b)},tabSelector:function(a){m.tabSelector(a)},loadCodes:function(a,b){m.loadCodes(a,b)},loadMapList:function(a){m.loadMapList(a)},settings:m.settings}}(jQuery,window,document);
