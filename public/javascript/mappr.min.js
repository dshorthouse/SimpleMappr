/*
 * jQuery SimpleMappr
 */
/*global $, Mappr, jQuery, window, document, self, XMLHttpRequest, alert, encodeURIComponent, _gaq */
var SimpleMappr=SimpleMappr||{settings:{}};
$(function(){"use strict";SimpleMappr={settings:{baseUrl:"",active:!1,maxTextareaCount:10,undoSize:10},vars:{newPointCount:0,newRegionCount:0,zoom:!0,fileDownloadTimer:{},fillColor:"",jCropType:"zoom",cropUpdated:!1,origins:{"esri:102009":-96,"esri:102015":-60,"esri:102014":10,"esri:102012":105,"esri:102024":25,"epsg:3112":134}},trackEvent:function(a,b){void 0!==window._gaq&&_gaq.push(["_trackEvent",a,b])},getPageSize:function(){var a,b,c,d;window.innerHeight&&window.scrollMaxY?(a=window.innerWidth+window.scrollMaxX,
b=window.innerHeight+window.scrollMaxY):document.body.scrollHeight>document.body.offsetHeight?(a=document.body.scrollWidth,b=document.body.scrollHeight):(a=document.body.offsetWidth,b=document.body.offsetHeight);self.innerHeight?(c=document.documentElement.clientWidth?document.documentElement.clientWidth:self.innerWidth,d=self.innerHeight):document.documentElement&&document.documentElement.clientHeight?(c=document.documentElement.clientWidth,d=document.documentElement.clientHeight):document.body&&
(c=document.body.clientWidth,d=document.body.clientHeight);return[a<c?a:c,b<d?d:b,c,d]},getPageScroll:function(){var a,b;self.pageYOffset?(b=self.pageYOffset,a=self.pageXOffset):document.documentElement&&document.documentElement.scrollTop?(b=document.documentElement.scrollTop,a=document.documentElement.scrollLeft):document.body&&(b=document.body.scrollTop,a=document.body.scrollLeft);return[a,b]},showCoords:function(a){var b=this,c=parseFloat(a.x),d=parseFloat(a.y),e=parseFloat(a.x2),f=parseFloat(a.y2),
g=parseFloat(a.w),a=parseFloat(a.h),h={x:c,y:d},k={x:e,y:f},i={},j={},l=$('input[name="download-factor"]:checked').val();switch(this.vars.jCropType){case "crop":$(".jcrop-holder div:first").css("backgroundColor","white");$("#bbox_rubberband").val(c+","+d+","+e+","+f);"epsg:4326"===$("#projection option:selected").val()?$(".jcrop-coord").css("width","100px"):$(".jcrop-coord").css("width","175px");0===$("#jcrop-coord-ul").length&&0===$("#jcrop-coord-lr").length&&$(".jcrop-tracker").eq(0).after('<input type="text" id="jcrop-coord-ul" class="jcrop-coord"></input>').after('<input type="text" id="jcrop-coord-lr" class="jcrop-coord"></input>').after('<div id="jcrop-dimension-wrapper"><input type="text" id="jcrop-dimension-w" class="jcrop-dimension"></input>X<input type="text" id="jcrop-dimension-h" class="jcrop-dimension"></input></div>');
i=b.pix2geo(h);j=b.pix2geo(k);$("#jcrop-coord-ul").val(i.x+", "+i.y);$("#jcrop-coord-lr").val(j.x+", "+j.y);$("#jcrop-dimension-w").val(g);$("#jcrop-dimension-h").val(a);$("#jcrop-dimension-wrapper").css({left:g/2-$("#jcrop-dimension-wrapper").width()/2,top:a/2-$("#jcrop-dimension-wrapper").height()/2});$.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+$("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+$("#jcrop-coord-lr").val()+'" }');$(".jcrop-coord").live("blur",function(){b.vars.cropUpdated||
(b.vars.cropUpdated=b.updateCropCoordinates())}).live("keypress",function(a){var c=a.keyCode||a.which;if(13===c||9===c)a.preventDefault(),b.vars.cropUpdated=!1,this.blur()});$(".jcrop-dimension").live("blur",function(){b.vars.cropUpdated||(b.vars.cropUpdated=b.updateCropDimensions())}).live("keypress",function(a){var c=a.keyCode||a.which;if(13===c||9===c)a.preventDefault(),b.vars.cropUpdated=!1,this.blur()});$("span","#scale-measure").text(l*g+" X "+l*a).parent().show();break;case "zoom":$(".jcrop-holder div:first").css("backgroundColor",
"white");$("#bbox_rubberband").val(c+","+d+","+e+","+f);break;case "query":$("#bbox_query").val(c+","+d+","+e+","+f)}},updateCropDimensions:function(){var a=$("#bbox_rubberband").val().split(","),b=parseFloat(a[2])-parseFloat(a[0]),c=parseFloat(a[3])-parseFloat(a[1]),d=$("#mapOutputImage").width(),e=$("#mapOutputImage").height(),f=$("#jcrop-dimension-w").val(),g=$("#jcrop-dimension-h").val(),h=a[0],k=a[2],i=a[1],j=a[3],f=f>d?d:(b-f)/2,g=g>e?e:(c-g)/2,h=parseFloat(a[2])-f,k=parseFloat(a[0])+f,i=parseFloat(a[1])+
g,j=parseFloat(a[3])-g;f>=d&&(h=0,k=d);g>=e&&(i=0,j=e);this.loadCropSettings({map:{bbox_rubberband:h.toString()+","+i.toString()+","+k.toString()+","+j.toString()}});return!0},updateCropCoordinates:function(){var a=[],a={},b=[],b={},a=$("#jcrop-coord-ul").val().split(","),a=this.geo2pix({x:$.trim(a[0]),y:$.trim(a[1])}),b=$("#jcrop-coord-lr").val().split(","),b=this.geo2pix({x:$.trim(b[0]),y:$.trim(b[1])});$.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+$("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+
$("#jcrop-coord-lr").val()+'" }');this.loadCropSettings({map:{bbox_rubberband:b.x+","+b.y+","+a.x+","+a.y}});return!0},pix2geo:function(a){var b=0,c=0,d=$("#bbox_map").val(),e=parseFloat($("#mapOutputImage").width()),f=parseFloat($("#mapOutputImage").height()),g={};""===d&&(d="-180,-90,180,90");d=d.split(",");b=Math.abs(parseFloat($.trim(d[2]))-parseFloat($.trim(d[0])));c=Math.abs(parseFloat($.trim(d[3]))-parseFloat($.trim(d[1])));g.x=this.roundNumber(parseFloat(d[0])+parseFloat(a.x)*b/e,2);g.y=this.roundNumber(parseFloat(d[1])+
parseFloat(f-parseFloat(a.y))*c/f,2);return g},geo2pix:function(a){var b=0,c=0,d=$("#bbox_map").val(),e={};""===d&&(d="-180,-90,180,90");d=d.split(",");b=Math.abs(parseFloat($.trim(d[2]))-parseFloat($.trim(d[0])));c=Math.abs(parseFloat($.trim(d[3]))-parseFloat($.trim(d[1])));e.x=$("#mapOutputImage").width()*Math.abs(parseFloat(a.x)-parseFloat($.trim(d[0])))/b;e.y=$("#mapOutputImage").height()*(c-Math.abs(parseFloat(a.y)-parseFloat($.trim(d[1]))))/c;return e},roundNumber:function(a,b){return Math.round(a*
Math.pow(10,b))/Math.pow(10,b)},tabSelector:function(a){var b={};$("#tabs").tabs("select",a);b.tabs=a;$.bbq.pushState(b)},RGBtoHex:function(a,b,c){return this.toHex(a)+this.toHex(b)+this.toHex(c)},toHex:function(a){if(null===a)return"00";a=parseInt(a,10);if(0===a||isNaN(a))return"00";a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)},bindToolbar:function(){var a=this;$("#actionsBar ul li").hover(function(){$(this).addClass("ui-state-hover")},
function(){$(this).removeClass("ui-state-hover")});$(".toolsZoomIn").click(function(b){b.preventDefault();a.mapZoom("in");a.trackEvent("toolbar","zoomin")});$(".toolsZoomOut").click(function(b){b.preventDefault();a.mapZoom("out");a.trackEvent("toolbar","zoomout")});$(".toolsCrop").click(function(b){b.preventDefault();a.mapCrop();a.trackEvent("toolbar","crop")});$(".toolsQuery").ColorPicker({onBeforeShow:function(){$(this).ColorPickerSetColor(a.RGBtoHex(150,150,150))},onShow:function(b){$(b).show();
a.destroyJcrop();return!1},onHide:function(a){$(a).hide();return!1},onSubmit:function(b,c,d,e){$(e).ColorPickerHide();a.vars.fillColor=d;a.initJquery();a.vars.zoom=!1;a.trackEvent("toolbar","query")}}).click(function(b){b.preventDefault();a.resetJbbox()});$(".toolsRefresh").click(function(b){b.preventDefault();a.mapRefresh();a.trackEvent("toolbar","refresh")});$(".toolsRebuild").click(function(b){b.preventDefault();a.mapRebuild();a.trackEvent("toolbar","rebuild")})},mapCrop:function(){var a={},b=
[],b={},a=[],a={};$.cookie("jcrop_coords")?(a=$.parseJSON($.cookie("jcrop_coords")),b=a.jcrop_coord_ul.split(","),a=a.jcrop_coord_lr.split(","),b=this.geo2pix({x:$.trim(b[0]),y:$.trim(b[1])}),a=this.geo2pix({x:$.trim(a[0]),y:$.trim(a[1])}),this.loadCropSettings({map:{bbox_rubberband:a.x+","+a.y+","+b.x+","+b.y}})):this.initJcrop();self.vars.zoom=!1},resetAndBuild:function(){this.resetJbbox();this.destroyRedo();this.showMap()},mapRefresh:function(){this.resetAndBuild();this.tabSelector(0)},mapRebuild:function(){$.each("bbox_map projection_map bbox_rubberband rotation projection pan".split(" "),
function(){$("#"+this).val("")});this.destroyRedo();this.showMap()},bindArrows:function(){var a=this;$(".arrows").click(function(b){b.preventDefault();$("#pan").val($(this).attr("data-pan"));a.resetJbbox();a.showMap();a.trackEvent("arrows",$(this).attr("data-pan"))})},mapPan:function(a){$("#pan").val(a);this.resetAndBuild()},mapList:function(){this.tabSelector(3)},mapZoom:function(a){"in"===a?(this.initJzoom(),this.vars.zoom=!0):(this.resetJbbox(),$("#zoom_out").val(1),this.destroyRedo(),this.showMap(),
$("#zoom_out").val(""))},storageType:function(a){var b=0;return b=$.grep($.jStorage.index(),function(b){return b.substring(0,a.length)===a})},toggleUndo:function(a){var b=this,c=this.storageType("do");$(".toolsUndo").addClass("toolsUndoDisabled").removeClass("toolsUndo").unbind("click");a&&1<c.length&&(c.length>b.settings.undoSize&&$.jStorage.deleteKey(c.shift()),$(".toolsUndoDisabled").addClass("toolsUndo").removeClass("toolsUndoDisabled").bind("click",function(a){a.preventDefault();b.mapUndo();
b.trackEvent("edit","undo")}))},toggleRedo:function(a){var b=this;$(".toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").unbind("click");a&&$(".toolsRedoDisabled").addClass("toolsRedo").removeClass("toolsRedoDisabled").bind("click",function(a){a.preventDefault();b.mapRedo();b.trackEvent("edit","redo")})},destroyRedo:function(){var a=this.storageType("undo");0<a.length&&($(".toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").unbind("click"),$.jStorage.deleteKey(a.pop()))},
mapUndo:function(){var a=this.storageType("do"),b="",c={},d="",d={},e={};1!==a.length&&(this.destroyRedo(),b=a[a.length-1],c=$.jStorage.get(b),d=a[a.length-2],d=$.jStorage.get(d),e=this.prepareInputs(d),this.loadInputs(e),$.jStorage.deleteKey(b),$.jStorage.set("un"+b,c),d.width!==c.width?this.mapToggleSettings():(this.showSpinner(),this.postData(decodeURIComponent($.param(d)),null)),this.toggleRedo(!0),2===a.length&&this.toggleUndo())},mapRedo:function(){var a=this.storageType("undo"),b="",c={},d=
{},d=this.storageType("do"),e="",e={},f=(new Date).getTime();0!==a.length&&(this.toggleRedo(),b=a.pop(),c=$.jStorage.get(b),e=d[d.length-1],e=$.jStorage.get(e),d=this.prepareInputs(c),this.loadInputs(d),$.jStorage.deleteKey(b),$.jStorage.set("do-"+f.toString(),c),c.width!==e.width?this.mapToggleSettings():(this.showSpinner(),this.postData(decodeURIComponent($.param(c)),null)),this.toggleUndo(!0))},bindHotkeys:function(){var a=this,b={},c={},b={"ctrl+s":a.bindCallback(a,a.mapSave),"ctrl+d":a.bindCallback(a,
a.mapDownload),"ctrl+l":a.bindCallback(a,a.mapList),"ctrl+r":a.bindCallback(a,a.mapRefresh),"ctrl+n":a.bindCallback(a,a.mapRebuild),"ctrl+x":a.bindCallback(a,a.mapCrop),"ctrl+e":a.bindCallback(a,a.mapToggleSettings),"ctrl++":a.bindCallback(a,a.mapZoom,"in"),"ctrl+-":a.bindCallback(a,a.mapZoom,"out"),esc:a.bindCallback(a,a.destroyJcrop),"ctrl+z":a.bindCallback(a,a.mapUndo),"ctrl+y":a.bindCallback(a,a.mapRedo)},c={up:a.bindCallback(a,a.mapPan,"up"),down:a.bindCallback(a,a.mapPan,"down"),left:a.bindCallback(a,
a.mapPan,"left"),right:a.bindCallback(a,a.mapPan,"right")};"false"===a.settings.active&&(delete b["ctrl+s"],delete b["ctrl+l"]);$.each(b,function(a,b){$(document).bind("keydown",a,b)});$("#mapOutput").hover(function(){$.each(c,function(a,b){$(document).bind("keydown",a,b)});$("#mapOutputImage").dblclick(function(b){a.dblclickZoom(this,b)})},function(){$.each(c,function(a,b){$(document).unbind("keydown",b)});$("#mapOutputImage").unbind("dblclick")})},hardResetShowMap:function(){this.resetJbbox();this.destroyRedo();
this.showMap()},bindSettings:function(){var a=this;$(".layeropt").click(function(){a.hardResetShowMap()});$(".gridopt").click(function(){$("#graticules").prop("checked")||$("#graticules").attr("checked",!0);a.hardResetShowMap()});$("#gridlabel").click(function(){$("#graticules").prop("checked")||$("#graticules").attr("checked",!0);$(this).prop("checked")&&$(this).val("false");a.hardResetShowMap()});$("#projection").change(function(){var b=$("#origin-selector");""!==$(this).val()&&($("#origin").val(a.vars.origins[$(this).val()]),
a.vars.origins.hasOwnProperty($("#projection").val())?b.show():b.hide(),$.cookie("jcrop_coords",null),a.hardResetShowMap())});$("#origin").blur(function(){a.hardResetShowMap()}).keydown(function(a){a=a.keyCode||a.which;(9===a||13===a)&&this.blur()});a.toggleFileFactor();$(".download-factor").change(function(){a.toggleFileFactor($(this).val())});$(".download-filetype").change(function(){a.toggleFileType(this)})},bindSlider:function(){var a=this;$("#border-slider").slider({value:1.25,min:1,max:2,step:0.25,
slide:function(b,c){$('input[name="border_thickness"]').val(c.value);a.destroyRedo();a.showMap();a.trackEvent("slider",c.value)}})},toggleFileFactor:function(a){var b="",b=$("#bbox_rubberband").val().split(",");a||(a=$('input[name="download-factor"]:checked').val());b="crop"===this.vars.jCropType?a*(b[2]-b[0])+" X "+a*(b[3]-b[1]):a*$("#mapOutputImage").width()+" X "+a*$("#mapOutputImage").height();$("span","#scale-measure").text(b).parent().show()},toggleFileType:function(a){"download-svg"===$(a).attr("id")||
"download-pptx"===$(a).attr("id")||"download-docx"===$(a).attr("id")?($.each(["legend","scalebar"],function(){$("#"+this).attr("checked",!1).attr("disabled","disabled")}),$.each(["border","scalelinethickness"],function(){$("#"+this).removeAttr("disabled")})):"download-kml"===$(a).attr("id")?$.each(["legend","scalebar","border","scalelinethickness"],function(){$("#"+this).attr("checked",!1).attr("disabled","disabled")}):$.each(["border","legend","scalebar","scalelinethickness"],function(){$("#"+this).removeAttr("disabled")})},
bindColorPickers:function(){var a=this;$(".colorPicker").ColorPicker({element:$(this),onBeforeShow:function(){var b=$(this).val().split(" ");$(this).ColorPickerSetColor(a.RGBtoHex(b[0],b[1],b[2]))},onHide:function(a){$(a).hide();return!1},onSubmit:function(a,c,d,e){$(e).val(d.r+" "+d.g+" "+d.b);$(e).ColorPickerHide()}}).bind("keyup",function(){var b=$(this).val().split(" ");$(this).ColorPickerSetColor(a.RGBtoHex(b[0],b[1],b[2]))})},bindClearButtons:function(){var a=this;$(".clearLayers, .clearRegions").click(function(a){var c=
$(this).parent().prev().prev().children();a.preventDefault();$.each([".m-mapTitle","textarea"],function(){$(c).find(this).val("")});0<$(c).find(".m-mapShape").length&&($(c).find(".m-mapShape")[0].selectedIndex=4);0<$(c).find(".m-mapSize").length&&($(c).find(".m-mapSize")[0].selectedIndex=3);$(this).hasClass("clearLayers")?$(c).find(".colorPicker").val("0 0 0"):$(c).find(".colorPicker").val("150 150 150");return!1});$(".clearself").click(function(b){b.preventDefault();a.clearSelf($(this))})},bindAutocomplete:function(){var a=
this,b="",c=[];$("textarea",".fieldset-regions").bind("keydown",function(a){a.keyCode===$.ui.keyCode.TAB&&$(this).data("autocomplete").menu.active&&a.preventDefault()}).autocomplete({source:function(b,c){$.getJSON("/places/"+a.extractLast(b.term),{},c)},search:function(){b=a.extractLast(this.value);if(2>b.length)return!1},focus:function(){return!1},select:function(b,e){c=a.split(this.value);c.pop();c.push(e.item.value);c.push("");this.value=c.join(", ");return!1}})},split:function(a,b){switch(b){case "[":return a.split(/\]/);
default:return a.split(/,\s*/)}},extractLast:function(a){return this.split(a).pop()},clearSelf:function(a){var b=$(a).parent(),a=$(b).find(".colorPicker");$.each([".m-mapTitle","textarea"],function(){$(b).find(this).val("")});0<$(b).find(".m-mapShape").length&&($(b).find(".m-mapShape")[0].selectedIndex=4);0<$(b).find(".m-mapSize").length&&($(b).find(".m-mapSize")[0].selectedIndex=3);$(b).parent().hasClass("fieldset-points")?a.val("0 0 0"):a.val("150 150 150")},destroyJcrop:function(){var a=this.vars;
void 0!==a.jzoomAPI&&a.jzoomAPI.destroy();void 0!==a.jcropAPI&&a.jcropAPI.destroy();void 0!==a.jqueryAPI&&a.jqueryAPI.destroy();$("#mapOutputImage").show();$(".jcrop-holder").remove();$("#mapCropMessage").hide();this.toggleFileFactor()},resetJbbox:function(){this.vars.jCropType="zoom";$.each(["rubberband","query"],function(){$("#bbox_"+this).val("")});this.toggleFileFactor()},bindCallback:function(a,b){var c=Array.prototype.slice.call(arguments,2);return function(){b.apply(a,$.extend(arguments,c))}},
initJcrop:function(a){var b=this.vars;this.destroyJcrop();this.resetJbbox();b.jCropType="crop";b.jcropAPI=$.Jcrop("#mapOutputImage",{bgColor:"public/images/basemap.png"===$("#mapOutputImage").attr("src")?"grey":"black",bgOpacity:0.5,onChange:this.bindCallback(this,this.showCoords),onSelect:this.bindCallback(this,this.showCoords),setSelect:a});$("#mapCropMessage").show()},initJzoom:function(){var a=this,b=this.vars;a.destroyJcrop();a.resetJbbox();b.jCropType="zoom";b.jzoomAPI=$.Jcrop("#mapOutputImage",
{addClass:"customJzoom",sideHandles:!1,cornerHandles:!1,dragEdges:!1,bgOpacity:1,bgColor:"white",onChange:a.bindCallback(a,a.showCoords),onSelect:a.bindCallback(a,a.showCoords)});$(".jcrop-tracker").mousedown(function(){a.activateJcrop("zoom")})},initJquery:function(){var a=this,b=this.vars;a.destroyJcrop();a.resetJbbox();b.jCropType="query";b.jqueryAPI=$.Jcrop("#mapOutputImage",{addClass:"customJzoom",sideHandles:!1,cornerHandles:!1,dragEdges:!1,bgOpacity:1,bgColor:"white",onChange:a.bindCallback(a,
a.showCoords),onSelect:a.bindCallback(a,a.showCoords)});$(".jcrop-tracker").mousedown(function(){a.activateJcrop("query")})},activateJcrop:function(a){switch(a){case "zoom":$(document).bind("mouseup",this,this.aZoom);break;case "query":$(document).bind("mouseup",this,this.aQuery)}},aZoom:function(a){a=a.data;a.destroyRedo();a.showMap();$(document).unbind("mouseup",a.aZoom)},dblclickZoom:function(a,b){var c=0,d=0,d={},d=$(a).offset(),c=b.pageX-d.left,d=b.pageY-d.top;$("#bbox_rubberband").val(c+","+
d+","+c+","+d);this.destroyRedo();this.showMap()},aQuery:function(a){var b=a.data,c=b.vars.fillColor.r+" "+b.vars.fillColor.g+" "+b.vars.fillColor.b,a={bbox:$("#rendered_bbox").val(),bbox_query:$("#bbox_query").val(),projection:$("#projection").val(),projection_map:$("#projection_map").val(),origin:$("#origin").val(),qlayer:$("#stateprovince").prop("checked")?"stateprovinces_polygon":"base",width:$('input[name="width"]').val(),height:$('input[name="height"]').val()};$(document).unbind("mouseup",b.aQuery);
b.destroyJcrop();b.destroyRedo();b.showSpinner();$.ajax({type:"POST",url:b.settings.baseUrl+"/query/",data:a,timeout:3E4,success:function(a){if(0<a.length){var e=a.map(function(a){return a}).join(", "),f=$(".fieldset-regions").length;$.each($(".fieldset-regions"),function(a){a===f-1&&!$('button[data-type="regions"]').is(":disabled")&&(b.addAccordionPanel("regions"),f+=1);if(""===$('input[name="regions['+a+'][title]"]').val()||""===$('textarea[name="regions['+a+'][data]"]').val())return $('input[name="regions['+
a+'][title]"]').val("Selected Region "+(a+1).toString()),$('input[name="regions['+a+'][color]"]').val(c),$('textarea[name="regions['+a+'][data]"]').val(e),0<a&&$("#fieldSetsRegions").accordion("activate",a),!1});b.showMap()}else b.hideSpinner()},error:function(a,c){"timeout"===c&&b.hideSpinner()}})},textareaCounter:function(a,b){var c=this.vars;switch(b){case "get":switch(a){case "coords":return c.newPointCount;case "regions":return c.newRegionCount}break;case "increase":switch(a){case "coords":return c.newPointCount+=
1,c.newPointCount;case "regions":return c.newRegionCount+=1,c.newRegionCount}break;case "decrease":switch(a){case "coords":return c.newPointCount-=1,c.newPointCount;case "regions":return c.newRegionCount-=1,c.newRegionCount}}},addAccordionPanel:function(a){var b=this,c=b.textareaCounter(a,"get"),d=$(".addmore[data-type='"+a+"']"),e={},f="coords"===a?"0 0 0":"150 150 150",g=0,h=[];d.attr("data-type")===a&&(c<b.settings.maxTextareaCount&&(d.parent().prev().accordion("activate",!1),e=d.parent().prev().children("div:last").clone(),
g=parseInt(e.find("h3 a").text().split(" ")[1],10),c=b.textareaCounter(a,"increase"),e.find("h3 a").text(e.find("h3 a").text().split(" ")[0]+" "+(g+1).toString()),e.find("input.m-mapTitle").attr("name",a+"["+g.toString()+"][title]").val(""),e.find("textarea").attr("name",a+"["+g.toString()+"][data]").removeClass("textarea-processed").val("").each(function(){b.addGrippies(this)}),e.find("select.m-mapShape").attr("name",a+"["+g.toString()+"][shape]").val("circle"),e.find("select.m-mapSize").attr("name",
a+"["+g.toString()+"][size]").val("10"),e.find("input.colorPicker").attr("name",a+"["+g.toString()+"][color]").val(f).ColorPicker({onBeforeShow:function(){var a=$(this).val().split(" ");$(this).ColorPickerSetColor(b.RGBtoHex(a[0],a[1],a[2]))},onHide:function(a){$(a).hide();return!1},onSubmit:function(a,b,c,d){$(d).val(c.r+" "+c.g+" "+c.b);$(d).ColorPickerHide()}}).bind("keyup",function(){var a=$(this).val().split(" ");$(this).ColorPickerSetColor(b.RGBtoHex(a[0],a[1],a[2]))}),h=d.parent().prev().append(e).children("div"),
h.each(function(d){d===h.length-1&&$(this).find("button.removemore").show().click(function(d){d.preventDefault();b.removeAccordionPanel(e,a);c=b.textareaCounter(a,"decrease")}).parent().find("button.clearself").click(function(a){a.preventDefault();b.clearSelf($(this))}).parent().parent().find(".ui-icon:last").remove()}),d.parent().prev().accordion("destroy").accordion({header:"h3",collapsible:!0,autoHeight:!1,active:!1}),"regions"===a&&b.bindAutocomplete()),c>=b.settings.maxTextareaCount-3&&d.attr("disabled",
"disabled"))},removeAccordionPanel:function(a,b){var c=$(".addmore[data-type='"+b+"']");a.nextAll().each(function(){var a=parseInt($(this).find("h3 a").text().split(" ")[1],10);$(this).find("h3 a").text($(this).find("h3 a").text().split(" ")[0]+" "+(a-1).toString());$(this).find("input.m-mapTitle").attr("name",b+"["+(a-2).toString()+"][title]");$(this).find("textarea").attr("name",b+"["+(a-2).toString()+"][data]");$(this).find("select.m-mapShape").attr("name",b+"["+(a-2).toString()+"][shape]");$(this).find("select.m-mapSize").attr("name",
b+"["+(a-2).toString()+"][size]");$(this).find("input.colorPicker").attr("name",b+"["+(a-2).toString()+"][color]")});a.remove();c.removeAttr("disabled")},addGrippies:function(a){function b(a){d.height(Math.max(32,e+a.pageY)+"px");return!1}function c(){$(document).unbind("mousemove",b).unbind("mouseup",c);d.css("opacity",1)}var d=$(a).addClass("textarea-processed"),e=null;$(a).parent().find(".grippie").bind("mousedown",function(a){e=d.height()-a.pageY;d.css("opacity",0.25);$(document).bind("mousemove",
b).bind("mouseup",c);return!1})},bindAddButtons:function(){var a=this;$(".addmore").click(function(b){var c=$(this).attr("data-type"),d=0;b.preventDefault();a.addAccordionPanel(c);d=$(this).parent().prev().children().length;$(this).parent().prev().accordion("activate",d-1);return!1})},loadMapList:function(a){var b=this,c=a||{},d={};$("#usermaps").html("");b.showSpinner();d={locale:b.getParameterByName("locale"),search:c.search?encodeURIComponent(c.search.toLowerCase()):null,uid:c.uid||null};c.sort&&
(d.sort=c.sort.item,d.dir=c.sort.dir);d.locale||delete d.locale;d.search||delete d.search;d.uid||delete d.uid;$.ajax({type:"GET",url:b.settings.baseUrl+"/usermap/",data:d,dataType:"html",success:function(a){if(a.indexOf("session timeout")!==-1)window.location.reload();else{$("#usermaps").html(a);b.hideSpinner();$(".toolsRefresh",".grid-usermaps").click(function(a){a.preventDefault();b.loadMapList()});$("#filter-mymaps").val(c.search).keypress(function(a){if(a.which===13){a.preventDefault();d.search=
$(this).val();b.loadMapList(d);b.trackEvent("maplist","filter")}}).focus();$(".ui-icon-triangle-sort",".grid-usermaps").click(function(a){a.preventDefault();d.sort={item:$(this).attr("data-sort"),dir:"asc"};if($(this).hasClass("asc"))d.sort.dir="desc";b.loadMapList(d);b.trackEvent("maplist","sort")});$(".map-load").click(function(a){a.preventDefault();b.loadMap(this);b.trackEvent("map","load")});$(".map-delete").click(function(a){a.preventDefault();b.deleteMapConfirmation(this)})}}})},removeExtraElements:function(){var a=
this;$.each($(".fieldset-points"),function(b){2<b&&($("#fieldSetsPoints div.fieldset-points:eq("+b.toString()+")").remove(),a.vars.newPointCount=0)});$.each($(".fieldset-regions"),function(b){2<b&&($("#fieldSetsRegions div.fieldset-regions:eq("+b.toString()+")").remove(),a.vars.newRegionCount=0)})},prepareInputs:function(a){var b={},c=[],b={status:"ok",mid:$(".map-embed").attr("data-id"),map:a};b.map.coords=b.map.coords||[];b.map.regions=b.map.regions||[];b.map.layers=b.map.layers||{};b.map.options=
b.map.options||{};String.prototype.clean=function(){return this.replace(/[\[\]]/g,"")};$.each(a,function(a,e){if(-1!==a.indexOf("coords")&&(c=a.match(/\[[A-Za-z0-9]*?\]/g)))void 0===b.map.coords[parseInt(c[0].clean(),10)]&&(b.map.coords[parseInt(c[0].clean(),10)]={}),b.map.coords[parseInt(c[0].clean(),10)][c[1].clean()]=e,delete b.map["coords"+c[0]+c[1]];if(-1!==a.indexOf("regions")&&(c=a.match(/\[[A-Za-z0-9]*?\]/g)))void 0===b.map.regions[parseInt(c[0].clean(),10)]&&(b.map.regions[parseInt(c[0].clean(),
10)]={}),b.map.regions[parseInt(c[0].clean(),10)][c[1].clean()]=e,delete b.map["regions"+c[0]+c[1]];if(-1!==a.indexOf("layers")&&(c=a.match(/\[[A-Za-z0-9]*?\]/g)))b.map.layers[c[0].clean()]=e,delete b.map["layers"+c[0]];if(-1!==a.indexOf("options")&&(c=a.match(/\[[A-Za-z0-9]*?\]/g)))b.map.options[c[0].clean()]=e,delete b.map["options"+c[0]];"save[title]"===a&&(b.map.save={title:e},delete b.map["save[title]"]);"gridspace"===a&&(b.map.grid_space=e);"download-filetype"===a&&(b.map.download_filetype=
e);"download-factor"===a&&(b.map.download_factor=e)});return b},loadInputs:function(a){var b=$("#filter-mymaps").val();this.removeExtraElements();$("#form-mapper").clearForm();$.each(["width","height"],function(){$('input[name="'+this+'"]').val($('input[name="'+this+'"]').val())});$(".addmore").removeAttr("disabled");$("#filter-mymaps").val(b);$("#origin-selector").hide();this.loadCoordinates(a);this.loadRegions(a);this.loadLayers(a);this.loadSettings(a)},loadMap:function(a){var b=this,c=$(a).attr("data-id");
this.tabSelector(0);this.showSpinner();$.ajax({type:"GET",url:b.settings.baseUrl+"/usermap/"+c,dataType:"json",timeout:3E4,success:function(a){b.hideSpinner();"ok"===a.status?(b.loadInputs(a),b.showMap(a),b.bindStorage(),b.activateEmbed(c)):b.showErrorMessage($("#mapper-loading-error-message").text());b.toggleUndo();b.toggleRedo()},error:function(a,c){"timeout"===c&&b.showErrorMessage($("#mapper-loading-error-message").text())}})},loadSettings:function(a){var b="",b="",b=a.map.save.title;$('input[name="save[title]"]').val(b);
$(".m-mapSaveTitle").val(b);$("#mapTitle").text(b);b=b.replace(/[?*:;{}\\ "']+/g,"_");$("#file-name").val(b);$("#projection").val(a.map.projection);this.vars.origins.hasOwnProperty($("#projection").val())&&$("#origin-selector").show();$.each(["bbox_map","projection_map","rotation","origin"],function(){$('input[name="'+this+'"]').val(a.map[this])});a.map.origin||$("#origin").val(this.vars.origins[$("#projection").val()]);$('input[name="border_thickness"]').val(1.25);$("#border-slider").slider({value:1.25});
void 0!==a.map.border_thickness&&a.map.border_thickness&&($('input[name="border_thickness"]').val(a.map.border_thickness),$("#border-slider").slider({value:a.map.border_thickness}));this.setRotation(a.map.rotation);this.resetJbbox();$.each(["border","legend","scalebar","scalelinethickness"],function(){$("#"+this).attr("checked",false);$('input[name="options['+this+']"]').val("")});void 0!==a.map.options&&$.each(["border","legend","scalebar","scalelinethickness"],function(){if(a.map.options[this]&&
a.map.options[this]!==void 0){$("#"+this).attr("checked",true);$('input[name="options['+this+']"]').val(1)}});void 0!==a.map.download_factor&&a.map.download_factor?($('input[name="download_factor"]').val(a.map.download_factor),$("#download-factor-"+a.map.download_factor).attr("checked",!0)):$("#download-factor-3").attr("checked",!0);void 0!==a.map.download_filetype&&a.map.download_filetype?($('input[name="download_filetype"]').val(a.map.download_filetype),b=$("#download-"+a.map.download_filetype).attr("checked",
!0),this.toggleFileType(b)):$("#download-svg").attr("checked",!0);void 0!==a.map.grid_space&&a.map.grid_space?($('input[name="gridspace"]').attr("checked",!1),$("#gridspace-"+a.map.grid_space).attr("checked",!0)):$("#gridspace").attr("checked",!0);void 0!==a.map.gridlabel&&a.map.gridlabel?$('input[name="gridlabel"]').attr("checked",!0).val("false"):$("#gridlabel").attr("checked",!1)},loadCropSettings:function(a){var b=[];a.map.bbox_rubberband?(b=a.map.bbox_rubberband.split(","),this.initJcrop([b[2],
b[3],b[0],b[1]]),this.toggleFileFactor(a.map.download_factor)):this.destroyJcrop()},loadShapeSize:function(a,b){$.each(["shape","size"],function(){""===b[a][this].toString()?$('select[name="coords['+a.toString()+"]["+this+']"]')[0].selectedIndex=3:$('select[name="coords['+a.toString()+"]["+this+']"]').val(b[a][this])})},loadCoordinates:function(a){var b=this,c=a.map.coords||[],d="",e="",f="",g=/[?*{}\\]+/g;$.each(c,function(a){2<a&&b.addAccordionPanel("coords");d=c[a].title||"";e=c[a].data.replace(g,
"")||"";f=c[a].color||"0 0 0";$('input[name="coords['+a.toString()+'][title]"]').val(d);$('textarea[name="coords['+a.toString()+'][data]"]').val(e);b.loadShapeSize(a,c);$('input[name="coords['+a.toString()+'][color]"]').val(f)})},loadRegions:function(a){var b=this,c=a.map.regions||[],d="",e="",f="";$.each(c,function(a){2<a&&b.addAccordionPanel("regions");d=c[a].title||"";e=c[a].data||"";f=c[a].color||"150 150 150";$('input[name="regions['+a.toString()+'][title]"]').val(d);$('textarea[name="regions['+
a.toString()+'][data]"]').val(e);$('input[name="regions['+a.toString()+'][color]"]').val(f)})},loadLayers:function(a){a.map.layers&&$.each(a.map.layers,function(a){$('input[name="layers['+a+']"]').attr("checked",!0)})},activateEmbed:function(a){var b=this,c=["img","kml","svg","json"];$(".map-embed").attr("data-id",a).css("display","block").click(function(d){d.preventDefault();$.each(c,function(){"img"===this.toString()?$("#embed-"+this,"#mapEmbed").val('<img src="'+b.settings.baseUrl+"/map/"+a+'" alt="" />'):
$("#embed-"+this,"#mapEmbed").val(b.settings.baseUrl+"/map/"+a+"."+this)});$("#mapEmbed").find("span.mid").text(a).end().dialog({width:"525",autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy")}}]}).show()})},deleteMapConfirmation:function(a){var b=this,c=$(a).attr("data-id"),a="<em>"+$(a).parent().parent().find(".title").text()+"</em>";$("#mapper-message-delete").find("span").html(a).end().dialog({height:"250",
width:"500",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:$("#button-titles span.delete").text(),"class":"negative",click:function(){$.ajax({type:"DELETE",url:b.settings.baseUrl+"/usermap/"+c,success:function(){b.loadMapList();b.trackEvent("map","delete")}});$(this).dialog("destroy")}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy")}}]}).show()},loadUserList:function(a){var b=this,a=a||{},c={locale:this.getParameterByName("locale")};
b.showSpinner();a.sort&&(c.sort=a.sort.item,c.dir=a.sort.dir);c.locale||delete c.locale;$.ajax({type:"GET",url:b.settings.baseUrl+"/user/",data:c,dataType:"html",success:function(a){if(a.indexOf("access denied")!==-1)window.location.reload();else{$("#userdata").html(a);b.hideSpinner();$(".toolsRefresh",".grid-users").click(function(a){a.preventDefault();b.loadUserList()});$(".ui-icon-triangle-sort",".grid-users").click(function(a){a.preventDefault();c.sort={item:$(this).attr("data-sort"),dir:"asc"};
if($(this).hasClass("asc"))c.sort.dir="desc";b.loadUserList(c)});$(".user-delete").click(function(a){a.preventDefault();b.deleteUserConfirmation(this)});$(".user-load").click(function(a){a.preventDefault();b.loadMapList({uid:$(this).attr("data-uid")});b.tabSelector(3)})}}})},getLanguage:function(){var a="",b=this.getParameterByName("locale");if("fr_FR"===b||"es_ES"===b)a="?locale="+b;return a},deleteUserConfirmation:function(a){var b=this,c=$(a).attr("data-id"),a="<em>"+$(a).parent().parent().children("td:first").text()+
"</em>";$("#mapper-message-delete").find("span").html(a).end().dialog({height:"250",width:"500",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:$("#button-titles span.delete").text(),"class":"negative",click:function(){$.ajax({type:"DELETE",url:b.settings.baseUrl+"/user/"+c,success:function(){b.loadUserList();b.trackEvent("user","delete")}});$(this).dialog("destroy")}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy")}}]}).show()},
bindSave:function(){var a=this;$(".map-save").click(function(b){b.preventDefault();a.mapSave()})},mapSave:function(){var a=!1,b=/[?*:;{}\\ "'\/@#!%\^()<>.]+/g,c="",d=this;$("#mapSave").dialog({autoOpen:!0,height:"175",width:"350",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:$("#button-titles span.save").text(),"class":"positive",click:function(){""===$.trim($(".m-mapSaveTitle").val())&&(a=!0);a?$(".m-mapSaveTitle").addClass("ui-state-error").keyup(function(){$(this).removeClass("ui-state-error")}):
($('input[name="save[title]"]').val($(".m-mapSaveTitle").val()),$.each(["factor","filetype"],function(){$('input[name="download_'+this+'"]').val($('input[name="download-'+this+'"]:checked').val())}),$('input[name="grid_space"]').val($('input[name="gridspace"]:checked').val()),d.setFormOptions(),d.showSpinner(),void 0===d.vars.jcropAPI&&$("#bbox_rubberband").val(""),$.ajax({type:"POST",url:d.settings.baseUrl+"/usermap/",data:$("form").serialize(),dataType:"json",success:function(a){$("#mapTitle").text($(".m-mapSaveTitle").val());
c=$(".m-mapSaveTitle").val().replace(b,"_");$("#file-name").val(c);d.activateEmbed(a.mid);d.loadMapList();d.hideSpinner();d.trackEvent("map","save")}}),$(this).dialog("destroy"))}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy")}}]})},bindDownload:function(){var a=this;$(".map-download").click(function(b){b.preventDefault();a.mapDownload()})},mapDownload:function(){var a=this;$("#mapExport").dialog({autoOpen:!0,width:"620",modal:!0,
closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:$("#button-titles span.download").text(),"class":"positive",click:function(){a.generateDownload()}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy")}}]})},bindSubmit:function(){var a=this,b="",c=!1;$(".submitForm").click(function(d){d.preventDefault();c=!1;$(".m-mapCoord").each(function(){b=$(this).parents(".ui-accordion-content").find(".m-mapTitle").keyup(function(){c=!1;$(this).removeClass("ui-state-error")});
$(this).val()&&""===$(b).val()&&(c=!0,$(b).addClass("ui-state-error"))});c?a.showMessage($("#mapper-missing-legend").text()):(a.destroyRedo(),a.showMap(),a.tabSelector(0))})},mapToggleSettings:function(){$("#mapToolsCollapse a").trigger("click")},bindPanelToggle:function(){var a=this;$("#mapToolsCollapse a").tipsy({gravity:"e"}).toggle(function(b){b.preventDefault();$("#mapOutputImage").attr("width",0).attr("height",0);$("#mapOutputScale").hide();$(this).parent().addClass("mapTools-collapsed");$("#mapTools").hide("slide",
{direction:"right"},250,function(){var b=0.98*$(window).width();$("#actionsBar").animate({width:b},250);$("#map").animate({width:b},250,function(){$('input[name="width"]').val(b);a.mapRefresh()})})},function(b){b.preventDefault();$("#mapOutputImage").attr("width",0).attr("height",0);$("#mapOutputScale").hide();$(this).parent().removeClass("mapTools-collapsed");$("#mapTools").show("slide",{direction:"right"},250,function(){$("#actionsBar").animate({width:"810px"},250);$("#map").animate({width:"800px"},
function(){$('input[name="width"]').val(800);a.mapRefresh()})})})},showMessage:function(a){$("#mapper-message").html(a).dialog({autoOpen:!0,height:"200",width:"400",modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy")}}]}).show()},drawLegend:function(){var a=$("#legend_url").val(),b=$("#mapLegend");a?b.html('<img src="'+a+'" />'):b.html("<p><em>"+$("#mapper-legend-message").text()+"</em></p>")},drawScalebar:function(){$("#mapScale img").attr("src",
$("#scalebar_url").val()).show()},showBadPoints:function(){var a=$("#bad_points").val();a&&($("#badRecords").html(a),$("#badRecordsWarning").show())},showSpinner:function(){$(".mapper-loading-spinner").show()},hideSpinner:function(){$(".mapper-loading-spinner").hide()},showErrorMessage:function(a){$("#mapOutput").append('<span class="mapper-message-error ui-corner-all ui-widget-content">'+a+"</span>")},hideErrorMessage:function(){$("#mapOutput .mapper-message-error").remove()},showMap:function(a){var b=
(new Date).getTime(),c="",d={};this.destroyJcrop();$("#output").val("pnga");$("#badRecordsWarning").hide();$("#download_token").val(b);this.showSpinner();c=$("form").serialize();d=$("form").serializeJSON();this.postData(c,a);$.jStorage.set("do-"+b.toString(),d);this.toggleUndo(!0)},postData:function(a,b){var c=this;c.hideErrorMessage();$.ajax({type:"POST",url:c.settings.baseUrl+"/application/",data:a,dataType:"json",timeout:3E4,success:function(a){c.resetFormValues(a);c.resetJbbox();c.drawMap(a,b);
c.drawLegend();c.drawScalebar();c.showBadPoints();c.addBadRecordsViewer()},error:function(a,b){"timeout"===b&&(c.showErrorMessage($("#mapper-loading-error-message").text()),c.hideSpinner())}})},resetFormValues:function(a){$("#mapOutput input").each(function(){$(this).val("")});$.each("rendered_bbox rendered_rotation rendered_projection legend_url scalebar_url bad_points".split(" "),function(){$("#"+this).val(a[this])});$("#bbox_map").val($("#rendered_bbox").val());$("#projection_map").val($("#rendered_projection").val());
$("#rotation").val($("#rendered_rotation").val());$("#pan").val("")},drawMap:function(a,b){var c=this;$("#mapOutputImage").attr("width",a.size[0]).attr("height",a.size[1]).attr("src",a.mapOutputImage).one("load",function(){b||(b={map:{bbox_rubberband:""}});c.loadCropSettings(b);c.hideSpinner()})},addBadRecordsViewer:function(){var a=this;$("#badRecordsViewer").dialog({autoOpen:!1,height:"200",width:"500",position:[200,200],modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",
click:function(){$(this).dialog("destroy")}}]});$(".toolsBadRecords").click(function(b){b.preventDefault();a.addBadRecordsViewer();$("#badRecordsViewer").dialog("open")})},generateDownload:function(){var a=this,b=$("#file-name").val(),c=(new Date).getTime().toString(),d="",e="",f="png",b=b.replace(/[~$?*,:;{}\[\]\\ "'\/@#!%\^()<>.+=|`&]+/g,"_");$("#file-name").val(b);$('input[name="file_name"]').val(b);$('input[name="download_factor"]').val($('input[name="download-factor"]:checked').val());f=$("input[name='download-filetype']:checked").val();
a.setFormOptions();$("#download_token").val(c);$.each(["ui-dialog-buttonpane","download-dialog"],function(){$("."+this).hide()});$(".download-message").show();switch(f){case "pptx":$("#output").val("pptx");a.vars.jcropAPI?$("#crop").val(1):a.resetJbbox();e=$("form").serialize();$("body").download("/pptx/"+a.getLanguage(),e,"post");$("#output").val("pnga");break;case "docx":$("#output").val("docx");a.vars.jcropAPI?$("#crop").val(1):a.resetJbbox();e=$("form").serialize();$("body").download("/docx/"+
a.getLanguage(),e,"post");$("#output").val("pnga");break;case "kml":e=$("form").serialize();$("body").download("/kml/",e,"post");break;default:$("#download").val(1),$("#output").val(f),a.vars.jcropAPI?$("#crop").val(1):a.resetJbbox(),e=$("form").serialize(),$("body").download("/application/",e,"post"),$("#download").val(""),$("#output").val("pnga")}a.vars.fileDownloadTimer=window.setInterval(function(){d=$.cookie("fileDownloadToken");d===c&&a.finishDownload()},1E3);a.trackEvent("download",f)},setFormOptions:function(){$.each(["border",
"legend","scalebar","scalelinethickness"],function(){$("#"+this).prop("checked")?$('input[name="options['+this+']"]').val(1):$('input[name="options['+this+']"]').val("")})},finishDownload:function(){$(".download-message").hide();$.each(["download-dialog","ui-dialog-buttonpane"],function(){$("."+this).show()});window.clearInterval(this.vars.fileDownloadTimer);$.cookie("fileDownloadToken",null)},showExamples:function(){$("#mapper-message-help").html('<img src="public/images/help-data.png" alt="" />').dialog({height:"350",
width:"525",autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy")}}]}).show()},showCodes:function(){var a=this.getParameterByName("locale")?{locale:this.getParameterByName("locale")}:{};$("#mapper-message-codes").dialog({height:"450",width:"850",autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy")}}]}).show();this.loadCodes($("#mapper-message-codes"),
a)},loadCodes:function(a,b){var c=this,d="";a.find("tbody tr td").text("\u00a0");a.find("tbody tr td:first").text("\u00a0\u00a0\u00a0").addClass("loading");$.ajax({type:"GET",url:c.settings.baseUrl+"/places/",data:b,dataType:"html",success:function(e){a.html(e);d=a.find(".filter-countries");d.val("");void 0!==b.filter&&d.val(b.filter);d.keypress(function(e){var g=e.keyCode||e.which;if(13===g||9===g)e.preventDefault(),b.filter=d.val(),c.loadCodes(a,b)});d.blur(function(){b.filter=d.val();c.loadCodes(a,
b)})}})},performRotation:function(a){$("#rotation").val($(a).attr("data-rotate"));this.resetJbbox();this.destroyRedo();this.showMap();this.trackEvent("rotate",$(a).attr("data-rotate"))},setRotation:function(a){var b=$("#mapControls"),c=$(".thumb",b),d=$(".overview",b).children(),e=0,f=e=0;a||(a=0);a=0>parseFloat(a)?parseFloat(a)+360:parseFloat(a);e=a*(Math.PI/180);$(".overview",b).css("left",-(a/360*d.outerWidth(!0)*d.length)+"px");f=Math.round(28*-Math.cos(e)+(b.outerHeight()/2-c.outerHeight()/2))+
"px";e=Math.round(28*Math.sin(e)+(b.outerWidth()/2-c.outerWidth()/2))+"px";$(".thumb",b).css("top",f).css("left",e)},getParameterByName:function(a){a="[\\?&]"+a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")+"=([^&#]*)";a=RegExp(a).exec(window.location.href);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},mapCircleSlider:function(){for(var a=0,b="",a=0;360>a;a+=1)0===a%5&&(b+='<li data-rotate="'+a+'"></li>');return b},clearStorage:function(){this.destroyRedo();$.jStorage.flush()},bindStorage:function(){var a=
{},b=(new Date).getTime();this.clearStorage();a=$("form").serializeJSON();$.jStorage.set("do-"+b.toString(),a)},bindRotateWheel:function(){var a=this;$(".overlay","#mapControls").css("background-image",'url("public/images/bg-rotatescroll.png")');$(".overview","#mapControls").append(a.mapCircleSlider());$("#mapControls").tinycircleslider({snaptodots:!0,radius:28,callback:function(b){$(".mapper-loading-spinner").is(":hidden")&&a.performRotation(b)}})},bindTabs:function(){var a=$("#tabs"),b="";$("#mapTools").tabs({selected:0});
a.tabs({cache:!0,load:function(a,b){$(b.tab).data("cache.tabs",""===$(b.panel).html()?!1:!0)},event:"change"}).find(".ui-state-disabled").each(function(){$(this).removeClass("ui-state-disabled")}).end().show();a.find("ul.navigation a").click(function(){var a={},d=$(this).parent().prevAll().length;a.tabs=d;$.bbq.pushState(a);$.each($("#site-languages a"),function(){b=$(this).attr("href").split("#")[0];$(this).attr("href",b+"#tabs="+d)})});$(window).bind("hashchange",function(){var c=$.bbq.getState("tabs",
!0)||0;a.find("ul.navigation a").eq(c).triggerHandler("change");$.each($("#site-languages a"),function(){b=$(this).attr("href").split("#")[0];$(this).attr("href",b+"#tabs="+c)})});$(window).trigger("hashchange")},screenSizeListener:function(){var a=this;$(window).resize(function(){var b=a.getPageSize(),c=a.getPageScroll();$("#mapper-overlay").css({width:b[0],height:b[1]});$("#mapper-message").css({top:c[1]+b[3]/10,left:c[0],position:"fixed",zIndex:1001,margin:"0px auto",width:"100%"})})},init:function(){var a=
this;this.screenSizeListener();this.bindRotateWheel();this.hideSpinner();$("#header>div").show();this.bindTabs();$("#mapOutput").append('<img id="mapOutputImage" src="public/images/basemap.png" alt="" width="800" height="400" />').find("span.mapper-loading-message").remove();$("#mapScale").append('<img id="mapOutputScale" src="public/images/basemap-scalebar.png" width="200" height="27" />');$("a.login","#site-session").click(function(b){b.preventDefault();a.tabSelector(3)});$("a.show-examples").click(function(b){b.preventDefault();
a.showExamples()});$("a.show-codes").click(function(b){b.preventDefault();a.showCodes()});$(".fieldSets").accordion({header:"h3",collapsible:!0,autoHeight:!1});$(".tooltip").tipsy({gravity:"s"});this.bindStorage();this.bindHotkeys();this.bindToolbar();this.bindArrows();this.bindSettings();this.bindSlider();this.bindColorPickers();this.bindAddButtons();this.bindClearButtons();this.bindAutocomplete();this.bindSave();this.bindDownload();this.bindSubmit();this.bindPanelToggle();$(".toolsUndoDisabled").click(!1);
$(".toolsRedoDisabled").click(!1);$("textarea.resizable:not(.textarea-processed)").TextAreaResizer();0<$("#usermaps").length&&(this.loadMapList(),this.tabSelector(3));0<$("#userdata").length&&(this.loadUserList(),this.tabSelector(4));$("input").keypress(function(a){if(a.which===13)return false})}};SimpleMappr.init()});