/*global $, jQuery, window, document, self, XMLHttpRequest, alert, encodeURIComponent, _gaq */
var Mappr=Mappr||{settings:{}};$(function(){"use strict";Mappr.settings={baseUrl:Mappr.settings.baseUrl||"",active:Mappr.settings.active||false};Mappr.vars={newPointCount:0,newRegionCount:0,maxTextareaCount:10,zoom:true,fileDownloadTimer:{},fillColor:"",jCropType:"zoom",cropUpdated:false,undoSize:10};$.ajaxSetup({xhr:function(){return new XMLHttpRequest();}});$(window).resize(function(){var a=Mappr.getPageSize(),b=Mappr.getPageScroll();$("#mapper-overlay").css({width:a[0],height:a[1]});$("#mapper-message").css({top:b[1]+(a[3]/10),left:b[0],position:"fixed",zIndex:1001,margin:"0px auto",width:"100%"});});Mappr.trackEvent=function(a,b){if(window._gaq!==undefined){_gaq.push(["_trackEvent",a,b]);}};Mappr.getPageSize=function(){var e,a,c,f,d,b;if(window.innerHeight&&window.scrollMaxY){e=window.innerWidth+window.scrollMaxX;a=window.innerHeight+window.scrollMaxY;}else{if(document.body.scrollHeight>document.body.offsetHeight){e=document.body.scrollWidth;a=document.body.scrollHeight;}else{e=document.body.offsetWidth;a=document.body.offsetHeight;}}if(self.innerHeight){if(document.documentElement.clientWidth){c=document.documentElement.clientWidth;}else{c=self.innerWidth;}f=self.innerHeight;}else{if(document.documentElement&&document.documentElement.clientHeight){c=document.documentElement.clientWidth;f=document.documentElement.clientHeight;}else{if(document.body){c=document.body.clientWidth;f=document.body.clientHeight;}}}if(a<f){d=f;}else{d=a;}if(e<c){b=e;}else{b=c;}return[b,d,c,f];};Mappr.getPageScroll=function(){var b,a;if(self.pageYOffset){a=self.pageYOffset;b=self.pageXOffset;}else{if(document.documentElement&&document.documentElement.scrollTop){a=document.documentElement.scrollTop;b=document.documentElement.scrollLeft;}else{if(document.body){a=document.body.scrollTop;b=document.body.scrollLeft;}}}return[b,a];};Mappr.showCoords=function(m){var p=parseFloat(m.x),n=parseFloat(m.y),a=parseFloat(m.x2),o=parseFloat(m.y2),q=parseFloat(m.w),i=parseFloat(m.h),f='<input type="text" id="jcrop-coord-ul" class="jcrop-coord"></input>',k='<input type="text" id="jcrop-coord-lr" class="jcrop-coord"></input>',d='<div id="jcrop-dimension-wrapper"><input type="text" id="jcrop-dimension-w" class="jcrop-dimension"></input>X<input type="text" id="jcrop-dimension-h" class="jcrop-dimension"></input></div>',g={x:p,y:n},j={x:a,y:o},b={},e={},l=$('input[name="download-factor"]:checked').val();switch(Mappr.vars.jCropType){case"crop":$(".jcrop-holder div:first").css("backgroundColor","white");$("#bbox_rubberband").val(p+","+n+","+a+","+o);if($("#projection option:selected").val()==="epsg:4326"){$(".jcrop-coord").css("width","100px");}else{$(".jcrop-coord").css("width","175px");}if($("#jcrop-coord-ul").length===0&&$("#jcrop-coord-lr").length===0){$(".jcrop-tracker").eq(0).after(f).after(k).after(d);}b=Mappr.pix2geo(g);e=Mappr.pix2geo(j);$("#jcrop-coord-ul").val(b.x+", "+b.y);$("#jcrop-coord-lr").val(e.x+", "+e.y);$("#jcrop-dimension-w").val(q);$("#jcrop-dimension-h").val(i);$("#jcrop-dimension-wrapper").css({left:q/2-$("#jcrop-dimension-wrapper").width()/2,top:i/2-$("#jcrop-dimension-wrapper").height()/2});$.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+$("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+$("#jcrop-coord-lr").val()+'" }');$(".jcrop-coord").live("blur",function(){if(!Mappr.vars.cropUpdated){Mappr.vars.cropUpdated=Mappr.updateCropCoordinates();}}).live("keypress",function(h){var c=h.keyCode||h.which;if(c===13||c===9){h.preventDefault();Mappr.vars.cropUpdated=false;this.blur();}});$(".jcrop-dimension").live("blur",function(){if(!Mappr.vars.cropUpdated){Mappr.vars.cropUpdated=Mappr.updateCropDimensions();}}).live("keypress",function(h){var c=h.keyCode||h.which;if(c===13||c===9){h.preventDefault();Mappr.vars.cropUpdated=false;this.blur();}});$("span","#scale-measure").text(l*q+" X "+l*i).parent().show();break;case"zoom":$(".jcrop-holder div:first").css("backgroundColor","white");$("#bbox_rubberband").val(p+","+n+","+a+","+o);break;case"query":$("#bbox_query").val(p+","+n+","+a+","+o);break;}};Mappr.updateCropDimensions=function(){var l=$("#bbox_rubberband").val().split(","),k=parseFloat(l[2])-parseFloat(l[0]),d=parseFloat(l[3])-parseFloat(l[1]),g=$("#mapOutputImage").width(),b=$("#mapOutputImage").height(),j=$("#jcrop-dimension-w").val(),c=$("#jcrop-dimension-h").val(),i=l[0],a=l[2],f=l[1],e=l[3];j=(j>g)?g:(k-j)/2;c=(c>b)?b:(d-c)/2;i=parseFloat(l[2])-j;a=parseFloat(l[0])+j;f=parseFloat(l[1])+c;e=parseFloat(l[3])-c;if(j>=g){i=0;a=g;}if(c>=b){f=0;e=b;}this.loadCropSettings({map:{bbox_rubberband:i.toString()+","+f.toString()+","+a.toString()+","+e.toString()}});return true;};Mappr.updateCropCoordinates=function(){var c=[],b={},d=[],a={};c=$("#jcrop-coord-ul").val().split(",");b=this.geo2pix({x:$.trim(c[0]),y:$.trim(c[1])});d=$("#jcrop-coord-lr").val().split(",");a=this.geo2pix({x:$.trim(d[0]),y:$.trim(d[1])});$.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+$("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+$("#jcrop-coord-lr").val()+'" }');this.loadCropSettings({map:{bbox_rubberband:a.x+","+a.y+","+b.x+","+b.y}});return true;};Mappr.pix2geo=function(c){var d=0,b=0,g=$("#bbox_map").val(),e=parseFloat($("#mapOutputImage").width()),a=parseFloat($("#mapOutputImage").height()),f={};if(g===""){g="-180,-90,180,90";}g=g.split(",");d=Math.abs(parseFloat($.trim(g[2]))-parseFloat($.trim(g[0])));b=Math.abs(parseFloat($.trim(g[3]))-parseFloat($.trim(g[1])));f.x=this.roundNumber(parseFloat(g[0])+(parseFloat(c.x)*d)/e,2);f.y=this.roundNumber(parseFloat(g[1])+(parseFloat(a-parseFloat(c.y))*b)/a,2);return f;};Mappr.geo2pix=function(e){var c=0,b=0,d=$("#bbox_map").val(),a={};if(d===""){d="-180,-90,180,90";}d=d.split(",");c=Math.abs(parseFloat($.trim(d[2]))-parseFloat($.trim(d[0])));b=Math.abs(parseFloat($.trim(d[3]))-parseFloat($.trim(d[1])));a.x=$("#mapOutputImage").width()*(Math.abs(parseFloat(e.x)-parseFloat($.trim(d[0]))))/c;a.y=$("#mapOutputImage").height()*(b-Math.abs(parseFloat(e.y)-parseFloat($.trim(d[1]))))/b;return a;};Mappr.roundNumber=function(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b);};Mappr.tabSelector=function(a){var b={};$("#tabs").tabs("select",a);b.tabs=a;$.bbq.pushState(b);};Mappr.RGBtoHex=function(b,a,c){return this.toHex(b)+this.toHex(a)+this.toHex(c);};Mappr.toHex=function(a){if(a===null){return"00";}a=parseInt(a,10);if(a===0||isNaN(a)){return"00";}a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16);};Mappr.bindToolbar=function(){var a=this;$("#actionsBar ul li").hover(function(){$(this).addClass("ui-state-hover");},function(){$(this).removeClass("ui-state-hover");});$(".toolsZoomIn").click(function(b){b.preventDefault();a.mapZoomIn();a.trackEvent("toolbar","zoomin");});$(".toolsZoomOut").click(function(b){b.preventDefault();a.mapZoomOut();a.trackEvent("toolbar","zoomout");});$(".toolsCrop").click(function(b){b.preventDefault();a.mapCrop();a.trackEvent("toolbar","crop");});$(".toolsQuery").ColorPicker({onBeforeShow:function(){$(this).ColorPickerSetColor(a.RGBtoHex(150,150,150));},onShow:function(b){$(b).show();a.destroyJcrop();return false;},onHide:function(b){$(b).hide();return false;},onSubmit:function(b,e,c,d){b=null;e=null;$(d).ColorPickerHide();a.vars.fillColor=c;a.initJquery();a.vars.zoom=false;a.trackEvent("toolbar","query");}}).click(function(b){b.preventDefault();a.resetJbbox();});$(".toolsRefresh").click(function(b){b.preventDefault();a.mapRefresh();a.trackEvent("toolbar","refresh");});$(".toolsRebuild").click(function(b){b.preventDefault();a.mapRebuild();a.trackEvent("toolbar","rebuild");});};Mappr.mapCrop=function(){var e={},c=[],b={},d=[],a={};if($.cookie("jcrop_coords")){e=$.parseJSON($.cookie("jcrop_coords"));c=e.jcrop_coord_ul.split(",");d=e.jcrop_coord_lr.split(",");b=Mappr.geo2pix({x:$.trim(c[0]),y:$.trim(c[1])});a=Mappr.geo2pix({x:$.trim(d[0]),y:$.trim(d[1])});Mappr.loadCropSettings({map:{bbox_rubberband:a.x+","+a.y+","+b.x+","+b.y}});}else{Mappr.initJcrop();}Mappr.vars.zoom=false;};Mappr.resetAndBuild=function(){Mappr.resetJbbox();Mappr.destroyRedo();Mappr.showMap();};Mappr.mapRefresh=function(){Mappr.resetAndBuild();Mappr.tabSelector(0);};Mappr.mapRebuild=function(){$.each(["bbox_map","projection_map","bbox_rubberband","rotation","projection","pan"],function(){$("#"+this).val("");});Mappr.destroyRedo();Mappr.showMap();};Mappr.bindArrows=function(){var a=this;$(".arrows").click(function(b){b.preventDefault();$("#pan").val($(this).attr("data-pan"));a.resetJbbox();a.showMap();a.trackEvent("arrows",$(this).attr("data-pan"));});};Mappr.mapPanUp=function(){$("#pan").val("up");Mappr.resetAndBuild();};Mappr.mapPanDown=function(){$("#pan").val("down");Mappr.resetAndBuild();};Mappr.mapPanLeft=function(){$("#pan").val("left");Mappr.resetAndBuild();};Mappr.mapPanRight=function(){$("#pan").val("right");Mappr.resetAndBuild();};Mappr.mapList=function(){Mappr.tabSelector(3);};Mappr.mapZoomIn=function(){Mappr.initJzoom();Mappr.vars.zoom=true;};Mappr.mapZoomOut=function(){Mappr.resetJbbox();$("#zoom_out").val(1);Mappr.destroyRedo();Mappr.showMap();$("#zoom_out").val("");};Mappr.storageType=function(b){var a=0;a=$.grep($.jStorage.index(),function(d,c){c=null;return(d.substring(0,b.length)===b);});return a;};Mappr.toggleUndo=function(c){var a=this,b=this.storageType("do");$(".toolsUndo").addClass("toolsUndoDisabled").removeClass("toolsUndo").unbind("click");if(c&&b.length>1){if(b.length>a.vars.undoSize){$.jStorage.deleteKey(b.shift());}$(".toolsUndoDisabled").addClass("toolsUndo").removeClass("toolsUndoDisabled").bind("click",function(d){d.preventDefault();a.mapUndo();a.trackEvent("edit","undo");});}};Mappr.toggleRedo=function(b){var a=this;$(".toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").unbind("click");if(b){$(".toolsRedoDisabled").addClass("toolsRedo").removeClass("toolsRedoDisabled").bind("click",function(c){c.preventDefault();a.mapRedo();a.trackEvent("edit","redo");});}};Mappr.destroyRedo=function(){var a=Mappr.storageType("undo");if(a.length>0){$(".toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").unbind("click");$.jStorage.deleteKey(a.pop());}};Mappr.mapUndo=function(){var e=Mappr.storageType("do"),c="",f={},d="",b={},a={},g=false;if(e.length===1){return;}Mappr.destroyRedo();c=e[e.length-1];f=$.jStorage.get(c);d=e[e.length-2];b=$.jStorage.get(d);a=Mappr.prepareInputs(b);Mappr.loadInputs(a);$.jStorage.deleteKey(c);$.jStorage.set("un"+c,f);if(b.width!==f.width){Mappr.mapToggleSettings();}else{if(b.layers.relief||b.layers.reliefgrey||JSON.stringify(b).length>7000||b.projection!=="epsg:4326"){g=true;}Mappr.postData(decodeURIComponent($.param(b)),null,g);}Mappr.toggleRedo(true);if(e.length===2){Mappr.toggleUndo();}};Mappr.mapRedo=function(){var h=Mappr.storageType("undo"),g="",c={},d={},i=Mappr.storageType("do"),a="",e={},b=new Date().getTime(),f=false;if(h.length===0){return;}Mappr.toggleRedo();g=h.pop();c=$.jStorage.get(g);a=i[i.length-1];e=$.jStorage.get(a);d=Mappr.prepareInputs(c);Mappr.loadInputs(d);$.jStorage.deleteKey(g);$.jStorage.set("do-"+b.toString(),c);if(c.width!==e.width){Mappr.mapToggleSettings();}else{if(c.layers.relief||c.layers.reliefgrey||JSON.stringify(c).length>7000||c.projection!=="epsg:4326"){f=true;}Mappr.postData(decodeURIComponent($.param(c)),null,f);}Mappr.toggleUndo(true);};Mappr.bindHotkeys=function(){var b=this,c={},a={};c={"ctrl+s":b.mapSave,"ctrl+d":b.mapDownload,"ctrl+l":b.mapList,"ctrl+r":b.mapRefresh,"ctrl+n":b.mapRebuild,"ctrl+x":b.mapCrop,"ctrl+e":b.mapToggleSettings,"ctrl++":b.mapZoomIn,"ctrl+-":b.mapZoomOut,esc:b.destroyJcrop,"ctrl+z":b.mapUndo,"ctrl+y":b.mapRedo};a={up:b.mapPanUp,down:b.mapPanDown,left:b.mapPanLeft,right:b.mapPanRight};if(b.settings.active==="false"){delete c["ctrl+s"];delete c["ctrl+l"];}$.each(c,function(d,e){$(document).bind("keydown",d,e);});$("#mapOutput").hover(function(){$.each(a,function(d,e){$(document).bind("keydown",d,e);});$("#mapOutputImage").dblclick(function(d){b.dblclickZoom(this,d);});},function(){$.each(a,function(d,e){d=null;$(document).unbind("keydown",e);});$("#mapOutputImage").unbind("dblclick");});};Mappr.hardResetShowMap=function(){this.resetJbbox();this.destroyRedo();this.showMap();};Mappr.bindSettings=function(){var a=this;$(".layeropt").click(function(){a.hardResetShowMap();});$(".gridopt").click(function(){if(!$("#graticules").prop("checked")){$("#graticules").attr("checked",true);}a.hardResetShowMap();});$("#gridlabel").click(function(){if(!$("#graticules").prop("checked")){$("#graticules").attr("checked",true);}if($(this).prop("checked")){$(this).val("false");}a.hardResetShowMap();});$("#projection").change(function(){if($(this).val()!==""){$.cookie("jcrop_coords",null);a.hardResetShowMap();}});a.toggleFileFactor();$(".download-factor").change(function(){a.toggleFileFactor($(this).val());});$(".download-filetype").change(function(){a.toggleFileType(this);});};Mappr.bindSlider=function(){var a=this;$("#border-slider").slider({value:1.25,min:1,max:2,step:0.25,slide:function(c,b){c=null;$('input[name="border_thickness"]').val(b.value);a.destroyRedo();a.showMap();a.trackEvent("slider",b.value);}});};Mappr.toggleFileFactor=function(b){var c="",a=$("#bbox_rubberband").val().split(",");if(!b){b=$('input[name="download-factor"]:checked').val();}if(this.vars.jCropType==="crop"){c=b*(a[2]-a[0])+" X "+b*(a[3]-a[1]);}else{c=b*($("#mapOutputImage").width())+" X "+b*($("#mapOutputImage").height());}$("span","#scale-measure").text(c).parent().show();};Mappr.toggleFileType=function(a){if($(a).attr("id")==="download-svg"||$(a).attr("id")==="download-pptx"||$(a).attr("id")==="download-docx"){$.each(["legend","scalebar"],function(){$("#"+this).attr("checked",false).attr("disabled","disabled");});$("#border").removeAttr("disabled");}else{if($(a).attr("id")==="download-kml"){$.each(["legend","scalebar","border"],function(){$("#"+this).attr("checked",false).attr("disabled","disabled");});}else{$.each(["border","legend","scalebar"],function(){$("#"+this).removeAttr("disabled");});$("#border").removeAttr("disabled");}}};Mappr.bindColorPickers=function(){var a=this;$(".colorPicker").ColorPicker({element:$(this),onBeforeShow:function(){var b=$(this).val().split(" ");$(this).ColorPickerSetColor(a.RGBtoHex(b[0],b[1],b[2]));},onHide:function(b){$(b).hide();return false;},onSubmit:function(b,e,c,d){b=null;e=null;$(d).val(c.r+" "+c.g+" "+c.b);$(d).ColorPickerHide();}}).bind("keyup",function(){var b=$(this).val().split(" ");$(this).ColorPickerSetColor(a.RGBtoHex(b[0],b[1],b[2]));});};Mappr.bindClearButtons=function(){var a=this;$(".clearLayers, .clearRegions, .clearFreehand").click(function(c){var b=$(this).parent().prev().prev().children();c.preventDefault();$.each([".m-mapTitle","textarea"],function(){$(b).find(this).val("");});$.each(["Shape","Size"],function(){if($(b).find(".m-map"+this).length>0){$(b).find(".m-map"+this)[0].selectedIndex=3;}});if($(this).hasClass("clearLayers")){$(b).find(".colorPicker").val("0 0 0");}else{$(b).find(".colorPicker").val("150 150 150");}return false;});$(".clearself").click(function(b){b.preventDefault();a.clearSelf($(this));});};Mappr.bindAutocomplete=function(){var a=this,b="",c=[];$("textarea",".fieldset-regions").bind("keydown",function(d){if(d.keyCode===$.ui.keyCode.TAB&&$(this).data("autocomplete").menu.active){d.preventDefault();}}).autocomplete({source:function(e,d){$.getJSON("/places/"+a.extractLast(e.term),{},d);},search:function(){b=a.extractLast(this.value);if(b.length<2){return false;}},focus:function(){return false;},select:function(f,d){f=null;c=a.split(this.value);c.pop();c.push(d.item.value);c.push("");this.value=c.join(", ");return false;}});};Mappr.split=function(b,a){switch(a){case"[":return b.split(/\]/);default:return b.split(/,\s*/);}};Mappr.extractLast=function(a){return this.split(a).pop();};Mappr.clearSelf=function(a){var b=$(a).parent(),c=$(b).find(".colorPicker");$.each([".m-mapTitle","textarea"],function(){$(b).find(this).val("");});$.each(["Shape","Size"],function(){if($(b).find(".m-map"+this).length>0){$(b).find(".m-map"+this)[0].selectedIndex=3;}});if($(b).parent().hasClass("fieldset-points")){c.val("0 0 0");}else{c.val("150 150 150");}};Mappr.destroyJcrop=function(){var a=Mappr.vars;if(a.jzoomAPI!==undefined){a.jzoomAPI.destroy();}if(a.jcropAPI!==undefined){a.jcropAPI.destroy();}if(a.jqueryAPI!==undefined){a.jqueryAPI.destroy();}$("#mapOutputImage").show();$(".jcrop-holder").remove();$("#mapCropMessage").hide();Mappr.toggleFileFactor();};Mappr.resetJbbox=function(){this.vars.jCropType="zoom";$.each(["rubberband","query"],function(){$("#bbox_"+this).val("");});this.toggleFileFactor();};Mappr.initJcrop=function(a){var b=this,c=this.vars;b.destroyJcrop();b.resetJbbox();c.jCropType="crop";c.jcropAPI=$.Jcrop("#mapOutputImage",{bgColor:($("#mapOutputImage").attr("src")==="public/images/basemap.png")?"grey":"black",bgOpacity:0.5,onChange:b.showCoords,onSelect:b.showCoords,setSelect:a});$("#mapCropMessage").show();};Mappr.initJzoom=function(){var a=this,b=this.vars;a.destroyJcrop();a.resetJbbox();b.jCropType="zoom";b.jzoomAPI=$.Jcrop("#mapOutputImage",{addClass:"customJzoom",sideHandles:false,cornerHandles:false,dragEdges:false,bgOpacity:1,bgColor:"white",onChange:a.showCoords,onSelect:a.showCoords});$(".jcrop-tracker").mousedown(function(){a.activateJcrop("zoom");});};Mappr.initJquery=function(){var a=this,b=this.vars;a.destroyJcrop();a.resetJbbox();b.jCropType="query";b.jqueryAPI=$.Jcrop("#mapOutputImage",{addClass:"customJzoom",sideHandles:false,cornerHandles:false,dragEdges:false,bgOpacity:1,bgColor:"white",onChange:a.showCoords,onSelect:a.showCoords});$(".jcrop-tracker").mousedown(function(){a.activateJcrop("query");});};Mappr.activateJcrop=function(a){switch(a){case"zoom":$(document).bind("mouseup",this,this.aZoom);break;case"query":$(document).bind("mouseup",this,this.aQuery);break;}};Mappr.aZoom=function(b){var a=b.data;a.destroyRedo();a.showMap();$(document).unbind("mouseup",a.aZoom);};Mappr.dblclickZoom=function(c,b){var a=0,f=0,d={};d=$(c).offset();a=(b.pageX-d.left);f=(b.pageY-d.top);$("#bbox_rubberband").val(a+","+f+","+a+","+f);this.destroyRedo();this.showMap();};Mappr.aQuery=function(d){var a=d.data,b=0,f=a.vars.fillColor.r+" "+a.vars.fillColor.g+" "+a.vars.fillColor.b,c={bbox:$("#rendered_bbox").val(),bbox_query:$("#bbox_query").val(),projection:$("#projection").val(),projection_map:$("#projection_map").val(),qlayer:($("#stateprovince").prop("checked"))?"stateprovinces_polygon":"base",width:$('input[name="width"]').val(),height:$('input[name="height"]').val()};$(document).unbind("mouseup",a.aQuery);a.destroyJcrop();a.destroyRedo();a.showLoadingMessage($("#mapper-loading-message").text());$.ajax({type:"POST",url:a.settings.baseUrl+"/query/",data:c,success:function(g){if(g.length>0){var h="",e=$(".fieldset-regions").length;for(b=0;b<g.length;b+=1){h+=g[b];if(b<g.length-1){h+=", ";}}for(b=0;b<e;b+=1){if($('input[name="regions['+b+'][title]"]').val()===""||$('textarea[name="regions['+b+'][data]"]').val()===""){$('input[name="regions['+b+'][title]"]').val("Selected Region "+(b+1).toString());$('input[name="regions['+b+'][color]"]').val(f);$('textarea[name="regions['+b+'][data]"]').val(h);if(b===(e-1)&&!$('button[data-type="regions"]').is(":disabled")){a.addAccordionPanel("regions");}break;}else{if(b===(e-1)){a.addAccordionPanel("regions");e+=1;}}}$("#fieldSetsRegions").accordion("activate",b-1);a.showMap();}else{a.hideLoadingMessage();}}});};Mappr.textareaCounter=function(b,c){var a=this;switch(c){case"get":switch(b){case"coords":return a.vars.newPointCount;case"regions":return a.vars.newRegionCount;}break;case"increase":switch(b){case"coords":return(a.vars.newPointCount+=1);case"regions":return(a.vars.newRegionCount+=1);}break;case"decrease":switch(b){case"coords":return(a.vars.newPointCount-=1);case"regions":return(a.vars.newRegionCount-=1);}break;}};Mappr.addAccordionPanel=function(g){var c=this,a=c.textareaCounter(g,"get"),f=$(".addmore[data-type='"+g+"']"),h={},b=(g==="coords")?"0 0 0":"150 150 150",d=0,e=[];if(f.attr("data-type")===g){if(a<c.vars.maxTextareaCount){f.parent().prev().accordion("activate",false);h=f.parent().prev().children("div:last").clone();d=parseInt(h.find("h3 a").text().split(" ")[1],10);a=c.textareaCounter(g,"increase");h.find("h3 a").text(h.find("h3 a").text().split(" ")[0]+" "+(d+1).toString());h.find("input.m-mapTitle").attr("name",g+"["+d.toString()+"][title]").val("");h.find("textarea").attr("name",g+"["+d.toString()+"][data]").removeClass("textarea-processed").val("").each(function(){c.addGrippies(this);});h.find("select.m-mapShape").attr("name",g+"["+d.toString()+"][shape]").val("circle");h.find("select.m-mapSize").attr("name",g+"["+d.toString()+"][size]").val("10");h.find("input.colorPicker").attr("name",g+"["+d.toString()+"][color]").val(b).ColorPicker({onBeforeShow:function(){var i=$(this).val().split(" ");$(this).ColorPickerSetColor(c.RGBtoHex(i[0],i[1],i[2]));},onHide:function(i){$(i).hide();return false;},onSubmit:function(i,l,j,k){i=null;l=null;$(k).val(j.r+" "+j.g+" "+j.b);$(k).ColorPickerHide();}}).bind("keyup",function(){var i=$(this).val().split(" ");$(this).ColorPickerSetColor(c.RGBtoHex(i[0],i[1],i[2]));});e=f.parent().prev().append(h).children("div");e.each(function(j,k){k=null;if(j===e.length-1){$(this).find("button.removemore").show().click(function(i){i.preventDefault();c.removeAccordionPanel(h,g);a=c.textareaCounter(g,"decrease");}).parent().find("button.clearself").click(function(i){i.preventDefault();c.clearSelf($(this));}).parent().parent().find(".ui-icon:last").remove();}});f.parent().prev().accordion("destroy").accordion({header:"h3",collapsible:true,autoHeight:false,active:false});if(g==="regions"){c.bindAutocomplete();}}if(a>=c.vars.maxTextareaCount-3){f.attr("disabled","disabled");}}};Mappr.removeAccordionPanel=function(c,b){var a=$(".addmore[data-type='"+b+"']");c.nextAll().each(function(){var d=parseInt($(this).find("h3 a").text().split(" ")[1],10);$(this).find("h3 a").text($(this).find("h3 a").text().split(" ")[0]+" "+(d-1).toString());$(this).find("input.m-mapTitle").attr("name",b+"["+(d-2).toString()+"][title]");$(this).find("textarea").attr("name",b+"["+(d-2).toString()+"][data]");$(this).find("select.m-mapShape").attr("name",b+"["+(d-2).toString()+"][shape]");$(this).find("select.m-mapSize").attr("name",b+"["+(d-2).toString()+"][size]");$(this).find("input.colorPicker").attr("name",b+"["+(d-2).toString()+"][color]");});c.remove();a.removeAttr("disabled");};Mappr.addGrippies=function(d){var a=$(d).addClass("textarea-processed"),c=null;function e(g){a.height(Math.max(32,c+g.pageY)+"px");return false;}function f(){$(document).unbind("mousemove",e).unbind("mouseup",f);a.css("opacity",1);}function b(g){c=a.height()-g.pageY;a.css("opacity",0.25);$(document).bind("mousemove",e).bind("mouseup",f);return false;}$(d).parent().find(".grippie").bind("mousedown",b);};Mappr.bindAddButtons=function(){var a=this;$(".addmore").click(function(c){var d=$(this).attr("data-type"),b=0;c.preventDefault();a.addAccordionPanel(d);b=$(this).parent().prev().children().length;$(this).parent().prev().accordion("activate",b-1);return false;});};Mappr.loadMapList=function(b){var a=this,d=b||{},e=$(".usermaps-loading").clone(true),c={};$("#usermaps").html("").append(e.show());c={locale:a.getParameterByName("locale"),q:(d.q)?encodeURIComponent(d.q.toLowerCase()):null,uid:d.uid||null};if(d.sort){c.sort=d.sort.item;c.dir=d.sort.dir;}if(!c.locale){delete c.locale;}if(!c.q){delete c.q;}if(!c.uid){delete c.uid;}$.ajax({type:"GET",url:a.settings.baseUrl+"/usermaps/",data:c,dataType:"html",success:function(f){if(f.indexOf("session timeout")!==-1){window.location.reload();}else{$("#usermaps").find(".usermaps-loading").remove().end().html(f);$(".toolsRefresh",".grid-usermaps").click(function(g){g.preventDefault();a.loadMapList();});$("#filter-mymaps").val(d.q).keypress(function(g){if(g.which===13){g.preventDefault();c.q=$(this).val();a.loadMapList(c);a.trackEvent("maplist","filter");}}).focus();$(".ui-icon-triangle-sort",".grid-usermaps").click(function(g){g.preventDefault();c.sort={item:$(this).attr("data-sort"),dir:"asc"};if($(this).hasClass("asc")){c.sort.dir="desc";}a.loadMapList(c);a.trackEvent("maplist","sort");});$(".map-load").click(function(g){g.preventDefault();a.loadMap(this);a.trackEvent("map","load");});$(".map-delete").click(function(g){g.preventDefault();a.deleteMapConfirmation(this);});}}});};Mappr.removeExtraElements=function(){var a=this,b=0,c=$(".fieldset-points").size(),d=$(".fieldset-regions").size();if(c>3){for(b=c-1;b>=3;b-=1){$("#fieldSetsPoints div.fieldset-points:eq("+b.toString()+")").remove();}a.vars.newPointCount=0;}if(d>3){for(b=d-1;b>=3;b-=1){$("#fieldSetsRegions div.fieldset-regions:eq("+b.toString()+")").remove();}a.vars.newRegionCount=0;}};Mappr.prepareInputs=function(c){var a={},b=[];a={status:"ok",mid:$(".map-embed").attr("data-mid"),map:c};a.map.coords=a.map.coords||[];a.map.regions=a.map.regions||[];a.map.layers=a.map.layers||{};a.map.options=a.map.options||{};String.prototype.clean=function(){return this.replace(/[\[\]]/g,"");};$.each(c,function(d,e){if(d.indexOf("coords")!==-1){b=d.match(/\[[A-Za-z0-9]*?\]/g);if(b){if(a.map.coords[parseInt(b[0].clean(),10)]===undefined){a.map.coords[parseInt(b[0].clean(),10)]={};}a.map.coords[parseInt(b[0].clean(),10)][b[1].clean()]=e;delete a.map["coords"+b[0]+b[1]];}}if(d.indexOf("regions")!==-1){b=d.match(/\[[A-Za-z0-9]*?\]/g);if(b){if(a.map.regions[parseInt(b[0].clean(),10)]===undefined){a.map.regions[parseInt(b[0].clean(),10)]={};}a.map.regions[parseInt(b[0].clean(),10)][b[1].clean()]=e;delete a.map["regions"+b[0]+b[1]];}}if(d.indexOf("layers")!==-1){b=d.match(/\[[A-Za-z0-9]*?\]/g);if(b){a.map.layers[b[0].clean()]=e;delete a.map["layers"+b[0]];}}if(d.indexOf("options")!==-1){b=d.match(/\[[A-Za-z0-9]*?\]/g);if(b){a.map.options[b[0].clean()]=e;delete a.map["options"+b[0]];}}if(d==="save[title]"){a.map.save={title:e};delete a.map["save[title]"];}if(d==="gridspace"){a.map.grid_space=e;}if(d==="download-filetype"){a.map.download_filetype=e;}if(d==="download-factor"){a.map.download_factor=e;}});return a;};Mappr.loadInputs=function(c){var a=this,b=$("#filter-mymaps").val();a.removeExtraElements();$("#form-mapper").clearForm();$.each(["width","height"],function(){$('input[name="'+this+'"]').val($('input[name="'+this+'"]').val());});$("#filter-mymaps").val(b);a.loadCoordinates(c);a.loadRegions(c);a.loadLayers(c);a.loadSettings(c);};Mappr.loadMap=function(b){var a=this,c=$(b).attr("data-mid");a.tabSelector(0);a.showLoadingMessage($("#mapper-loading-message").text());$.ajax({type:"GET",url:a.settings.baseUrl+"/usermaps/"+c,dataType:"json",success:function(d){a.loadInputs(d);a.showMap(d);a.bindStorage();a.activateEmbed(c);a.toggleUndo();a.toggleRedo();}});};Mappr.loadSettings=function(e){var d=/[?*:;{}\\ "']+/g,a="",c="",b=this;a=e.map.save.title;$('input[name="save[title]"]').val(a);$(".m-mapSaveTitle").val(a);$("#mapTitle").text(a);a=a.replace(d,"_");$("#file-name").val(a);$("#projection").val(e.map.projection);$.each(["bbox_map","projection_map","rotation"],function(){$('input[name="'+this+'"]').val(e.map[this]);});$('input[name="border_thickness"]').val(1.25);$("#border-slider").slider({value:1.25});if(e.map.border_thickness!==undefined&&e.map.border_thickness){$('input[name="border_thickness"]').val(e.map.border_thickness);$("#border-slider").slider({value:e.map.border_thickness});}b.setRotation(e.map.rotation);b.resetJbbox();$.each(["border","legend","scalebar"],function(){$("#"+this).attr("checked",false);$('input[name="options['+this+']"]').val("");});if(e.map.options!==undefined){$.each(["border","legend","scalebar"],function(){if(e.map.options[this]&&e.map.options[this]!==undefined){$("#"+this).attr("checked",true);$('input[name="options['+this+']"]').val(1);}});}if(e.map.download_factor!==undefined&&e.map.download_factor){$('input[name="download_factor"]').val(e.map.download_factor);$("#download-factor-"+e.map.download_factor).attr("checked",true);}else{$("#download-factor-3").attr("checked",true);}if(e.map.download_filetype!==undefined&&e.map.download_filetype){$('input[name="download_filetype"]').val(e.map.download_filetype);c=$("#download-"+e.map.download_filetype).attr("checked",true);b.toggleFileType(c);}else{$("#download-svg").attr("checked",true);}if(e.map.grid_space!==undefined&&e.map.grid_space){$('input[name="gridspace"]').attr("checked",false);$("#gridspace-"+e.map.grid_space).attr("checked",true);}else{$("#gridspace").attr("checked",true);}if(e.map.gridlabel!==undefined&&e.map.gridlabel){$('input[name="gridlabel"]').attr("checked",true).val("false");}else{$("#gridlabel").attr("checked",false);}};Mappr.loadCropSettings=function(c){var b=this,a=[];if(c.map.bbox_rubberband){a=c.map.bbox_rubberband.split(",");b.initJcrop([a[2],a[3],a[0],a[1]]);b.toggleFileFactor(c.map.download_factor);}else{b.destroyJcrop();}};Mappr.loadShapeSize=function(a,b){$.each(["shape","size"],function(){if(b[a][this].toString()===""){$('select[name="coords['+a.toString()+"]["+this+']"]')[0].selectedIndex=3;}else{$('select[name="coords['+a.toString()+"]["+this+']"]').val(b[a][this]);}});};Mappr.loadCoordinates=function(g){var a=this,c=0,f=g.map.coords||[],b="",d="",h="",e=/[?*{}\\]+/g;for(c=0;c<f.length;c+=1){if(c>2){a.addAccordionPanel("coords");}b=f[c].title||"";d=f[c].data.replace(e,"")||"";h=f[c].color||"0 0 0";$('input[name="coords['+c.toString()+'][title]"]').val(b);$('textarea[name="coords['+c.toString()+'][data]"]').val(d);a.loadShapeSize(c,f);$('input[name="coords['+c.toString()+'][color]"]').val(h);}};Mappr.loadRegions=function(f){var c=this,d=0,g=f.map.regions||[],b="",a="",e="";for(d=0;d<g.length;d+=1){if(d>2){c.addAccordionPanel("regions");}b=g[d].title||"";a=g[d].data||"";e=g[d].color||"150 150 150";$('input[name="regions['+d.toString()+'][title]"]').val(b);$('textarea[name="regions['+d.toString()+'][data]"]').val(a);$('input[name="regions['+d.toString()+'][color]"]').val(e);}};Mappr.loadLayers=function(c){var b=0,d=[],a=0;if(c.map.layers){for(a in c.map.layers){if(c.map.layers.hasOwnProperty(a)){d[d.length]=a;}}for(b=0;b<d.length;b+=1){$('input[name="layers['+d[b]+']"]').attr("checked",true);}}};Mappr.activateEmbed=function(b){var a=this,c=["img","kml","svg","json"];$(".map-embed").attr("data-mid",b).css("display","block").click(function(d){d.preventDefault();$.each(c,function(){if(this.toString()==="img"){$("#embed-"+this,"#mapEmbed").val('<img src="'+a.settings.baseUrl+"/map/"+b+'" alt="" />');}else{$("#embed-"+this,"#mapEmbed").val(a.settings.baseUrl+"/map/"+b+"."+this);}});$("#mapEmbed").find("span.mid").text(b).end().dialog({width:(525).toString(),autoOpen:true,modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy");}}]}).show();});};Mappr.deleteMapConfirmation=function(c){var a=this,d=$(c).attr("data-mid"),b="<em>"+$(c).parent().parent().find(".title").text()+"</em>";$("#mapper-message-delete").find("span").html(b).end().dialog({height:(250).toString(),width:(500).toString(),modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:$("#button-titles span.delete").text(),"class":"negative",click:function(){$.ajax({type:"DELETE",url:a.settings.baseUrl+"/usermaps/"+d,success:function(){a.loadMapList();a.trackEvent("map","delete");}});$(this).dialog("destroy");}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy");}}]}).show();};Mappr.loadUserList=function(b){var a=this,e=$(".userdata-loading").clone(true),d=b||{},c={locale:this.getParameterByName("locale")};$("#userdata").html("").append(e.show());if(d.sort){c.sort=d.sort.item;c.dir=d.sort.dir;}if(!c.locale){delete c.locale;}$.ajax({type:"GET",url:a.settings.baseUrl+"/users/",data:c,dataType:"html",success:function(f){if(f.indexOf("access denied")!==-1){window.location.reload();}else{$("#userdata").find(".userdata-loading").remove().end().html(f);$(".toolsRefresh",".grid-users").click(function(g){g.preventDefault();a.loadUserList();});$(".ui-icon-triangle-sort",".grid-users").click(function(g){g.preventDefault();c.sort={item:$(this).attr("data-sort"),dir:"asc"};if($(this).hasClass("asc")){c.sort.dir="desc";}a.loadUserList(c);});$(".user-delete").click(function(g){g.preventDefault();a.deleteUserConfirmation(this);});$(".user-load").click(function(g){g.preventDefault();a.tabSelector(3);a.loadMapList({uid:$(this).attr("data-uid")});});}}});};Mappr.getLanguage=function(){var b="",a=this.getParameterByName("locale");if(a==="fr_FR"||a==="es_ES"){b="?locale="+a;}return b;};Mappr.deleteUserConfirmation=function(c){var a=this,d=$(c).attr("data-uid"),b="<em>"+$(c).parent().parent().children("td:first").html()+"</em>";$("#mapper-message-delete").find("span").html(b).end().dialog({height:(250).toString(),width:(500).toString(),modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:$("#button-titles span.delete").text(),"class":"negative",click:function(){$.ajax({type:"DELETE",url:a.settings.baseUrl+"/users/"+d,success:function(){a.loadUserList();a.trackEvent("user","delete");}});$(this).dialog("destroy");}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy");}}]}).show();};Mappr.bindSave=function(){var a=this;$(".map-save").click(function(b){b.preventDefault();a.mapSave();});};Mappr.mapSave=function(){var c=false,b=/[?*:;{}\\ "'\/@#!%\^()<>.]+/g,a="";$("#mapSave").dialog({autoOpen:true,height:(175).toString(),width:(350).toString(),modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:$("#button-titles span.save").text(),"class":"positive",click:function(){if($.trim($(".m-mapSaveTitle").val())===""){c=true;}if(c){$(".m-mapSaveTitle").addClass("ui-state-error").keyup(function(){$(this).removeClass("ui-state-error");});}else{$('input[name="save[title]"]').val($(".m-mapSaveTitle").val());$.each(["factor","filetype"],function(){$('input[name="download_'+this+'"]').val($('input[name="download-'+this+'"]:checked').val());});$('input[name="grid_space"]').val($('input[name="gridspace"]:checked').val());Mappr.setFormOptions();Mappr.showLoadingMessage($("#mapper-saving-message").text());if(Mappr.vars.jcropAPI===undefined){$("#bbox_rubberband").val("");}$.ajax({type:"POST",url:Mappr.settings.baseUrl+"/usermaps/",data:$("form").serialize(),dataType:"json",success:function(d){$("#mapTitle").text($(".m-mapSaveTitle").val());a=$(".m-mapSaveTitle").val().replace(b,"_");$("#file-name").val(a);Mappr.activateEmbed(d.mid);Mappr.loadMapList();Mappr.hideLoadingMessage();Mappr.trackEvent("map","save");}});$(this).dialog("destroy");}}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy");}}]});};Mappr.bindDownload=function(){var a=this;$(".map-download").click(function(b){b.preventDefault();a.mapDownload();});};Mappr.mapDownload=function(){$("#mapExport").dialog({autoOpen:true,width:(620).toString(),modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:$("#button-titles span.download").text(),"class":"positive",click:function(){Mappr.generateDownload();}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy");}}]});};Mappr.bindSubmit=function(){var a=this,c="",b=false;$(".submitForm").click(function(d){d.preventDefault();b=false;$(".m-mapCoord").each(function(){c=$(this).parents(".ui-accordion-content").find(".m-mapTitle").keyup(function(){b=false;$(this).removeClass("ui-state-error");});if($(this).val()&&$(c).val()===""){b=true;$(c).addClass("ui-state-error");}});if(b){a.showMessage($("#mapper-missing-legend").text());}else{a.destroyRedo();a.showMap();a.tabSelector(0);}});};Mappr.mapToggleSettings=function(){$("#mapToolsCollapse a").trigger("click");};Mappr.bindPanelToggle=function(){var a=this;$("#mapToolsCollapse a").tipsy({gravity:"e"}).toggle(function(b){b.preventDefault();$("#mapOutputImage").attr("width",0).attr("height",0);$("#mapOutputScale").hide();$(this).parent().addClass("mapTools-collapsed");$("#mapTools").hide("slide",{direction:"right"},250,function(){var c=$(window).width()*0.98;$("#actionsBar").animate({width:c},250);$("#map").animate({width:c},250,function(){$('input[name="width"]').val(c);a.mapRefresh();});});},function(b){b.preventDefault();$("#mapOutputImage").attr("width",0).attr("height",0);$("#mapOutputScale").hide();$(this).parent().removeClass("mapTools-collapsed");$("#mapTools").show("slide",{direction:"right"},250,function(){$("#actionsBar").animate({width:"810px"},250);$("#map").animate({width:"800px"},function(){$('input[name="width"]').val(800);a.mapRefresh();});});});};Mappr.showMessage=function(a){$("#mapper-message").html(a).dialog({autoOpen:true,height:(200).toString(),width:(400).toString(),modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy");}}]}).show();};Mappr.drawLegend=function(){var a=$("#legend_url").val();if(a){$("#mapLegend").html('<img src="'+a+'" />');}else{$("#mapLegend").html("<p><em>"+$("#mapper-legend-message").text()+"</em></p>");}};Mappr.drawScalebar=function(){$("#mapScale img").attr("src",$("#scalebar_url").val()).show();};Mappr.showBadPoints=function(){var a=$("#bad_points").val();if(a){$("#badRecords").html(a);$("#badRecordsWarning").show();}};Mappr.showLoadingMessage=function(b){var a='<span class="mapper-loading-message ui-corner-all ui-widget-content">'+b+"</span>";$("#mapOutput").append(a);};Mappr.hideLoadingMessage=function(){$("#mapOutput .mapper-loading-message").remove();};Mappr.showMap=function(f){var b=this,c=new Date().getTime(),e="",a={},d=false;b.destroyJcrop();$("#output").val("pnga");$("#badRecordsWarning").hide();$("#download_token").val(c);e=$("form").serialize();a=$("form").serializeJSON();if(a["layers[relief]"]||a["layers[reliefgrey]"]||e.length>7000||a.projection!=="epsg:4326"){d=true;}b.postData(e,f,d);$.jStorage.set("do-"+c.toString(),a);b.toggleUndo(true);};Mappr.postData=function(c,d,a){var b=this;if(a){b.showLoadingMessage($("#mapper-loading-message").text());}$.ajax({type:"POST",url:b.settings.baseUrl+"/application/",data:c,dataType:"json",success:function(e){b.resetFormValues(e);b.resetJbbox();b.drawMap(e,d);b.drawLegend();b.drawScalebar();b.showBadPoints();b.addBadRecordsViewer();}});};Mappr.resetFormValues=function(a){$("#mapOutput input").each(function(){$(this).val("");});$.each(["rendered_bbox","rendered_rotation","rendered_projection","legend_url","scalebar_url","bad_points"],function(){$("#"+this).val(a[this]);if(this==="rendered_bbox"){$("#bbox_map").val($("#"+this).val());}if(this==="rendered_projection"){$("#projection_map").val($("#"+this).val());}if(this==="rendered_rotation"){$("#rotation").val($("#"+this).val());}});$("#pan").val("");};Mappr.drawMap=function(b,c){var a=this;$("#mapOutputImage").attr("width",b.size[0]).attr("height",b.size[1]).attr("src",b.mapOutputImage).one("load",function(){if(!c){c={map:{bbox_rubberband:""}};}a.loadCropSettings(c);a.hideLoadingMessage();});};Mappr.addBadRecordsViewer=function(){var a=this;$("#badRecordsViewer").dialog({autoOpen:false,height:(200).toString(),width:(500).toString(),position:[200,200],modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy");}}]});$(".toolsBadRecords").click(function(b){b.preventDefault();a.addBadRecordsViewer();$("#badRecordsViewer").dialog("open");});};Mappr.generateDownload=function(){var b=this,e=/[~$?*,:;{}\[\]\\ "'\/@#!%\^()<>.+=|`&]+/g,a=$("#file-name").val(),d=new Date().getTime().toString(),g="",f="",c="png";a=a.replace(e,"_");$("#file-name").val(a);$('input[name="file_name"]').val(a);$('input[name="download_factor"]').val($('input[name="download-factor"]:checked').val());c=$("input[name='download-filetype']:checked").val();b.setFormOptions();$("#download_token").val(d);$.each(["ui-dialog-buttonpane","download-dialog"],function(){$("."+this).hide();});$(".download-message").show();switch(c){case"pptx":$("#output").val("pptx");if(b.vars.jcropAPI){$("#crop").val(1);}else{b.resetJbbox();}f=$("form").serialize();$("body").download("/application/pptx/"+b.getLanguage(),f,"post");$("#output").val("pnga");break;case"docx":$("#output").val("docx");if(b.vars.jcropAPI){$("#crop").val(1);}else{b.resetJbbox();}f=$("form").serialize();$("body").download("/application/docx/"+b.getLanguage(),f,"post");$("#output").val("pnga");break;case"kml":f=$("form").serialize();$("body").download("/application/kml/",f,"post");break;default:$("#download").val(1);$("#output").val(c);if(b.vars.jcropAPI){$("#crop").val(1);}else{b.resetJbbox();}f=$("form").serialize();$("body").download("/application/",f,"post");$("#download").val("");$("#output").val("pnga");}b.vars.fileDownloadTimer=window.setInterval(function(){g=$.cookie("fileDownloadToken");if(g===d){b.finishDownload();}},1000);b.trackEvent("download",c);};Mappr.setFormOptions=function(){$.each(["border","legend","scalebar"],function(){if($("#"+this).prop("checked")){$('input[name="options['+this+']"]').val(1);}else{$('input[name="options['+this+']"]').val("");}});};Mappr.finishDownload=function(){$(".download-message").hide();$.each(["download-dialog","ui-dialog-buttonpane"],function(){$("."+this).show();});window.clearInterval(this.vars.fileDownloadTimer);$.cookie("fileDownloadToken",null);};Mappr.showExamples=function(){var a='<img src="public/images/help-data.png" alt="" />';$("#mapper-message-help").html(a).dialog({height:(350).toString(),width:(525).toString(),autoOpen:true,modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy");}}]}).show();};Mappr.showCodes=function(){var a=(this.getParameterByName("locale"))?{locale:this.getParameterByName("locale")}:{};$("#mapper-message-codes").dialog({height:(450).toString(),width:(850).toString(),autoOpen:true,modal:true,closeOnEscape:false,draggable:true,resizable:false,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy");}}]}).show();if($("#mapper-message-codes .mapper-loading-message").length>0){this.loadCodes($("#mapper-message-codes"),a);}};Mappr.loadCodes=function(c,d){var a=this,b="";c.find("tbody tr td").text("\xa0");c.find("tbody tr td:first").text("\xa0\xa0\xa0").addClass("loading");$.ajax({type:"GET",url:a.settings.baseUrl+"/places/",data:d,dataType:"html",success:function(e){c.html(e);b=c.find(".filter-countries");b.val("");if(d.filter!==undefined){b.val(d.filter);}b.keypress(function(g){var f=g.keyCode||g.which;if(f===13||f===9){g.preventDefault();d.filter=b.val();a.loadCodes(c,d);}});b.blur(function(){d.filter=b.val();a.loadCodes(c,d);});}});};Mappr.performRotation=function(a){$("#rotation").val($(a).attr("data-rotate"));this.resetJbbox();this.destroyRedo();this.showMap();this.trackEvent("rotate",$(a).attr("data-rotate"));};Mappr.setRotation=function(f){var e=$("#mapControls"),a=$(".thumb",e),g=$(".overview",e).children(),b=0,d=0,c=0;if(!f){f=0;}f=parseFloat(f)<0?parseFloat(f)+360:parseFloat(f);b=f*(Math.PI/180);$(".overview",e).css("left",-(f/360*((g.outerWidth(true)*(g.length))))+"px");c=Math.round(-Math.cos(b)*28+(e.outerHeight()/2-a.outerHeight()/2))+"px";d=Math.round(Math.sin(b)*28+(e.outerWidth()/2-a.outerWidth()/2))+"px";$(".thumb",e).css("top",c).css("left",d);};Mappr.getParameterByName=function(c){var b=c.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),a="[\\?&]"+b+"=([^&#]*)",e=new RegExp(a),d=e.exec(window.location.href);if(d===null){return"";}return decodeURIComponent(d[1].replace(/\+/g," "));};Mappr.mapCircleSlider=function(){var b=0,a="";for(b=0;b<360;b+=1){if(b%5===0){a+='<li data-rotate="'+b+'"></li>';}}return a;};Mappr.clearStorage=function(){this.destroyRedo();$.jStorage.flush();};Mappr.bindStorage=function(){var b={},a=new Date().getTime();this.clearStorage();b=$("form").serializeJSON();$.jStorage.set("do-"+a.toString(),b);};Mappr.bindRotateWheel=function(){var a=this;$(".overlay","#mapControls").css("background-image",'url("public/images/bg-rotatescroll.png")');$(".overview","#mapControls").append(a.mapCircleSlider());$("#mapControls").tinycircleslider({snaptodots:true,radius:28,callback:function(c,b){b=null;if($("#initial-message").is(":hidden")){a.performRotation(c);}}});};Mappr.bindTabs=function(){var d=$("#tabs"),e="tabs",a="ul.navigation a",c={cache:true,load:function(g,f){g=null;$(f.tab).data("cache.tabs",($(f.panel).html()==="")?false:true);},event:"change"},b="";$("#mapTools").tabs({selected:0});d.tabs(c).find(".ui-state-disabled").each(function(){$(this).removeClass("ui-state-disabled");}).end().show();d.find(a).click(function(){var g={},f=$(this).parent().prevAll().length;g[e]=f;$.bbq.pushState(g);$.each($("#site-languages a"),function(){var h=$(this).attr("href").split("#")[0];$(this).attr("href",h+"#"+e+"="+f);});});$(window).bind("hashchange",function(g){var f=$.bbq.getState(e,true)||0;d.find(a).eq(f).triggerHandler("change");$.each($("#site-languages a"),function(){var h=$(this).attr("href").split("#")[0];$(this).attr("href",h+"#"+e+"="+f);});});$(window).trigger("hashchange");};Mappr.init=function(){var a=this;this.bindRotateWheel();$("#initial-message").hide();$("#header>div").show();this.bindTabs();$("#mapOutput").append('<img id="mapOutputImage" src="public/images/basemap.png" alt="" width="800" height="400" />').find("span.mapper-loading-message").remove();$("#mapScale").append('<img id="mapOutputScale" src="public/images/basemap-scalebar.png" width="200" height="27" />');$("a.login","#site-session").click(function(b){b.preventDefault();a.tabSelector(3);});$("a.show-examples").click(function(b){b.preventDefault();a.showExamples();});$("a.show-codes").click(function(b){b.preventDefault();a.showCodes();});$(".fieldSets").accordion({header:"h3",collapsible:true,autoHeight:false});$(".tooltip").tipsy({gravity:"s"});this.bindStorage();this.bindHotkeys();this.bindToolbar();this.bindArrows();this.bindSettings();this.bindSlider();this.bindColorPickers();this.bindAddButtons();this.bindClearButtons();this.bindAutocomplete();this.bindSave();this.bindDownload();this.bindSubmit();this.bindPanelToggle();$(".toolsUndoDisabled").click(false);$(".toolsRedoDisabled").click(false);$("textarea.resizable:not(.textarea-processed)").TextAreaResizer();if($("#usermaps").length>0){this.tabSelector(3);this.loadMapList();}if($("#userdata").length>0){this.tabSelector(4);this.loadUserList();}$("input").keypress(function(b){if(b.which===13){return false;}});};Mappr.init();});