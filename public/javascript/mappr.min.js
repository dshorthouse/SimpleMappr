/*global $, jQuery, window, document, self, XMLHttpRequest, alert, encodeURIComponent, _gaq */
var Mappr=Mappr||{settings:{}};
$(function(){"use strict";Mappr.settings={baseUrl:Mappr.settings.baseUrl||"",active:Mappr.settings.active||!1};Mappr.vars={newPointCount:0,newRegionCount:0,maxTextareaCount:10,zoom:!0,fileDownloadTimer:{},fillColor:"",jCropType:"zoom",cropUpdated:!1,undoSize:10};$.ajaxSetup({xhr:function(){return new XMLHttpRequest}});$(window).resize(function(){var a=Mappr.getPageSize(),b=Mappr.getPageScroll();$("#mapper-overlay").css({width:a[0],height:a[1]});$("#mapper-message").css({top:b[1]+a[3]/10,left:b[0],position:"fixed",
zIndex:1001,margin:"0px auto",width:"100%"})});Mappr.trackEvent=function(a,b){void 0!==window._gaq&&_gaq.push(["_trackEvent",a,b])};Mappr.getPageSize=function(){var a,b,c,d;window.innerHeight&&window.scrollMaxY?(a=window.innerWidth+window.scrollMaxX,b=window.innerHeight+window.scrollMaxY):document.body.scrollHeight>document.body.offsetHeight?(a=document.body.scrollWidth,b=document.body.scrollHeight):(a=document.body.offsetWidth,b=document.body.offsetHeight);self.innerHeight?(c=document.documentElement.clientWidth?
document.documentElement.clientWidth:self.innerWidth,d=self.innerHeight):document.documentElement&&document.documentElement.clientHeight?(c=document.documentElement.clientWidth,d=document.documentElement.clientHeight):document.body&&(c=document.body.clientWidth,d=document.body.clientHeight);return[a<c?a:c,b<d?d:b,c,d]};Mappr.getPageScroll=function(){var a,b;self.pageYOffset?(b=self.pageYOffset,a=self.pageXOffset):document.documentElement&&document.documentElement.scrollTop?(b=document.documentElement.scrollTop,
a=document.documentElement.scrollLeft):document.body&&(b=document.body.scrollTop,a=document.body.scrollLeft);return[a,b]};Mappr.showCoords=function(a){var b=parseFloat(a.x),c=parseFloat(a.y),d=parseFloat(a.x2),e=parseFloat(a.y2),f=parseFloat(a.w),a=parseFloat(a.h),g={x:b,y:c},h={x:d,y:e},i={},j={},k=$('input[name="download-factor"]:checked').val();switch(Mappr.vars.jCropType){case "crop":$(".jcrop-holder div:first").css("backgroundColor","white");$("#bbox_rubberband").val(b+","+c+","+d+","+e);"epsg:4326"===
$("#projection option:selected").val()?$(".jcrop-coord").css("width","100px"):$(".jcrop-coord").css("width","175px");0===$("#jcrop-coord-ul").length&&0===$("#jcrop-coord-lr").length&&$(".jcrop-tracker").eq(0).after('<input type="text" id="jcrop-coord-ul" class="jcrop-coord"></input>').after('<input type="text" id="jcrop-coord-lr" class="jcrop-coord"></input>').after('<div id="jcrop-dimension-wrapper"><input type="text" id="jcrop-dimension-w" class="jcrop-dimension"></input>X<input type="text" id="jcrop-dimension-h" class="jcrop-dimension"></input></div>');
i=Mappr.pix2geo(g);j=Mappr.pix2geo(h);$("#jcrop-coord-ul").val(i.x+", "+i.y);$("#jcrop-coord-lr").val(j.x+", "+j.y);$("#jcrop-dimension-w").val(f);$("#jcrop-dimension-h").val(a);$("#jcrop-dimension-wrapper").css({left:f/2-$("#jcrop-dimension-wrapper").width()/2,top:a/2-$("#jcrop-dimension-wrapper").height()/2});$.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+$("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+$("#jcrop-coord-lr").val()+'" }');$(".jcrop-coord").live("blur",function(){Mappr.vars.cropUpdated||
(Mappr.vars.cropUpdated=Mappr.updateCropCoordinates())}).live("keypress",function(a){var b=a.keyCode||a.which;if(13===b||9===b)a.preventDefault(),Mappr.vars.cropUpdated=!1,this.blur()});$(".jcrop-dimension").live("blur",function(){Mappr.vars.cropUpdated||(Mappr.vars.cropUpdated=Mappr.updateCropDimensions())}).live("keypress",function(a){var b=a.keyCode||a.which;if(13===b||9===b)a.preventDefault(),Mappr.vars.cropUpdated=!1,this.blur()});$("span","#scale-measure").text(k*f+" X "+k*a).parent().show();
break;case "zoom":$(".jcrop-holder div:first").css("backgroundColor","white");$("#bbox_rubberband").val(b+","+c+","+d+","+e);break;case "query":$("#bbox_query").val(b+","+c+","+d+","+e)}};Mappr.updateCropDimensions=function(){var a=$("#bbox_rubberband").val().split(","),b=parseFloat(a[2])-parseFloat(a[0]),c=parseFloat(a[3])-parseFloat(a[1]),d=$("#mapOutputImage").width(),e=$("#mapOutputImage").height(),f=$("#jcrop-dimension-w").val(),g=$("#jcrop-dimension-h").val(),h=a[0],i=a[2],j=a[1],k=a[3],f=f>
d?d:(b-f)/2,g=g>e?e:(c-g)/2,h=parseFloat(a[2])-f,i=parseFloat(a[0])+f,j=parseFloat(a[1])+g,k=parseFloat(a[3])-g;f>=d&&(h=0,i=d);g>=e&&(j=0,k=e);this.loadCropSettings({map:{bbox_rubberband:h.toString()+","+j.toString()+","+i.toString()+","+k.toString()}});return!0};Mappr.updateCropCoordinates=function(){var a=[],a={},b=[],b={},a=$("#jcrop-coord-ul").val().split(","),a=this.geo2pix({x:$.trim(a[0]),y:$.trim(a[1])}),b=$("#jcrop-coord-lr").val().split(","),b=this.geo2pix({x:$.trim(b[0]),y:$.trim(b[1])});
$.cookie("jcrop_coords",'{ "jcrop_coord_ul" : "'+$("#jcrop-coord-ul").val()+'", "jcrop_coord_lr" : "'+$("#jcrop-coord-lr").val()+'" }');this.loadCropSettings({map:{bbox_rubberband:b.x+","+b.y+","+a.x+","+a.y}});return!0};Mappr.pix2geo=function(a){var b=0,c=0,d=$("#bbox_map").val(),e=parseFloat($("#mapOutputImage").width()),f=parseFloat($("#mapOutputImage").height()),g={};""===d&&(d="-180,-90,180,90");d=d.split(",");b=Math.abs(parseFloat($.trim(d[2]))-parseFloat($.trim(d[0])));c=Math.abs(parseFloat($.trim(d[3]))-
parseFloat($.trim(d[1])));g.x=this.roundNumber(parseFloat(d[0])+parseFloat(a.x)*b/e,2);g.y=this.roundNumber(parseFloat(d[1])+parseFloat(f-parseFloat(a.y))*c/f,2);return g};Mappr.geo2pix=function(a){var b=0,c=0,d=$("#bbox_map").val(),e={};""===d&&(d="-180,-90,180,90");d=d.split(",");b=Math.abs(parseFloat($.trim(d[2]))-parseFloat($.trim(d[0])));c=Math.abs(parseFloat($.trim(d[3]))-parseFloat($.trim(d[1])));e.x=$("#mapOutputImage").width()*Math.abs(parseFloat(a.x)-parseFloat($.trim(d[0])))/b;e.y=$("#mapOutputImage").height()*
(c-Math.abs(parseFloat(a.y)-parseFloat($.trim(d[1]))))/c;return e};Mappr.roundNumber=function(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)};Mappr.tabSelector=function(a){var b={};$("#tabs").tabs("select",a);b.tabs=a;$.bbq.pushState(b)};Mappr.RGBtoHex=function(a,b,c){return this.toHex(a)+this.toHex(b)+this.toHex(c)};Mappr.toHex=function(a){if(null===a)return"00";a=parseInt(a,10);if(0===a||isNaN(a))return"00";a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return"0123456789ABCDEF".charAt((a-
a%16)/16)+"0123456789ABCDEF".charAt(a%16)};Mappr.bindToolbar=function(){var a=this;$("#actionsBar ul li").hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")});$(".toolsZoomIn").click(function(b){b.preventDefault();a.mapZoomIn();a.trackEvent("toolbar","zoomin")});$(".toolsZoomOut").click(function(b){b.preventDefault();a.mapZoomOut();a.trackEvent("toolbar","zoomout")});$(".toolsCrop").click(function(b){b.preventDefault();a.mapCrop();a.trackEvent("toolbar",
"crop")});$(".toolsQuery").ColorPicker({onBeforeShow:function(){$(this).ColorPickerSetColor(a.RGBtoHex(150,150,150))},onShow:function(b){$(b).show();a.destroyJcrop();return!1},onHide:function(a){$(a).hide();return!1},onSubmit:function(b,c,d,e){$(e).ColorPickerHide();a.vars.fillColor=d;a.initJquery();a.vars.zoom=!1;a.trackEvent("toolbar","query")}}).click(function(b){b.preventDefault();a.resetJbbox()});$(".toolsRefresh").click(function(b){b.preventDefault();a.mapRefresh();a.trackEvent("toolbar","refresh")});
$(".toolsRebuild").click(function(b){b.preventDefault();a.mapRebuild();a.trackEvent("toolbar","rebuild")})};Mappr.mapCrop=function(){var a={},b=[],b={},a=[],a={};$.cookie("jcrop_coords")?(a=$.parseJSON($.cookie("jcrop_coords")),b=a.jcrop_coord_ul.split(","),a=a.jcrop_coord_lr.split(","),b=Mappr.geo2pix({x:$.trim(b[0]),y:$.trim(b[1])}),a=Mappr.geo2pix({x:$.trim(a[0]),y:$.trim(a[1])}),Mappr.loadCropSettings({map:{bbox_rubberband:a.x+","+a.y+","+b.x+","+b.y}})):Mappr.initJcrop();Mappr.vars.zoom=!1};
Mappr.resetAndBuild=function(){Mappr.resetJbbox();Mappr.destroyRedo();Mappr.showMap()};Mappr.mapRefresh=function(){Mappr.resetAndBuild();Mappr.tabSelector(0)};Mappr.mapRebuild=function(){$.each("bbox_map projection_map bbox_rubberband rotation projection pan".split(" "),function(){$("#"+this).val("")});Mappr.destroyRedo();Mappr.showMap()};Mappr.bindArrows=function(){var a=this;$(".arrows").click(function(b){b.preventDefault();$("#pan").val($(this).attr("data-pan"));a.resetJbbox();a.showMap();a.trackEvent("arrows",
$(this).attr("data-pan"))})};Mappr.mapPanUp=function(){$("#pan").val("up");Mappr.resetAndBuild()};Mappr.mapPanDown=function(){$("#pan").val("down");Mappr.resetAndBuild()};Mappr.mapPanLeft=function(){$("#pan").val("left");Mappr.resetAndBuild()};Mappr.mapPanRight=function(){$("#pan").val("right");Mappr.resetAndBuild()};Mappr.mapList=function(){Mappr.tabSelector(3)};Mappr.mapZoomIn=function(){Mappr.initJzoom();Mappr.vars.zoom=!0};Mappr.mapZoomOut=function(){Mappr.resetJbbox();$("#zoom_out").val(1);Mappr.destroyRedo();
Mappr.showMap();$("#zoom_out").val("")};Mappr.storageType=function(a){var b=0;return b=$.grep($.jStorage.index(),function(b){return b.substring(0,a.length)===a})};Mappr.toggleUndo=function(a){var b=this,c=this.storageType("do");$(".toolsUndo").addClass("toolsUndoDisabled").removeClass("toolsUndo").unbind("click");a&&1<c.length&&(c.length>b.vars.undoSize&&$.jStorage.deleteKey(c.shift()),$(".toolsUndoDisabled").addClass("toolsUndo").removeClass("toolsUndoDisabled").bind("click",function(a){a.preventDefault();
b.mapUndo();b.trackEvent("edit","undo")}))};Mappr.toggleRedo=function(a){var b=this;$(".toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").unbind("click");a&&$(".toolsRedoDisabled").addClass("toolsRedo").removeClass("toolsRedoDisabled").bind("click",function(a){a.preventDefault();b.mapRedo();b.trackEvent("edit","redo")})};Mappr.destroyRedo=function(){var a=Mappr.storageType("undo");0<a.length&&($(".toolsRedo").addClass("toolsRedoDisabled").removeClass("toolsRedo").unbind("click"),
$.jStorage.deleteKey(a.pop()))};Mappr.mapUndo=function(){var a=Mappr.storageType("do"),b="",c={},d="",d={},e={},f=!1;if(1!==a.length){Mappr.destroyRedo();b=a[a.length-1];c=$.jStorage.get(b);d=a[a.length-2];d=$.jStorage.get(d);e=Mappr.prepareInputs(d);Mappr.loadInputs(e);$.jStorage.deleteKey(b);$.jStorage.set("un"+b,c);if(d.width!==c.width)Mappr.mapToggleSettings();else{if(d.layers.relief||d.layers.reliefgrey||7E3<JSON.stringify(d).length||"epsg:4326"!==d.projection)f=!0;Mappr.postData(decodeURIComponent($.param(d)),
null,f)}Mappr.toggleRedo(!0);2===a.length&&Mappr.toggleUndo()}};Mappr.mapRedo=function(){var a=Mappr.storageType("undo"),b="",c={},d={},d=Mappr.storageType("do"),e="",e={},f=(new Date).getTime(),g=!1;if(0!==a.length){Mappr.toggleRedo();b=a.pop();c=$.jStorage.get(b);e=d[d.length-1];e=$.jStorage.get(e);d=Mappr.prepareInputs(c);Mappr.loadInputs(d);$.jStorage.deleteKey(b);$.jStorage.set("do-"+f.toString(),c);if(c.width!==e.width)Mappr.mapToggleSettings();else{if(c.layers.relief||c.layers.reliefgrey||
7E3<JSON.stringify(c).length||"epsg:4326"!==c.projection)g=!0;Mappr.postData(decodeURIComponent($.param(c)),null,g)}Mappr.toggleUndo(!0)}};Mappr.bindHotkeys=function(){var a=this,b={},c={},b={"ctrl+s":a.mapSave,"ctrl+d":a.mapDownload,"ctrl+l":a.mapList,"ctrl+r":a.mapRefresh,"ctrl+n":a.mapRebuild,"ctrl+x":a.mapCrop,"ctrl+e":a.mapToggleSettings,"ctrl++":a.mapZoomIn,"ctrl+-":a.mapZoomOut,esc:a.destroyJcrop,"ctrl+z":a.mapUndo,"ctrl+y":a.mapRedo},c={up:a.mapPanUp,down:a.mapPanDown,left:a.mapPanLeft,right:a.mapPanRight};
"false"===a.settings.active&&(delete b["ctrl+s"],delete b["ctrl+l"]);$.each(b,function(a,b){$(document).bind("keydown",a,b)});$("#mapOutput").hover(function(){$.each(c,function(a,b){$(document).bind("keydown",a,b)});$("#mapOutputImage").dblclick(function(b){a.dblclickZoom(this,b)})},function(){$.each(c,function(a,b){$(document).unbind("keydown",b)});$("#mapOutputImage").unbind("dblclick")})};Mappr.hardResetShowMap=function(){this.resetJbbox();this.destroyRedo();this.showMap()};Mappr.bindSettings=
function(){var a=this;$(".layeropt").click(function(){a.hardResetShowMap()});$(".gridopt").click(function(){$("#graticules").prop("checked")||$("#graticules").attr("checked",!0);a.hardResetShowMap()});$("#gridlabel").click(function(){$("#graticules").prop("checked")||$("#graticules").attr("checked",!0);$(this).prop("checked")&&$(this).val("false");a.hardResetShowMap()});$("#projection").change(function(){""!==$(this).val()&&($.cookie("jcrop_coords",null),a.hardResetShowMap())});a.toggleFileFactor();
$(".download-factor").change(function(){a.toggleFileFactor($(this).val())});$(".download-filetype").change(function(){a.toggleFileType(this)})};Mappr.bindSlider=function(){var a=this;$("#border-slider").slider({value:1.25,min:1,max:2,step:0.25,slide:function(b,c){$('input[name="border_thickness"]').val(c.value);a.destroyRedo();a.showMap();a.trackEvent("slider",c.value)}})};Mappr.toggleFileFactor=function(a){var b="",b=$("#bbox_rubberband").val().split(",");a||(a=$('input[name="download-factor"]:checked').val());
b="crop"===this.vars.jCropType?a*(b[2]-b[0])+" X "+a*(b[3]-b[1]):a*$("#mapOutputImage").width()+" X "+a*$("#mapOutputImage").height();$("span","#scale-measure").text(b).parent().show()};Mappr.toggleFileType=function(a){"download-svg"===$(a).attr("id")||"download-pptx"===$(a).attr("id")||"download-docx"===$(a).attr("id")?($.each(["legend","scalebar"],function(){$("#"+this).attr("checked",!1).attr("disabled","disabled")}),$("#border").removeAttr("disabled")):"download-kml"===$(a).attr("id")?$.each(["legend",
"scalebar","border"],function(){$("#"+this).attr("checked",!1).attr("disabled","disabled")}):($.each(["border","legend","scalebar"],function(){$("#"+this).removeAttr("disabled")}),$("#border").removeAttr("disabled"))};Mappr.bindColorPickers=function(){var a=this;$(".colorPicker").ColorPicker({element:$(this),onBeforeShow:function(){var b=$(this).val().split(" ");$(this).ColorPickerSetColor(a.RGBtoHex(b[0],b[1],b[2]))},onHide:function(a){$(a).hide();return!1},onSubmit:function(a,c,d,e){$(e).val(d.r+
" "+d.g+" "+d.b);$(e).ColorPickerHide()}}).bind("keyup",function(){var b=$(this).val().split(" ");$(this).ColorPickerSetColor(a.RGBtoHex(b[0],b[1],b[2]))})};Mappr.bindClearButtons=function(){var a=this;$(".clearLayers, .clearRegions, .clearFreehand").click(function(a){var c=$(this).parent().prev().prev().children();a.preventDefault();$.each([".m-mapTitle","textarea"],function(){$(c).find(this).val("")});$.each(["Shape","Size"],function(){0<$(c).find(".m-map"+this).length&&($(c).find(".m-map"+this)[0].selectedIndex=
3)});$(this).hasClass("clearLayers")?$(c).find(".colorPicker").val("0 0 0"):$(c).find(".colorPicker").val("150 150 150");return!1});$(".clearself").click(function(b){b.preventDefault();a.clearSelf($(this))})};Mappr.bindAutocomplete=function(){var a=this,b="",c=[];$("textarea",".fieldset-regions").bind("keydown",function(a){a.keyCode===$.ui.keyCode.TAB&&$(this).data("autocomplete").menu.active&&a.preventDefault()}).autocomplete({source:function(b,c){$.getJSON("/places/"+a.extractLast(b.term),{},c)},
search:function(){b=a.extractLast(this.value);if(2>b.length)return!1},focus:function(){return!1},select:function(b,e){c=a.split(this.value);c.pop();c.push(e.item.value);c.push("");this.value=c.join(", ");return!1}})};Mappr.split=function(a,b){switch(b){case "[":return a.split(/\]/);default:return a.split(/,\s*/)}};Mappr.extractLast=function(a){return this.split(a).pop()};Mappr.clearSelf=function(a){var b=$(a).parent(),a=$(b).find(".colorPicker");$.each([".m-mapTitle","textarea"],function(){$(b).find(this).val("")});
$.each(["Shape","Size"],function(){0<$(b).find(".m-map"+this).length&&($(b).find(".m-map"+this)[0].selectedIndex=3)});$(b).parent().hasClass("fieldset-points")?a.val("0 0 0"):a.val("150 150 150")};Mappr.destroyJcrop=function(){var a=Mappr.vars;void 0!==a.jzoomAPI&&a.jzoomAPI.destroy();void 0!==a.jcropAPI&&a.jcropAPI.destroy();void 0!==a.jqueryAPI&&a.jqueryAPI.destroy();$("#mapOutputImage").show();$(".jcrop-holder").remove();$("#mapCropMessage").hide();Mappr.toggleFileFactor()};Mappr.resetJbbox=function(){this.vars.jCropType=
"zoom";$.each(["rubberband","query"],function(){$("#bbox_"+this).val("")});this.toggleFileFactor()};Mappr.initJcrop=function(a){var b=this.vars;this.destroyJcrop();this.resetJbbox();b.jCropType="crop";b.jcropAPI=$.Jcrop("#mapOutputImage",{bgColor:"public/images/basemap.png"===$("#mapOutputImage").attr("src")?"grey":"black",bgOpacity:0.5,onChange:this.showCoords,onSelect:this.showCoords,setSelect:a});$("#mapCropMessage").show()};Mappr.initJzoom=function(){var a=this,b=this.vars;a.destroyJcrop();a.resetJbbox();
b.jCropType="zoom";b.jzoomAPI=$.Jcrop("#mapOutputImage",{addClass:"customJzoom",sideHandles:!1,cornerHandles:!1,dragEdges:!1,bgOpacity:1,bgColor:"white",onChange:a.showCoords,onSelect:a.showCoords});$(".jcrop-tracker").mousedown(function(){a.activateJcrop("zoom")})};Mappr.initJquery=function(){var a=this,b=this.vars;a.destroyJcrop();a.resetJbbox();b.jCropType="query";b.jqueryAPI=$.Jcrop("#mapOutputImage",{addClass:"customJzoom",sideHandles:!1,cornerHandles:!1,dragEdges:!1,bgOpacity:1,bgColor:"white",
onChange:a.showCoords,onSelect:a.showCoords});$(".jcrop-tracker").mousedown(function(){a.activateJcrop("query")})};Mappr.activateJcrop=function(a){switch(a){case "zoom":$(document).bind("mouseup",this,this.aZoom);break;case "query":$(document).bind("mouseup",this,this.aQuery)}};Mappr.aZoom=function(a){a=a.data;a.destroyRedo();a.showMap();$(document).unbind("mouseup",a.aZoom)};Mappr.dblclickZoom=function(a,b){var c=0,d=0,d={},d=$(a).offset(),c=b.pageX-d.left,d=b.pageY-d.top;$("#bbox_rubberband").val(c+
","+d+","+c+","+d);this.destroyRedo();this.showMap()};Mappr.aQuery=function(a){var b=a.data,c=0,d=b.vars.fillColor.r+" "+b.vars.fillColor.g+" "+b.vars.fillColor.b,a={bbox:$("#rendered_bbox").val(),bbox_query:$("#bbox_query").val(),projection:$("#projection").val(),projection_map:$("#projection_map").val(),qlayer:$("#stateprovince").prop("checked")?"stateprovinces_polygon":"base",width:$('input[name="width"]').val(),height:$('input[name="height"]').val()};$(document).unbind("mouseup",b.aQuery);b.destroyJcrop();
b.destroyRedo();b.showLoadingMessage($("#mapper-loading-message").text());$.ajax({type:"POST",url:b.settings.baseUrl+"/query/",data:a,success:function(a){if(0<a.length){var f="",g=$(".fieldset-regions").length;for(c=0;c<a.length;c+=1)f+=a[c],c<a.length-1&&(f+=", ");for(c=0;c<g;c+=1)if(""===$('input[name="regions['+c+'][title]"]').val()||""===$('textarea[name="regions['+c+'][data]"]').val()){$('input[name="regions['+c+'][title]"]').val("Selected Region "+(c+1).toString());$('input[name="regions['+
c+'][color]"]').val(d);$('textarea[name="regions['+c+'][data]"]').val(f);c===g-1&&!$('button[data-type="regions"]').is(":disabled")&&b.addAccordionPanel("regions");break}else c===g-1&&(b.addAccordionPanel("regions"),g+=1);$("#fieldSetsRegions").accordion("activate",c-1);b.showMap()}else b.hideLoadingMessage()}})};Mappr.textareaCounter=function(a,b){switch(b){case "get":switch(a){case "coords":return this.vars.newPointCount;case "regions":return this.vars.newRegionCount}break;case "increase":switch(a){case "coords":return this.vars.newPointCount+=
1;case "regions":return this.vars.newRegionCount+=1}break;case "decrease":switch(a){case "coords":return this.vars.newPointCount-=1;case "regions":return this.vars.newRegionCount-=1}}};Mappr.addAccordionPanel=function(a){var b=this,c=b.textareaCounter(a,"get"),d=$(".addmore[data-type='"+a+"']"),e={},f="coords"===a?"0 0 0":"150 150 150",g=0,h=[];d.attr("data-type")===a&&(c<b.vars.maxTextareaCount&&(d.parent().prev().accordion("activate",!1),e=d.parent().prev().children("div:last").clone(),g=parseInt(e.find("h3 a").text().split(" ")[1],
10),c=b.textareaCounter(a,"increase"),e.find("h3 a").text(e.find("h3 a").text().split(" ")[0]+" "+(g+1).toString()),e.find("input.m-mapTitle").attr("name",a+"["+g.toString()+"][title]").val(""),e.find("textarea").attr("name",a+"["+g.toString()+"][data]").removeClass("textarea-processed").val("").each(function(){b.addGrippies(this)}),e.find("select.m-mapShape").attr("name",a+"["+g.toString()+"][shape]").val("circle"),e.find("select.m-mapSize").attr("name",a+"["+g.toString()+"][size]").val("10"),e.find("input.colorPicker").attr("name",
a+"["+g.toString()+"][color]").val(f).ColorPicker({onBeforeShow:function(){var a=$(this).val().split(" ");$(this).ColorPickerSetColor(b.RGBtoHex(a[0],a[1],a[2]))},onHide:function(a){$(a).hide();return!1},onSubmit:function(a,b,c,d){$(d).val(c.r+" "+c.g+" "+c.b);$(d).ColorPickerHide()}}).bind("keyup",function(){var a=$(this).val().split(" ");$(this).ColorPickerSetColor(b.RGBtoHex(a[0],a[1],a[2]))}),h=d.parent().prev().append(e).children("div"),h.each(function(d){d===h.length-1&&$(this).find("button.removemore").show().click(function(d){d.preventDefault();
b.removeAccordionPanel(e,a);c=b.textareaCounter(a,"decrease")}).parent().find("button.clearself").click(function(a){a.preventDefault();b.clearSelf($(this))}).parent().parent().find(".ui-icon:last").remove()}),d.parent().prev().accordion("destroy").accordion({header:"h3",collapsible:!0,autoHeight:!1,active:!1}),"regions"===a&&b.bindAutocomplete()),c>=b.vars.maxTextareaCount-3&&d.attr("disabled","disabled"))};Mappr.removeAccordionPanel=function(a,b){var c=$(".addmore[data-type='"+b+"']");a.nextAll().each(function(){var a=
parseInt($(this).find("h3 a").text().split(" ")[1],10);$(this).find("h3 a").text($(this).find("h3 a").text().split(" ")[0]+" "+(a-1).toString());$(this).find("input.m-mapTitle").attr("name",b+"["+(a-2).toString()+"][title]");$(this).find("textarea").attr("name",b+"["+(a-2).toString()+"][data]");$(this).find("select.m-mapShape").attr("name",b+"["+(a-2).toString()+"][shape]");$(this).find("select.m-mapSize").attr("name",b+"["+(a-2).toString()+"][size]");$(this).find("input.colorPicker").attr("name",
b+"["+(a-2).toString()+"][color]")});a.remove();c.removeAttr("disabled")};Mappr.addGrippies=function(a){function b(a){d.height(Math.max(32,e+a.pageY)+"px");return!1}function c(){$(document).unbind("mousemove",b).unbind("mouseup",c);d.css("opacity",1)}var d=$(a).addClass("textarea-processed"),e=null;$(a).parent().find(".grippie").bind("mousedown",function(a){e=d.height()-a.pageY;d.css("opacity",0.25);$(document).bind("mousemove",b).bind("mouseup",c);return!1})};Mappr.bindAddButtons=function(){var a=
this;$(".addmore").click(function(b){var c=$(this).attr("data-type"),d=0;b.preventDefault();a.addAccordionPanel(c);d=$(this).parent().prev().children().length;$(this).parent().prev().accordion("activate",d-1);return!1})};Mappr.loadMapList=function(a){var b=this,c=a||{},a=$(".usermaps-loading").clone(!0),d={};$("#usermaps").html("").append(a.show());d={locale:b.getParameterByName("locale"),q:c.q?encodeURIComponent(c.q.toLowerCase()):null,uid:c.uid||null};c.sort&&(d.sort=c.sort.item,d.dir=c.sort.dir);
d.locale||delete d.locale;d.q||delete d.q;d.uid||delete d.uid;$.ajax({type:"GET",url:b.settings.baseUrl+"/usermaps/",data:d,dataType:"html",success:function(a){if(a.indexOf("session timeout")!==-1)window.location.reload();else{$("#usermaps").find(".usermaps-loading").remove().end().html(a);$(".toolsRefresh",".grid-usermaps").click(function(a){a.preventDefault();b.loadMapList()});$("#filter-mymaps").val(c.q).keypress(function(a){if(a.which===13){a.preventDefault();d.q=$(this).val();b.loadMapList(d);
b.trackEvent("maplist","filter")}}).focus();$(".ui-icon-triangle-sort",".grid-usermaps").click(function(a){a.preventDefault();d.sort={item:$(this).attr("data-sort"),dir:"asc"};if($(this).hasClass("asc"))d.sort.dir="desc";b.loadMapList(d);b.trackEvent("maplist","sort")});$(".map-load").click(function(a){a.preventDefault();b.loadMap(this);b.trackEvent("map","load")});$(".map-delete").click(function(a){a.preventDefault();b.deleteMapConfirmation(this)})}}})};Mappr.removeExtraElements=function(){var a=
0,a=$(".fieldset-points").size(),b=$(".fieldset-regions").size();if(3<a){for(a-=1;3<=a;a-=1)$("#fieldSetsPoints div.fieldset-points:eq("+a.toString()+")").remove();this.vars.newPointCount=0}if(3<b){for(a=b-1;3<=a;a-=1)$("#fieldSetsRegions div.fieldset-regions:eq("+a.toString()+")").remove();this.vars.newRegionCount=0}};Mappr.prepareInputs=function(a){var b={},c=[],b={status:"ok",mid:$(".map-embed").attr("data-mid"),map:a};b.map.coords=b.map.coords||[];b.map.regions=b.map.regions||[];b.map.layers=
b.map.layers||{};b.map.options=b.map.options||{};String.prototype.clean=function(){return this.replace(/[\[\]]/g,"")};$.each(a,function(a,e){if(-1!==a.indexOf("coords")&&(c=a.match(/\[[A-Za-z0-9]*?\]/g)))void 0===b.map.coords[parseInt(c[0].clean(),10)]&&(b.map.coords[parseInt(c[0].clean(),10)]={}),b.map.coords[parseInt(c[0].clean(),10)][c[1].clean()]=e,delete b.map["coords"+c[0]+c[1]];if(-1!==a.indexOf("regions")&&(c=a.match(/\[[A-Za-z0-9]*?\]/g)))void 0===b.map.regions[parseInt(c[0].clean(),10)]&&
(b.map.regions[parseInt(c[0].clean(),10)]={}),b.map.regions[parseInt(c[0].clean(),10)][c[1].clean()]=e,delete b.map["regions"+c[0]+c[1]];if(-1!==a.indexOf("layers")&&(c=a.match(/\[[A-Za-z0-9]*?\]/g)))b.map.layers[c[0].clean()]=e,delete b.map["layers"+c[0]];if(-1!==a.indexOf("options")&&(c=a.match(/\[[A-Za-z0-9]*?\]/g)))b.map.options[c[0].clean()]=e,delete b.map["options"+c[0]];"save[title]"===a&&(b.map.save={title:e},delete b.map["save[title]"]);"gridspace"===a&&(b.map.grid_space=e);"download-filetype"===
a&&(b.map.download_filetype=e);"download-factor"===a&&(b.map.download_factor=e)});return b};Mappr.loadInputs=function(a){var b=$("#filter-mymaps").val();this.removeExtraElements();$("#form-mapper").clearForm();$.each(["width","height"],function(){$('input[name="'+this+'"]').val($('input[name="'+this+'"]').val())});$("#filter-mymaps").val(b);this.loadCoordinates(a);this.loadRegions(a);this.loadLayers(a);this.loadSettings(a)};Mappr.loadMap=function(a){var b=this,c=$(a).attr("data-mid");b.tabSelector(0);
b.showLoadingMessage($("#mapper-loading-message").text());$.ajax({type:"GET",url:b.settings.baseUrl+"/usermaps/"+c,dataType:"json",success:function(a){b.loadInputs(a);b.showMap(a);b.bindStorage();b.activateEmbed(c);b.toggleUndo();b.toggleRedo()}})};Mappr.loadSettings=function(a){var b="",b="",b=a.map.save.title;$('input[name="save[title]"]').val(b);$(".m-mapSaveTitle").val(b);$("#mapTitle").text(b);b=b.replace(/[?*:;{}\\ "']+/g,"_");$("#file-name").val(b);$("#projection").val(a.map.projection);$.each(["bbox_map",
"projection_map","rotation"],function(){$('input[name="'+this+'"]').val(a.map[this])});$('input[name="border_thickness"]').val(1.25);$("#border-slider").slider({value:1.25});void 0!==a.map.border_thickness&&a.map.border_thickness&&($('input[name="border_thickness"]').val(a.map.border_thickness),$("#border-slider").slider({value:a.map.border_thickness}));this.setRotation(a.map.rotation);this.resetJbbox();$.each(["border","legend","scalebar"],function(){$("#"+this).attr("checked",false);$('input[name="options['+
this+']"]').val("")});void 0!==a.map.options&&$.each(["border","legend","scalebar"],function(){if(a.map.options[this]&&a.map.options[this]!==void 0){$("#"+this).attr("checked",true);$('input[name="options['+this+']"]').val(1)}});void 0!==a.map.download_factor&&a.map.download_factor?($('input[name="download_factor"]').val(a.map.download_factor),$("#download-factor-"+a.map.download_factor).attr("checked",!0)):$("#download-factor-3").attr("checked",!0);void 0!==a.map.download_filetype&&a.map.download_filetype?
($('input[name="download_filetype"]').val(a.map.download_filetype),b=$("#download-"+a.map.download_filetype).attr("checked",!0),this.toggleFileType(b)):$("#download-svg").attr("checked",!0);void 0!==a.map.grid_space&&a.map.grid_space?($('input[name="gridspace"]').attr("checked",!1),$("#gridspace-"+a.map.grid_space).attr("checked",!0)):$("#gridspace").attr("checked",!0);void 0!==a.map.gridlabel&&a.map.gridlabel?$('input[name="gridlabel"]').attr("checked",!0).val("false"):$("#gridlabel").attr("checked",
!1)};Mappr.loadCropSettings=function(a){var b=[];a.map.bbox_rubberband?(b=a.map.bbox_rubberband.split(","),this.initJcrop([b[2],b[3],b[0],b[1]]),this.toggleFileFactor(a.map.download_factor)):this.destroyJcrop()};Mappr.loadShapeSize=function(a,b){$.each(["shape","size"],function(){""===b[a][this].toString()?$('select[name="coords['+a.toString()+"]["+this+']"]')[0].selectedIndex=3:$('select[name="coords['+a.toString()+"]["+this+']"]').val(b[a][this])})};Mappr.loadCoordinates=function(a){for(var b=0,
a=a.map.coords||[],c="",d="",e="",f=/[?*{}\\]+/g,b=0;b<a.length;b+=1)2<b&&this.addAccordionPanel("coords"),c=a[b].title||"",d=a[b].data.replace(f,"")||"",e=a[b].color||"0 0 0",$('input[name="coords['+b.toString()+'][title]"]').val(c),$('textarea[name="coords['+b.toString()+'][data]"]').val(d),this.loadShapeSize(b,a),$('input[name="coords['+b.toString()+'][color]"]').val(e)};Mappr.loadRegions=function(a){for(var b=0,a=a.map.regions||[],c="",d="",e="",b=0;b<a.length;b+=1)2<b&&this.addAccordionPanel("regions"),
c=a[b].title||"",d=a[b].data||"",e=a[b].color||"150 150 150",$('input[name="regions['+b.toString()+'][title]"]').val(c),$('textarea[name="regions['+b.toString()+'][data]"]').val(d),$('input[name="regions['+b.toString()+'][color]"]').val(e)};Mappr.loadLayers=function(a){var b=0,c=[],b=0;if(a.map.layers){for(b in a.map.layers)a.map.layers.hasOwnProperty(b)&&(c[c.length]=b);for(b=0;b<c.length;b+=1)$('input[name="layers['+c[b]+']"]').attr("checked",!0)}};Mappr.activateEmbed=function(a){var b=this,c=["img",
"kml","svg","json"];$(".map-embed").attr("data-mid",a).css("display","block").click(function(d){d.preventDefault();$.each(c,function(){"img"===this.toString()?$("#embed-"+this,"#mapEmbed").val('<img src="'+b.settings.baseUrl+"/map/"+a+'" alt="" />'):$("#embed-"+this,"#mapEmbed").val(b.settings.baseUrl+"/map/"+a+"."+this)});$("#mapEmbed").find("span.mid").text(a).end().dialog({width:(525).toString(),autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",
click:function(){$(this).dialog("destroy")}}]}).show()})};Mappr.deleteMapConfirmation=function(a){var b=this,c=$(a).attr("data-mid"),a="<em>"+$(a).parent().parent().find(".title").text()+"</em>";$("#mapper-message-delete").find("span").html(a).end().dialog({height:(250).toString(),width:(500).toString(),modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:$("#button-titles span.delete").text(),"class":"negative",click:function(){$.ajax({type:"DELETE",url:b.settings.baseUrl+"/usermaps/"+
c,success:function(){b.loadMapList();b.trackEvent("map","delete")}});$(this).dialog("destroy")}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy")}}]}).show()};Mappr.loadUserList=function(a){var b=this,c=$(".userdata-loading").clone(!0),a=a||{},d={locale:this.getParameterByName("locale")};$("#userdata").html("").append(c.show());a.sort&&(d.sort=a.sort.item,d.dir=a.sort.dir);d.locale||delete d.locale;$.ajax({type:"GET",url:b.settings.baseUrl+
"/users/",data:d,dataType:"html",success:function(a){if(a.indexOf("access denied")!==-1)window.location.reload();else{$("#userdata").find(".userdata-loading").remove().end().html(a);$(".toolsRefresh",".grid-users").click(function(a){a.preventDefault();b.loadUserList()});$(".ui-icon-triangle-sort",".grid-users").click(function(a){a.preventDefault();d.sort={item:$(this).attr("data-sort"),dir:"asc"};if($(this).hasClass("asc"))d.sort.dir="desc";b.loadUserList(d)});$(".user-delete").click(function(a){a.preventDefault();
b.deleteUserConfirmation(this)});$(".user-load").click(function(a){a.preventDefault();b.tabSelector(3);b.loadMapList({uid:$(this).attr("data-uid")})})}}})};Mappr.getLanguage=function(){var a="",b=this.getParameterByName("locale");if("fr_FR"===b||"es_ES"===b)a="?locale="+b;return a};Mappr.deleteUserConfirmation=function(a){var b=this,c=$(a).attr("data-uid"),a="<em>"+$(a).parent().parent().children("td:first").text()+"</em>";$("#mapper-message-delete").find("span").html(a).end().dialog({height:(250).toString(),
width:(500).toString(),modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:$("#button-titles span.delete").text(),"class":"negative",click:function(){$.ajax({type:"DELETE",url:b.settings.baseUrl+"/users/"+c,success:function(){b.loadUserList();b.trackEvent("user","delete")}});$(this).dialog("destroy")}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy")}}]}).show()};Mappr.bindSave=function(){var a=this;$(".map-save").click(function(b){b.preventDefault();
a.mapSave()})};Mappr.mapSave=function(){var a=!1,b=/[?*:;{}\\ "'\/@#!%\^()<>.]+/g,c="";$("#mapSave").dialog({autoOpen:!0,height:(175).toString(),width:(350).toString(),modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:$("#button-titles span.save").text(),"class":"positive",click:function(){""===$.trim($(".m-mapSaveTitle").val())&&(a=!0);a?$(".m-mapSaveTitle").addClass("ui-state-error").keyup(function(){$(this).removeClass("ui-state-error")}):($('input[name="save[title]"]').val($(".m-mapSaveTitle").val()),
$.each(["factor","filetype"],function(){$('input[name="download_'+this+'"]').val($('input[name="download-'+this+'"]:checked').val())}),$('input[name="grid_space"]').val($('input[name="gridspace"]:checked').val()),Mappr.setFormOptions(),Mappr.showLoadingMessage($("#mapper-saving-message").text()),void 0===Mappr.vars.jcropAPI&&$("#bbox_rubberband").val(""),$.ajax({type:"POST",url:Mappr.settings.baseUrl+"/usermaps/",data:$("form").serialize(),dataType:"json",success:function(a){$("#mapTitle").text($(".m-mapSaveTitle").val());
c=$(".m-mapSaveTitle").val().replace(b,"_");$("#file-name").val(c);Mappr.activateEmbed(a.mid);Mappr.loadMapList();Mappr.hideLoadingMessage();Mappr.trackEvent("map","save")}}),$(this).dialog("destroy"))}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy")}}]})};Mappr.bindDownload=function(){var a=this;$(".map-download").click(function(b){b.preventDefault();a.mapDownload()})};Mappr.mapDownload=function(){$("#mapExport").dialog({autoOpen:!0,
width:(620).toString(),modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:$("#button-titles span.download").text(),"class":"positive",click:function(){Mappr.generateDownload()}},{text:$("#button-titles span.cancel").text(),"class":"ui-button-cancel",click:function(){$(this).dialog("destroy")}}]})};Mappr.bindSubmit=function(){var a=this,b="",c=!1;$(".submitForm").click(function(d){d.preventDefault();c=!1;$(".m-mapCoord").each(function(){b=$(this).parents(".ui-accordion-content").find(".m-mapTitle").keyup(function(){c=
!1;$(this).removeClass("ui-state-error")});$(this).val()&&""===$(b).val()&&(c=!0,$(b).addClass("ui-state-error"))});c?a.showMessage($("#mapper-missing-legend").text()):(a.destroyRedo(),a.showMap(),a.tabSelector(0))})};Mappr.mapToggleSettings=function(){$("#mapToolsCollapse a").trigger("click")};Mappr.bindPanelToggle=function(){var a=this;$("#mapToolsCollapse a").tipsy({gravity:"e"}).toggle(function(b){b.preventDefault();$("#mapOutputImage").attr("width",0).attr("height",0);$("#mapOutputScale").hide();
$(this).parent().addClass("mapTools-collapsed");$("#mapTools").hide("slide",{direction:"right"},250,function(){var b=0.98*$(window).width();$("#actionsBar").animate({width:b},250);$("#map").animate({width:b},250,function(){$('input[name="width"]').val(b);a.mapRefresh()})})},function(b){b.preventDefault();$("#mapOutputImage").attr("width",0).attr("height",0);$("#mapOutputScale").hide();$(this).parent().removeClass("mapTools-collapsed");$("#mapTools").show("slide",{direction:"right"},250,function(){$("#actionsBar").animate({width:"810px"},
250);$("#map").animate({width:"800px"},function(){$('input[name="width"]').val(800);a.mapRefresh()})})})};Mappr.showMessage=function(a){$("#mapper-message").html(a).dialog({autoOpen:!0,height:(200).toString(),width:(400).toString(),modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy")}}]}).show()};Mappr.drawLegend=function(){var a=$("#legend_url").val();a?$("#mapLegend").html('<img src="'+a+'" />'):$("#mapLegend").html("<p><em>"+
$("#mapper-legend-message").text()+"</em></p>")};Mappr.drawScalebar=function(){$("#mapScale img").attr("src",$("#scalebar_url").val()).show()};Mappr.showBadPoints=function(){var a=$("#bad_points").val();a&&($("#badRecords").html(a),$("#badRecordsWarning").show())};Mappr.showLoadingMessage=function(a){$("#mapOutput").append('<span class="mapper-loading-message ui-corner-all ui-widget-content">'+a+"</span>")};Mappr.hideLoadingMessage=function(){$("#mapOutput .mapper-loading-message").remove()};Mappr.showMap=
function(a){var b=(new Date).getTime(),c="",d={},e=!1;this.destroyJcrop();$("#output").val("pnga");$("#badRecordsWarning").hide();$("#download_token").val(b);c=$("form").serialize();d=$("form").serializeJSON();if(d["layers[relief]"]||d["layers[reliefgrey]"]||7E3<c.length||"epsg:4326"!==d.projection)e=!0;this.postData(c,a,e);$.jStorage.set("do-"+b.toString(),d);this.toggleUndo(!0)};Mappr.postData=function(a,b,c){var d=this;c&&d.showLoadingMessage($("#mapper-loading-message").text());$.ajax({type:"POST",
url:d.settings.baseUrl+"/application/",data:a,dataType:"json",success:function(a){d.resetFormValues(a);d.resetJbbox();d.drawMap(a,b);d.drawLegend();d.drawScalebar();d.showBadPoints();d.addBadRecordsViewer()}})};Mappr.resetFormValues=function(a){$("#mapOutput input").each(function(){$(this).val("")});$.each("rendered_bbox rendered_rotation rendered_projection legend_url scalebar_url bad_points".split(" "),function(){$("#"+this).val(a[this]);this==="rendered_bbox"&&$("#bbox_map").val($("#"+this).val());
this==="rendered_projection"&&$("#projection_map").val($("#"+this).val());this==="rendered_rotation"&&$("#rotation").val($("#"+this).val())});$("#pan").val("")};Mappr.drawMap=function(a,b){var c=this;$("#mapOutputImage").attr("width",a.size[0]).attr("height",a.size[1]).attr("src",a.mapOutputImage).one("load",function(){b||(b={map:{bbox_rubberband:""}});c.loadCropSettings(b);c.hideLoadingMessage()})};Mappr.addBadRecordsViewer=function(){var a=this;$("#badRecordsViewer").dialog({autoOpen:!1,height:(200).toString(),
width:(500).toString(),position:[200,200],modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy")}}]});$(".toolsBadRecords").click(function(b){b.preventDefault();a.addBadRecordsViewer();$("#badRecordsViewer").dialog("open")})};Mappr.generateDownload=function(){var a=this,b=$("#file-name").val(),c=(new Date).getTime().toString(),d="",e="",f="png",b=b.replace(/[~$?*,:;{}\[\]\\ "'\/@#!%\^()<>.+=|`&]+/g,"_");$("#file-name").val(b);
$('input[name="file_name"]').val(b);$('input[name="download_factor"]').val($('input[name="download-factor"]:checked').val());f=$("input[name='download-filetype']:checked").val();a.setFormOptions();$("#download_token").val(c);$.each(["ui-dialog-buttonpane","download-dialog"],function(){$("."+this).hide()});$(".download-message").show();switch(f){case "pptx":$("#output").val("pptx");a.vars.jcropAPI?$("#crop").val(1):a.resetJbbox();e=$("form").serialize();$("body").download("/application/pptx/"+a.getLanguage(),
e,"post");$("#output").val("pnga");break;case "docx":$("#output").val("docx");a.vars.jcropAPI?$("#crop").val(1):a.resetJbbox();e=$("form").serialize();$("body").download("/application/docx/"+a.getLanguage(),e,"post");$("#output").val("pnga");break;case "kml":e=$("form").serialize();$("body").download("/application/kml/",e,"post");break;default:$("#download").val(1),$("#output").val(f),a.vars.jcropAPI?$("#crop").val(1):a.resetJbbox(),e=$("form").serialize(),$("body").download("/application/",e,"post"),
$("#download").val(""),$("#output").val("pnga")}a.vars.fileDownloadTimer=window.setInterval(function(){d=$.cookie("fileDownloadToken");d===c&&a.finishDownload()},1E3);a.trackEvent("download",f)};Mappr.setFormOptions=function(){$.each(["border","legend","scalebar"],function(){$("#"+this).prop("checked")?$('input[name="options['+this+']"]').val(1):$('input[name="options['+this+']"]').val("")})};Mappr.finishDownload=function(){$(".download-message").hide();$.each(["download-dialog","ui-dialog-buttonpane"],
function(){$("."+this).show()});window.clearInterval(this.vars.fileDownloadTimer);$.cookie("fileDownloadToken",null)};Mappr.showExamples=function(){$("#mapper-message-help").html('<img src="public/images/help-data.png" alt="" />').dialog({height:(350).toString(),width:(525).toString(),autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy")}}]}).show()};Mappr.showCodes=function(){var a=this.getParameterByName("locale")?
{locale:this.getParameterByName("locale")}:{};$("#mapper-message-codes").dialog({height:(450).toString(),width:(850).toString(),autoOpen:!0,modal:!0,closeOnEscape:!1,draggable:!0,resizable:!1,buttons:[{text:"OK","class":"positive",click:function(){$(this).dialog("destroy")}}]}).show();0<$("#mapper-message-codes .mapper-loading-message").length&&this.loadCodes($("#mapper-message-codes"),a)};Mappr.loadCodes=function(a,b){var c=this,d="";a.find("tbody tr td").text("\u00a0");a.find("tbody tr td:first").text("\u00a0\u00a0\u00a0").addClass("loading");
$.ajax({type:"GET",url:c.settings.baseUrl+"/places/",data:b,dataType:"html",success:function(e){a.html(e);d=a.find(".filter-countries");d.val("");void 0!==b.filter&&d.val(b.filter);d.keypress(function(e){var g=e.keyCode||e.which;if(13===g||9===g)e.preventDefault(),b.filter=d.val(),c.loadCodes(a,b)});d.blur(function(){b.filter=d.val();c.loadCodes(a,b)})}})};Mappr.performRotation=function(a){$("#rotation").val($(a).attr("data-rotate"));this.resetJbbox();this.destroyRedo();this.showMap();this.trackEvent("rotate",
$(a).attr("data-rotate"))};Mappr.setRotation=function(a){var b=$("#mapControls"),c=$(".thumb",b),d=$(".overview",b).children(),e=0,f=e=0;a||(a=0);a=0>parseFloat(a)?parseFloat(a)+360:parseFloat(a);e=a*(Math.PI/180);$(".overview",b).css("left",-(a/360*d.outerWidth(!0)*d.length)+"px");f=Math.round(28*-Math.cos(e)+(b.outerHeight()/2-c.outerHeight()/2))+"px";e=Math.round(28*Math.sin(e)+(b.outerWidth()/2-c.outerWidth()/2))+"px";$(".thumb",b).css("top",f).css("left",e)};Mappr.getParameterByName=function(a){a=
"[\\?&]"+a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")+"=([^&#]*)";a=RegExp(a).exec(window.location.href);return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))};Mappr.mapCircleSlider=function(){for(var a=0,b="",a=0;360>a;a+=1)0===a%5&&(b+='<li data-rotate="'+a+'"></li>');return b};Mappr.clearStorage=function(){this.destroyRedo();$.jStorage.flush()};Mappr.bindStorage=function(){var a={},b=(new Date).getTime();this.clearStorage();a=$("form").serializeJSON();$.jStorage.set("do-"+b.toString(),
a)};Mappr.bindRotateWheel=function(){var a=this;$(".overlay","#mapControls").css("background-image",'url("public/images/bg-rotatescroll.png")');$(".overview","#mapControls").append(a.mapCircleSlider());$("#mapControls").tinycircleslider({snaptodots:!0,radius:28,callback:function(b){$("#initial-message").is(":hidden")&&a.performRotation(b)}})};Mappr.bindTabs=function(){var a=$("#tabs"),b="";$("#mapTools").tabs({selected:0});a.tabs({cache:!0,load:function(a,b){$(b.tab).data("cache.tabs",""===$(b.panel).html()?
!1:!0)},event:"change"}).find(".ui-state-disabled").each(function(){$(this).removeClass("ui-state-disabled")}).end().show();a.find("ul.navigation a").click(function(){var a={},d=$(this).parent().prevAll().length;a.tabs=d;$.bbq.pushState(a);$.each($("#site-languages a"),function(){b=$(this).attr("href").split("#")[0];$(this).attr("href",b+"#tabs="+d)})});$(window).bind("hashchange",function(){var c=$.bbq.getState("tabs",!0)||0;a.find("ul.navigation a").eq(c).triggerHandler("change");$.each($("#site-languages a"),
function(){b=$(this).attr("href").split("#")[0];$(this).attr("href",b+"#tabs="+c)})});$(window).trigger("hashchange")};Mappr.init=function(){var a=this;this.bindRotateWheel();$("#initial-message").hide();$("#header>div").show();this.bindTabs();$("#mapOutput").append('<img id="mapOutputImage" src="public/images/basemap.png" alt="" width="800" height="400" />').find("span.mapper-loading-message").remove();$("#mapScale").append('<img id="mapOutputScale" src="public/images/basemap-scalebar.png" width="200" height="27" />');
$("a.login","#site-session").click(function(b){b.preventDefault();a.tabSelector(3)});$("a.show-examples").click(function(b){b.preventDefault();a.showExamples()});$("a.show-codes").click(function(b){b.preventDefault();a.showCodes()});$(".fieldSets").accordion({header:"h3",collapsible:!0,autoHeight:!1});$(".tooltip").tipsy({gravity:"s"});this.bindStorage();this.bindHotkeys();this.bindToolbar();this.bindArrows();this.bindSettings();this.bindSlider();this.bindColorPickers();this.bindAddButtons();this.bindClearButtons();
this.bindAutocomplete();this.bindSave();this.bindDownload();this.bindSubmit();this.bindPanelToggle();$(".toolsUndoDisabled").click(!1);$(".toolsRedoDisabled").click(!1);$("textarea.resizable:not(.textarea-processed)").TextAreaResizer();0<$("#usermaps").length&&(this.tabSelector(3),this.loadMapList());0<$("#userdata").length&&(this.tabSelector(4),this.loadUserList());$("input").keypress(function(a){if(a.which===13)return false})};Mappr.init()});
